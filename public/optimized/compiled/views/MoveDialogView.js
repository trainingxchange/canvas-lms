(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,i=function(t,i){function o(){this.constructor=t}for(var n in i)e.call(i,n)&&(t[n]=i[n]);return o.prototype=i.prototype,t.prototype=new o,t.__super__=i.prototype,t};define(["jquery","underscore","compiled/views/DialogFormView","compiled/views/MoveDialogSelect","jst/MoveDialog","jst/EmptyDialogFormWrapper"],function(e,o,n,r,s,l){var p,a;return p=function(n){function p(){return this.onSaveSuccess=t(this.onSaveSuccess,this),this.cleanup=t(this.cleanup,this),a=p.__super__.constructor.apply(this,arguments)}return i(p,n),p.prototype.setViewProperties=!1,p.prototype.className="form-dialog",p.prototype.defaults={width:450,height:340},p.optionProperty("nested"),p.optionProperty("parentCollection"),p.optionProperty("parentLabelText"),p.optionProperty("parentKey"),p.optionProperty("childKey"),p.optionProperty("closeTarget"),p.optionProperty("saveURL"),p.prototype.events=o.extend({},p.prototype.events,{"click .dialog_closer":"close","change .move_select_parent_collection":"updateListView"}),p.prototype.els={".child_container":"$childContainer",".form-dialog-content":"$content"},p.prototype.template=s,p.prototype.wrapperTemplate=l,p.prototype.openAgain=function(){return p.__super__.openAgain.apply(this,arguments),this.initChildViews(),this.dialog.option("close",this.cleanup)},p.prototype.initChildViews=function(){return this.listView=this.parentListView=null,this.nested&&this.parentCollection?(this.listView=new r({model:this.model,excludeModel:!0,lastList:!0}),this.parentListView=new r({collection:this.parentCollection,model:this.model,labelText:this.parentLabelText})):this.listView=new r({model:this.model,excludeModel:!0,lastList:!0}),this.attachChildViews()},p.prototype.attachChildViews=function(){var t;return t=this.$childContainer.detach(),this.parentListView&&t.append(this.parentListView.render().el),t.append(this.listView.render().el),this.$content.append(t)},p.prototype.cleanup=function(){var t,e,i;return null!=(t=this.parentListView)&&t.remove(),null!=(e=this.listView)&&e.remove(),this.parentListView=this.listView=null,this.dialog.option("close",null),null!=(i=this.closeTarget)?i.focus():void 0},p.prototype.updateListView=function(t){var i,o,n;if(this.nested)return n=e(t.currentTarget).val(),o=this.parentCollection.get(n),i=o.get(this.childKey),this.listView.setCollection(i)},p.prototype.toJSON=function(){var t,e;return t=("function"==typeof(e=this.model).toView?e.toView():void 0)||p.__super__.toJSON.apply(this,arguments)},p.prototype.getFormData=function(){var t,e,i;return t=this.listView.$("select"),e=t.val(),i=[],o.each(t.find("option"),function(t){var e;return e=t.value,"last"!==e?i.push(e):void 0}),"last"===e?i.push(this.model.id):i.splice(o.indexOf(i,e),0,this.model.id),i},p.prototype.saveFormData=function(t){var i;return i="function"==typeof this.saveURL?this.saveURL.call(this):this.saveURL,e.post(i,{order:t.join(",")})},p.prototype.onSaveSuccess=function(t){var e,i,n,r,s,l;return e=null!=(r=this.parentListView)?r.value():void 0,i=null!=(s=this.parentCollection)?s.get(e).get(this.childKey):void 0,i&&i!==this.model.collection?(this.model.collection.remove(this.model),i.add(this.model),this.parentKey&&this.model.set(this.parentKey,e)):i=this.model.collection,n=function(){l=[];for(var t=1,e=i.length;e>=1?e>=t:t>=e;e>=1?t++:t--)l.push(t);return l}.apply(this),o.each(t.order,function(t,e){var o;return null!=(o=i.get(t))?o.set("position",n[e]):void 0}),i.sort(),i.reset(i.models),p.__super__.onSaveSuccess.apply(this,arguments)},p}(n)})}).call(this);