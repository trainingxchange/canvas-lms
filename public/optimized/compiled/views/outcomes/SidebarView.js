(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,i=function(e,i){function r(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return r.prototype=i.prototype,e.prototype=new r,e.__super__=i.prototype,e};define(["i18n!outcomes","jquery","underscore","Backbone","compiled/models/Outcome","compiled/models/OutcomeGroup","compiled/views/outcomes/OutcomesDirectoryView","compiled/views/outcomes/FindDirectoryView"],function(t,r,o,s,c,n,d,h){var l,u,a;return u=void 0,l=function(s){function l(){return this.findDialog=e(this.findDialog,this),this.renderDir=e(this.renderDir,this),this.goBack=e(this.goBack,this),this.clearOutcomeSelection=e(this.clearOutcomeSelection,this),this.refreshSelection=e(this.refreshSelection,this),this.selectDir=e(this.selectDir,this),this.addAndSelect=e(this.addAndSelect,this),a=l.__super__.constructor.apply(this,arguments)}return i(l,s),l.prototype.directoryWidth=200,l.prototype.entryHeight=30,l.prototype.events={"click .outcome-level":"clickOutcomeLevel"},l.prototype.initialize=function(e){return l.__super__.initialize.apply(this,arguments),this.readOnly=e.readOnly,this.selectFirstItem=e.selectFirstItem,this.directories=[],this.cachedDirectories={},this.$sidebar=this.$el.parent(),this.$sidebar.width(this.directoryWidth),(this.rootOutcomeGroup=e.rootOutcomeGroup)?this.addDirFor(this.rootOutcomeGroup):this.addDir(e.directoryView),this.render()},l.prototype.clickOutcomeLevel=function(e){var t,i;return(t=e.target===e.currentTarget)?(i=r(e.target).data("view"),this.selectDir(i)):void 0},l.prototype.addDirFor=function(e){var t,i,r;return this.cachedDirectories[e.id]?t=this.cachedDirectories[e.id]:(r=o.last(this.directories),i=e.get("directoryClass")||d,t=new i({outcomeGroup:e,parent:r,readOnly:this.readOnly,selectFirstItem:this.selectFirstItem}),this.firstDir=!1),this.addDir(t)},l.prototype.addDir=function(e){return e.outcomeGroup&&(this.cachedDirectories[e.outcomeGroup.id]=e),e.off("select"),e.on("select",this.selectDir),e.sidebar=this,e.clearSelection(),this.directories.push(e),this.updateSidebarWidth(),this.renderDir(e),e},l.prototype.addAndSelect=function(e){var t;return e instanceof c?e.outcomeGroup=this.selectedGroup().toJSON():e.set("parent_outcome_group",this.selectedGroup().toJSON()),t=this._findLastDir(function(e){return!e.selectedModel||e.selectedModel instanceof c}),e instanceof c?t.outcomes.add(e):t.groups.add(e),this._scrollToDir(o.indexOf(this.directories,t),e),e.trigger("select")},l.prototype.selectDir=function(e,t){var i,r,s,c,d,h,l;if(!t||e!==this.selectedDir()||t!==(null!=(l=this.selectedDir())?l.prevSelectedModel:void 0))return d=e?e:this.directories[0],d&&!t&&d.clearSelection(),r=o.indexOf(this.directories,d),i=this.directories.splice(r+1,this.directories.length-(r+1)),o.each(i,function(e){return e.remove()}),s=t instanceof n&&!t.isNew(),s&&this.addDirFor(t),this.updateSidebarWidth(),c=s?r+1:r,this._scrollToDir(c,t),h=t,this.goingBack&&(h=d.parent?d.outcomeGroup:null),this.trigger("select",h,this.directories)},l.prototype.refreshSelection=function(e){var t;return t=this.selectedDir(),e===t.selectedModel?(t.clearSelection(),e.trigger("select")):void 0},l.prototype.selectedDir=function(){return this._findLastDir(function(e){return e.selectedModel})},l.prototype.selectedModel=function(){var e;return null!=(e=this.selectedDir())?e.selectedModel:void 0},l.prototype.selectedGroup=function(){var e;return e=null,this._findLastDir(function(t){return t.selectedModel instanceof n?e=t.selectedModel:void 0}),e||this.rootOutcomeGroup},l.prototype.clearOutcomeSelection=function(){return o.last(this.directories).clearOutcomeSelection()},l.prototype.goBack=function(){var e;return this.goingBack=!0,this.selectedModel()instanceof n?this.selectDir(this.selectedDir()):(e=o.indexOf(this.directories,this.selectedDir()),this.selectDir(this.directories[e-1])),this.goingBack=!1},l.prototype.updateSidebarWidth=function(){var e;return e=1===this.directories.length?this.directoryWidth+1:2*this.directoryWidth+2,this.$el.css({width:this.directoryWidth*this.directories.length+this.directories.length}),this.$sidebar.animate({width:e})},l.prototype.renderDir=function(e){return this.$el.append(e.render().el)},l.prototype.render=function(){return this.$el.empty(),o.each(this.directories,this.renderDir),this},l.prototype.findDialog=function(e){return u||(u=new e({title:t.t("titles.find_outcomes","Find Outcomes"),selectedGroup:this.selectedGroup(),directoryView:new h({outcomeGroup:this.selectedGroup()})}),u.on("import",this.addAndSelect,this)),u.show()},l.prototype.dirForGroup=function(e){return o.find(this.directories,function(t){return t.outcomeGroup===e})||this.addDirFor(e)},l.prototype._scrollToDir=function(e,t){var i,r;return i=(this.directoryWidth+1)*(t instanceof c?e-1:e),this.$sidebar.animate({scrollLeft:i},{duration:200}),r=(this.entryHeight+1)*o.indexOf(this.directories[e].views(),o.find(this.directories[e].views(),function(e){return e.model===t})),this.directories[e].$el.animate({scrollTop:r},{duration:200})},l.prototype._findLastDir=function(e){return o.find(o.clone(this.directories).reverse(),e)||o.last(this.directories)},l}(s.View)})}).call(this);