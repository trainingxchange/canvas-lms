(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,o=function(e,o){function r(){this.constructor=e}for(var i in o)t.call(o,i)&&(e[i]=o[i]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e};define(["i18n!outcomes","jquery","underscore","compiled/views/PaginatedView","compiled/models/OutcomeGroup","compiled/collections/OutcomeCollection","compiled/collections/OutcomeGroupCollection","compiled/views/outcomes/OutcomeGroupIconView","compiled/views/outcomes/OutcomeIconView","jquery.disableWhileLoading","jqueryui/droppable","compiled/jquery.rails_flash_notifications"],function(t,r,i,s,n,u,l,c,a){var h,p;return h=function(s){function h(){return this.render=e(this.render,this),this.reset=e(this.reset,this),this.triggerSelect=e(this.triggerSelect,this),this.selectFirstOutcome=e(this.selectFirstOutcome,this),this.focusFirstOutcome=e(this.focusFirstOutcome,this),this.moveModelHere=e(this.moveModelHere,this),p=h.__super__.constructor.apply(this,arguments)}return o(h,s),h.prototype.tagName="ul",h.prototype.className="outcome-level",h.prototype.initialize=function(e){var t;return this.readOnly=e.readOnly,this.parent=e.parent,(this.outcomeGroup=e.outcomeGroup)&&(this.groups||(this.groups=new l,this.groups.url=this.outcomeGroup.get("subgroups_url")),this.groups.on("add reset",this.reset,this),this.groups.on("remove",this.removeGroup,this),this.groups.on("fetched:last",this.fetchOutcomes,this),this.outcomes||(this.outcomes=new u,this.outcomes.url=this.outcomeGroup.get("outcomes_url")),this.outcomes.on("add remove reset",this.reset,this)),this.collection=this.groups,this.paginationScrollContainer=this.$el,h.__super__.initialize.call(this,e),this.loadDfd=r.Deferred(),this.outcomeGroup&&(this.$el.disableWhileLoading(t=this.groups.fetch()),t.done(this.focusFirstOutcome)),e.selectFirstItem?this.loadDfd.done(this.selectFirstOutcome):void 0},h.prototype.initDroppable=function(){var e=this;return this.$el.droppable({scope:"outcomes",hoverClass:"outcome-level-hover",drop:function(t,o){var r;if(o.draggable.parent().get(0)!==t.target)return r=o.draggable.data("view").model,e.moveModelHere(r)}})},h.prototype.promise=function(){return this.loadDfd.promise()},h.prototype.moveModelHere=function(e){var t;return e.collection.remove(e),e instanceof n?(this.groups.add(e),t=this.moveGroup(e,this.outcomeGroup.toJSON())):(this.outcomes.add(e),t=this.changeLink(e,this.outcomeGroup.toJSON())),t.done(function(){return e.trigger("select")})},h.prototype.changeLink=function(e,o){var i,s,n;return i=new r.Deferred,this.$el.disableWhileLoading(i),s=function(){return i.reject(),r.flashError(t.t("flash.error","An error occurred. Please refresh the page and try again."))},e.setUrlTo("delete"),n=e.url,e.outcomeGroup=o,e.setUrlTo("add"),r.ajaxJSON(e.url,"POST",{outcome_id:e.get("id")}).done(function(o){return e.set(e.parse(o)),r.ajaxJSON(n,"DELETE").done(function(){return r.flashMessage(t.t("flash.updateSuccess","Update successful")),i.resolve()}).fail(s)}).fail(s),i},h.prototype.moveGroup=function(e,o){var i,s;return i=new r.Deferred,s=function(){return i.reject(),r.flashError(t.t("flash.error","An error occurred. Please refresh the page and try again."))},e.setUrlTo("edit"),r.ajaxJSON(e.url,"PUT",{parent_outcome_group_id:o.id}).done(function(o){return e.set(e.parse(o)),r.flashMessage(t.t("flash.updateSuccess","Update successful")),i.resolve()}).fail(s),this.$el.disableWhileLoading(i),i},h.prototype.focusFirstOutcome=function(){var e;return e=this.$el.find("[tabindex=0]"),e.length>0?e.focus():this.$el.prev().find("[tabindex=0]").focus()},h.prototype.selectFirstOutcome=function(){return r("ul.outcome-level li:first").click()},h.prototype.paginationLoaderTemplate=function(){return"<li><a href='#' class='loading-more'>        "+t.t("loading_more_results","Loading more results")+"</a></li>"},h.prototype.showPaginationLoader=function(){var e;return this.$el.append(null!=(e=this.$paginationLoader)?e:this.$paginationLoader=r(this.paginationLoaderTemplate()))},h.prototype.fetchOutcomes=function(){var e=this;return this.collection=this.outcomes,this.bindPaginationEvents(),this.outcomes.fetch({success:function(){return e.loadDfd.resolve(e)}}),this.showPaginationLoader()},h.prototype.triggerSelect=function(e){return this.clearSelection(),this.selectedModel=e.model,e.select(),this.trigger("select",this,e.model)},h.prototype.views=function(){var e,t,o,r;if(this._views&&!i.isEmpty(this._views))return this._views;for(this._views=this._viewsFor(this.groups.models,c).concat(this._viewsFor(this.outcomes.models,a)),r=this._views,t=0,o=r.length;o>t;t++)e=r[t],e.on("select",this.triggerSelect),e.model===this.selectedModel&&e.select();return this._views},h.prototype.reset=function(){return this._clearViews(),this.render()},h.prototype.removeGroup=function(e){var t;return this.reset(),e===(null!=(t=i.last(this.sidebar.directories))?t.outcomeGroup:void 0)?this.trigger("select",this,null):void 0},h.prototype.remove=function(){return this._clearViews(),this.selectedModel=null,h.__super__.remove.apply(this,arguments)},h.prototype.clearSelection=function(e){return null!=e&&e.preventDefault(),this.prevSelectedModel=this.selectedModel,this.selectedModel=null,i.each(this.views(),function(e){return e.unSelect()})},h.prototype.clearOutcomeSelection=function(){return this.selectedModel instanceof Outcome?this.clearSelection():void 0},h.prototype.render=function(){var e=this;return this.$el.empty(),i.each(this.views(),function(t){return e.$el.append(t.render().el)}),this.readOnly||this.initDroppable(),this.$("li:first").attr("tabindex",0),this.$el.data("view",this),this},h.prototype._viewsFor=function(e,t){var o=this;return i.map(e,function(e){return new t({model:e,readOnly:o.readOnly,dir:o})})},h.prototype._clearViews=function(){return i.each(this._views,function(e){return e.remove()}),this._views=null},h}(s)})}).call(this);