(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,r=function(e,r){function i(){this.constructor=e}for(var o in r)t.call(r,o)&&(e[o]=r[o]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};define(["Backbone","i18n!external_tools","jquery","underscore","jst/ExternalTools/AddAppView","jquery.disableWhileLoading"],function(t,i,o,n,s){var a,p;return a=function(t){function a(){return this.onSaveSuccess=e(this.onSaveSuccess,this),this.onSaveFail=e(this.onSaveFail,this),this.toJSON=e(this.toJSON,this),p=a.__super__.constructor.apply(this,arguments)}return r(a,t),a.prototype.template=s,a.prototype.tagName="form",a.prototype.id="add_app_form",a.prototype.className="validated-form-view form-horizontal bootstrap-form",a.prototype.initialize=function(){return a.__super__.initialize.apply(this,arguments),this.app=this.options.app,this.model.set("name",this.app.get("name")),this.model.set("config_url",this.app.get("config_xml_url")),this.model.set("description",this.app.get("description")),this.model.set("config_type","by_url"),this.model.on("error",this.onSaveFail,this),this.model.on("sync",this.onSaveSuccess,this),this.configOptions=this.app.get("config_options")||[],this.app.get("requires_secret")?this.configOptions=this.keySecretConfigOptions().concat(this.configOptions):(this.model.set("consumer_key","N/A"),this.model.set("shared_secret","N/A"))},a.prototype.afterRender=function(){var e=this;return this.$el.dialog({title:i.t("dialog_title_add_app","Add App"),width:520,height:"auto",resizable:!0,close:function(){return e.$el.remove()},buttons:[{"class":"btn-primary",text:i.t("submit","Submit"),"data-text-while-loading":i.t("saving","Saving..."),click:function(){return e.submit()}}]}),this.$el.submit(function(){return e.submit(),!1}),0!==this.configOptions.length||this.app.get("is_installed")||this.submit(),this},a.prototype.toJSON=function(){var e;return e=a.__super__.toJSON.apply(this,arguments),e.requiresSecret=this.app.get("requires_secret"),e.configOptions=[],n.each(this.configOptions,function(t){return"checkbox"===t.param_type&&(t.isCheckbox=!0),"text"===t.param_type&&(t.isText=!0),e.configOptions.push(t)}),e},a.prototype.submit=function(){var e,t;return t=this.$el.getFormData(),this.validate(t)?(t.canvas_app_name&&this.model.set("name",t.canvas_app_name),t.consumer_key&&this.model.set("consumer_key",t.consumer_key),t.shared_secret&&this.model.set("shared_secret",t.shared_secret),this.updateConfigUrl(t),e=new o.Deferred,this.model.save({error:function(){return e.reject()},success:function(){return e.resolve()}}),this.$el.disableWhileLoading(e)):void 0},a.prototype.updateConfigUrl=function(e){var t,r,i,n,s,a,p;for(t=this.model.get("config_url"),n={},p=this.configOptions,s=0,a=p.length;a>s;s++)i=p[s],e[i.name]&&(n[i.name]=e[i.name]);return delete n.consumer_key,delete n.shared_secret,r=this.model.get("config_url")+(-1!==t.indexOf("?")?"&":"?")+o.param(n),this.model.set("config_url",r)},a.prototype.validate=function(e){var t,r,i,o,n;for(this.removeErrors(),r=function(){var t,r,o,n;for(o=this.configOptions,n=[],t=0,r=o.length;r>t;t++)i=o[t],!e[i.name]&&i.is_required&&n.push(i);return n}.call(this),o=0,n=r.length;n>o;o++)t=r[o],this.addError("input[name='"+t.name+"']","Required");return 0===r.length},a.prototype.removeErrors=function(){return this.$(".error .help-inline").remove(),this.$(".control-group").removeClass("error"),this.$(".alert.alert-error").remove()},a.prototype.addError=function(e,t){return e=this.$(e),e.parents(".control-group").addClass("error"),e.after("<span class='help-inline'>"+t+"</span>"),e.one("keypress",function(){return o(this).parents(".control-group").removeClass("error"),o(this).parents(".control-group").find(".help-inline").remove()})},a.prototype.onSaveFail=function(){var e;return e=i.t("generic_error","There was an error in processing your request"),this.$el.prepend("<div class='alert alert-error'>"+e+"</span>")},a.prototype.onSaveSuccess=function(e){return this.app.set("is_installed",!0),e.off("sync",this.onSaveSuccess)},a.prototype.keySecretConfigOptions=function(){return[{param_type:"text",name:"consumer_key",description:i.t("consumer_key","Consumer Key"),is_required:!0},{param_type:"text",name:"shared_secret",description:i.t("shared_secret","Shared Secret"),is_required:!0}]},a}(t.View)})}).call(this);