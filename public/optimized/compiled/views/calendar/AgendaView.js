(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,n){function o(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return o.prototype=n.prototype,t.prototype=new o,t.__super__=n.prototype,t};define(["i18n!calendar","jquery","underscore","Backbone","compiled/collections/CalendarEventCollection","compiled/calendar/ShowEventDetailsDialog","jst/calendar/agendaView","vendor/jquery.ba-tinypubsub"],function(e,o,r,i,s,a,h){var c;return c=function(i){function s(){this.eventBoxToHash=t(this.eventBoxToHash,this),this.formattedLongDayString=t(this.formattedLongDayString,this),this.formattedDayString=t(this.formattedDayString,this),this.render=t(this.render,this),this.loadMoreFinished=t(this.loadMoreFinished,this),this.appendEvents=t(this.appendEvents,this),this.handleEvents=t(this.handleEvents,this),this.refetch=t(this.refetch,this),s.__super__.constructor.apply(this,arguments),this.dataSource=this.options.dataSource,o.subscribe({"CommonEvent/eventDeleted":this.refetch,"CommonEvent/eventSaved":this.refetch})}return n(s,i),s.prototype.PER_PAGE=50,s.prototype.template=h,s.prototype.els={".agenda-actions .loading-spinner":"$spinner"},s.prototype.events={"click .agenda-load-btn":"loadMore","click .ig-row":"manageEvent","keyclick .ig-row":"manageEvent"},s.prototype.messages={loading_more_items:e.t("loading_more_items","Loading more items.")},s.optionProperty("calendar"),s.prototype.fetch=function(t,e){return null==e&&(e=new Date),this.$el.empty(),this.$el.addClass("active"),this.contexts=t,e.setHours(0),e.setMinutes(0),e.setSeconds(0),this.startDate=e,this._fetch(e,this.handleEvents)},s.prototype._fetch=function(t,e){var n;return n=new Date(3e3,1,1),this.lastRequestID=o.guid++,this.dataSource.getEvents(t,n,this.contexts,e,{singlePage:!0,requestID:this.lastRequestID})},s.prototype.refetch=function(){return this.startDate?(this.collection=[],this._fetch(this.startDate,this.handleEvents)):void 0},s.prototype.handleEvents=function(t){return t.requestID===this.lastRequestID?(this.collection=[],this.appendEvents(t)):void 0},s.prototype.appendEvents=function(t){return this.nextPageDate=t.nextPageDate,this.collection.push.apply(this.collection,t),this.collection=r.sortBy(this.collection,"originalStart"),this.render()},s.prototype.loadMore=function(t){return t.preventDefault(),this.$spinner.show(),this._fetch(this.nextPageDate,this.loadMoreFinished),o.screenReaderFlashMessage(this.messages.loading_more_items)},s.prototype.loadMoreFinished=function(t){return this.appendEvents(t),this.focusFirstNewDate(t)},s.prototype.focusFirstNewDate=function(t){var e,n,o,i;return i=r.min(t,function(t){return t.start}),e=this.$("li[data-event-id='"+i.id+"']"),n=e.closest(".agenda-day"),o=n.find(".agenda-date"),o.length?o[0].focus():void 0},s.prototype.manageEvent=function(t){var e,n;return n=o(t.target).closest(".agenda-event").data("event-id"),e=this.dataSource.eventWithId(n),new a(e,this.dataSource).show(t)},s.prototype.render=function(){var t;return s.__super__.render.apply(this,arguments),this.$spinner.hide(),o.publish("Calendar/colorizeContexts"),(t=r.last(this.collection))?this.trigger("agendaDateRange",this.startDate,t.originalStart):void 0},s.prototype.sortedBoxBy=function(t,e){return r.reduce(t,function(t,n){var o,i;return r.isEmpty(t)?[[n]]:(o=r.last(t),i=r.last(o),e(n)===e(i)?o.push(n):t.push([n]),t)},[])},s.prototype.formattedDayString=function(t){return e.l("#date.formats.short_with_weekday",t.originalStart)},s.prototype.formattedLongDayString=function(t){return e.l("#date.formats.long_with_weekday",t.originalStart)},s.prototype.eventBoxToHash=function(t){var e,n,i,s;return i=o.fudgeDateForProfileTimezone(new Date),e=r.first(t),s=e.originalStart,n=i.getDate()===s.getDate()&&i.getMonth()===s.getMonth()&&i.getFullYear()===s.getFullYear(),{date:this.formattedDayString(e),accessibleDate:this.formattedLongDayString(e),isToday:n,events:t}},s.prototype.formatResult=function(t){return{days:r.map(t,this.eventBoxToHash),meta:{hasMore:!!this.nextPageDate}}},s.prototype.toJSON=function(){var t;return t=this.sortedBoxBy(this.collection,this.formattedDayString),this.formatResult(t)},s}(i.View)})}).call(this);