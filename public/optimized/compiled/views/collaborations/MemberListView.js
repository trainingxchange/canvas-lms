(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function o(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return o.prototype=r.prototype,t.prototype=new o,t.__super__=r.prototype,t};define(["jquery","underscore","Backbone","compiled/models/Group","compiled/models/User","compiled/collections/CollaboratorCollection","jst/collaborations/collaborator"],function(e,o,n,i,s,l,c){var u,h,a,p,d,m;return a=o.extend,p=o.filter,d=o.map,h=n.View,u=function(o){function n(){return this.onFetch=t(this.onFetch,this),this.publishCollection=t(this.publishCollection,this),this.deselectCollaborator=t(this.deselectCollaborator,this),this.render=t(this.render,this),m=n.__super__.constructor.apply(this,arguments)}return r(n,o),n.prototype.events={"click li a":"removeCollaborator","click .remove-all":"removeAll"},n.prototype.initialize=function(){return n.__super__.initialize.apply(this,arguments),this.collection=this.createCollection(),this.cacheElements(),this.attachEvents()},n.prototype.createCollection=function(){return new l},n.prototype.cacheElements=function(){return this.$list=this.$el.find("ul"),this.$removeBtn=this.$el.find(".remove-button"),this.$instructions=this.$el.find(".member-instructions")},n.prototype.attachEvents=function(){return this.collection.on("add remove reset",this.render).on("reset",this.onFetch).on("remove",this.deselectCollaborator)},n.prototype.render=function(){var t;return this.options.currentUser&&this.removeCurrentUser(),this.updateElementVisibility(),t=this.collection.map(function(t){return c(a(t.toJSON(),{type:t.modelType||t.get("type"),id:t.get("collaborator_id")||t.get("id"),name:t.get("sortable_name")||t.get("name"),selected:!0}))}),this.$list.html(t.join("")),null!=this.currentIndex&&this.hasFocus&&this.updateFocus(),this.hasFocus=!1},n.prototype.updateFocus=function(){var t;return t=e(this.$el.find("li").get(this.currentIndex)).find("a"),0===t.length&&(t=e(this.$el.find("li").get(this.currentIndex-1)).find("a")),0===t.length&&(t=this.$el.parents(".collaborator-picker").find(".list-wrapper:first ul:visible")),t.focus()},n.prototype.removeCollaborator=function(t){var r;return t.preventDefault(),r=e(t.currentTarget).data("id"),this.currentIndex=e(t.target).parent().index(),this.hasFocus=!0,this.collection.remove(r)},n.prototype.removeAll=function(t){return t.preventDefault(),this.collection.remove(this.collection.models)},n.prototype.updateElementVisibility=function(){return 0===this.collection.length?(this.$removeBtn.hide(),this.$instructions.show()):(this.$removeBtn.show(),this.$instructions.hide())},n.prototype.deselectCollaborator=function(t){return null==t.modelType&&(t=this.typecastMember(t)),this.trigger("collection:remove",t)},n.prototype.typecastMember=function(t){var e;return e=a(t.toJSON(),{id:t.get("collaborator_id")}),"user"===t.get("type")?new s(a(e,{sortable_name:e.name})):new i(e)},n.prototype.publishCollection=function(t){var e,r;return r=t.filter(function(t){return"user"===t.get("type")}),e=t.filter(function(t){return"group"===t.get("type")}),this.trigger("collection:reset","user",d(r,this.typecastMember)),this.trigger("collection:reset","group",d(e,this.typecastMember))},n.prototype.onFetch=function(){var t;return this.publishCollection(this.collection),t=this.getNextPage(this.currentXHR.getResponseHeader("Link")),t?(this.collection.url=t,this.currentXHR=this.collection.fetch({add:!0}),e.when(this.currentXHR).then(this.onFetch)):void 0},n.prototype.getNextPage=function(t){var e;return e=p(t.split(","),function(t){return t.match(/next/)})[0],e?e.match(/http[^>]+/)[0]:!1},n.prototype.removeCurrentUser=function(){return this.collection.remove(this.options.currentUser,{silent:!0})},n}(h)})}).call(this);