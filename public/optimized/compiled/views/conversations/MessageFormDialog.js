(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,i=function(t,i){function n(){this.constructor=t}for(var s in i)e.call(i,s)&&(t[s]=i[s]);return n.prototype=i.prototype,t.prototype=new n,t.__super__=i.prototype,t},n=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};define(["i18n!conversation_dialog","jquery","underscore","Backbone","compiled/views/DialogBaseView","jst/conversations/MessageFormDialog","compiled/fn/preventDefault","jst/conversations/composeTitleBar","jst/conversations/composeButtonBar","jst/conversations/addAttachment","compiled/models/Message","compiled/views/conversations/AutocompleteView","compiled/views/conversations/CourseSelectionView","compiled/views/conversations/ContextMessagesView","vendor/jquery.elastic"],function(e,s,o,a,r,c,h,l,u,d,m,p,f,g){var v,y,_;return v=a.Collection,y=function(a){function r(){return this.focusNextAttachment=t(this.focusNextAttachment,this),this.focusPrevAttachment=t(this.focusPrevAttachment,this),this.removeAttachment=t(this.removeAttachment,this),this.handleAttachmentKeyDown=t(this.handleAttachmentKeyDown,this),this.handleAttachment=t(this.handleAttachment,this),this.handleAttachmentDblClick=t(this.handleAttachmentDblClick,this),this.handleAttachmentClick=t(this.handleAttachmentClick,this),this.handleBodyClick=t(this.handleBodyClick,this),this.resizeBody=t(this.resizeBody,this),this.canAddNotesFor=t(this.canAddNotesFor,this),this.recipientIdsChanged=t(this.recipientIdsChanged,this),this.onCourse=t(this.onCourse,this),_=r.__super__.constructor.apply(this,arguments)}return i(r,a),r.prototype.template=c,r.prototype.els={".message_course":"$messageCourse",".message_course_ro":"$messageCourseRO","input[name=context_code]":"$contextCode",".message_subject":"$messageSubject",".message_subject_ro":"$messageSubjectRO",".context_messages":"$contextMessages",".media_comment":"$mediaComment","input[name=media_comment_id]":"$mediaCommentId","input[name=media_comment_type]":"$mediaCommentType",".ac":"$recipients",".attachment_list":"$attachments",".attachments-pane":"$attachmentsPane",".message-body":"$messageBody",".conversation_body":"$conversationBody",".compose_form":"$form",".user_note":"$userNote",".user_note_info":"$userNoteInfo"},r.prototype.messages={flashSuccess:e.t("message_sent","Message sent!")},r.prototype.dialogOptions=function(){var t=this;return{id:"compose-new-message",autoOpen:!1,minWidth:550,width:700,minHeight:500,height:550,resizable:!0,close:function(){return t.afterClose()},resize:function(){return t.resizeBody(),t._limitContentSize()},buttons:[{text:e.t("#buttons.cancel","Cancel"),click:this.cancel},{text:e.t("#buttons.send","Send"),"class":"btn-primary send-message","data-track-category":"Compose Message","data-track-action":"Edit","data-track-label":"Send",click:function(e){return t.sendMessage(e)}}]}},r.prototype.show=function(t,e){return(this.model=t)&&(this.message=(null!=e?e.message:void 0)||this.model.messageCollection.at(0)),this.to=null!=e?e.to:void 0,e.trigger&&(this.returnFocusTo=e.trigger),e.remoteLaunch&&(this.launchParams=o.pick(e,"context","user")),this.render(),r.__super__.show.apply(this,arguments),this.initializeForm(),this.resizeBody()},r.prototype._limitContentSize=function(){return this.$el.width()>this.$fullDialog.width()?this.$el.width("100%"):void 0},r.prototype.afterClose=function(){return this.$fullDialog.off("click",".message-body"),this.$fullDialog.off("click",".attach-file"),this.$fullDialog.off("click",".attachment .remove_link"),this.$fullDialog.off("keydown",".attachment"),this.$fullDialog.off("click",".attachment"),this.$fullDialog.off("dblclick",".attachment"),this.$fullDialog.off("change",".file_input"),this.$fullDialog.off("click",".attach-media"),this.$fullDialog.off("click",".media-comment .remove_link"),this.trigger("close"),this.returnFocusTo?(this.returnFocusTo.focus(),delete this.returnFocusTo):void 0},r.prototype.sendMessage=function(t){return t.preventDefault(),t.stopPropagation(),this.removeEmptyAttachments(),this.$form.submit()},r.prototype.initialize=function(){var t,e;return r.__super__.initialize.apply(this,arguments),this.$fullDialog=this.$el.closest(".ui-dialog"),e=this.$fullDialog.find(".ui-dialog-titlebar"),t=e.find(".ui-dialog-titlebar-close"),t.html(l()),this.$fullDialog.addClass("compose-message-dialog"),this.$fullDialog.find(".ui-dialog-buttonpane").prepend(u()),this.$addMediaComment=this.$fullDialog.find(".attach-media")},r.prototype.prepareTextarea=function(t){var e;return e=t.find("textarea"),e.elastic()},r.prototype.onCourse=function(t){return this.recipientView.setContext(t,!0),this.$contextCode.val((null!=t?t.id:void 0)?t.id:""),this.$messageCourseRO.text(t?t.name:e.t("no_course","No course"))},r.prototype.defaultCourse=null,r.prototype.setDefaultCourse=function(t){return this.defaultCourse=t},r.prototype.initializeForm=function(){var t,i,n,a,r,c,l,u,d,y,_=this;return this.prepareTextarea(this.$el),this.recipientView=new p({el:this.$recipients,disabled:null!=(u=this.model)?u.get("private"):void 0}).render(),this.recipientView.on("changeToken",this.recipientIdsChanged),this.$messageCourse.prop("disabled",!!this.model),this.courseView=new f({el:this.$messageCourse,courses:this.options.courses,defaultOption:e.t("select_course","Select course")}),this.courseView.on("course",this.onCourse),this.model?this.courseView.setValue(this.model.get("context_code")?this.model.get("context_code"):"course_"+o.keys(this.model.get("audience_contexts").courses)[0]):this.launchParams?this.launchParams.context&&this.courseView.setValue(this.launchParams.context):this.courseView.setValue(this.defaultCourse),this.model?(this.courseView.$picker.css("display","none"),this.recipientView.$input.focus()):(this.$messageCourseRO.css("display","none"),this.courseView.focus()),(this.tokenInput=this.$el.find(".recipients").data("token_input"))&&(this.tokenInput.$fakeInput.css("width","100%"),this.options.user_id&&(c={user_id:this.options.user_id,from_conversation_id:this.options.from_conversation_id},s.ajaxJSON(this.tokenInput.selector.url,"GET",c,function(t){return t.length?_.tokenInput.addToken({value:t[0].id,text:t[0].name,data:t[0]}):void 0}))),this.to&&"forward"!==this.to&&this.message&&(l=[],l.push(this.message.get("author")),("replyAll"===this.to||ENV.current_user_id===this.message.get("author").id)&&(l=l.concat(this.message.get("participants")),l.length>1&&(l=o.filter(l,function(t){return t.id!==ENV.current_user_id}))),this.recipientView.setTokens(l)),this.launchParams&&this.recipientView.setTokens([this.launchParams.user]),this.model?(this.$messageSubject.css("display","none"),this.$messageSubject.prop("disabled",!0)):this.$messageSubjectRO.css("display","none"),(null!=(d=this.model)?d.get("subject"):void 0)&&(this.$messageSubject.val(this.model.get("subject")),this.$messageSubjectRO.text(this.model.get("subject"))),(a=null!=(y=this.model)?y.messageCollection:void 0)&&(i=new Date(this.message.get("created_at")),r=this.message.get("participating_user_ids"),n=new v(a.filter(function(t){return new Date(t.get("created_at"))<=i&&!o.find(r,function(e){return!o.contains(t.get("participating_user_ids"),e)})})),t=new g({el:this.$contextMessages,collection:n}),t.render()),this.$fullDialog.on("click",".message-body",this.handleBodyClick),this.$fullDialog.on("click",".attach-file",h(function(){return _.addAttachment()})),this.$fullDialog.on("click",".attachment .remove_link",h(function(t){return _.removeAttachment(s(t.currentTarget))})),this.$fullDialog.on("keydown",".attachment",this.handleAttachmentKeyDown),this.$fullDialog.on("click",".attachment",this.handleAttachmentClick),this.$fullDialog.on("dblclick",".attachment",this.handleAttachmentDblClick),this.$fullDialog.on("change",".file_input",this.handleAttachment),this.$fullDialog.on("click",".attach-media",h(function(){return _.addMediaComment()})),this.$fullDialog.on("click",".media_comment .remove_link",h(function(t){return _.removeMediaComment(s(t.currentTarget))})),this.$addMediaComment[INST.kalturaSettings?"show":"hide"](),this.$form.formSubmit({fileUpload:function(){return _.$fullDialog.find(".attachment_list").length>0},files:function(){return _.$fullDialog.find(".file_input")},preparedFileUpload:!0,context_code:"user_"+ENV.current_user_id,folder_id:this.options.folderId,intent:"message",formDataTarget:"url",disableWhileLoading:!0,required:["body"],property_validations:{token_capture:function(){return _.recipientView&&!_.recipientView.tokens.length?e.t("errors.field_is_required","This field is required"):void 0}},handle_files:function(t,e){var i;return e.attachment_ids=function(){var e,n,s;for(s=[],e=0,n=t.length;n>e;e++)i=t[e],s.push(i.attachment.id);return s}(),e},processData:function(t){return t.context_code||(t.context_code=_.options.account_context_code),t},onSubmit:function(t){var e,i;return _.request=t,e=s.Deferred(),_.trigger("submitting",e),_.close(),i=_.to,_.to=null,s.when(_.request).then(function(t){var n;return e.resolve(),s.flashMessage(_.messages.flashSuccess),i?(n=t.messages[0],n.author={name:ENV.current_user.display_name,avatar_url:ENV.current_user.avatar_image_url},n=new m(t,{parse:!0}),_.trigger("addMessage",n.toJSON().conversation.messages[0],t)):_.trigger("newConversations",t)})}})},r.prototype.recipientIdsChanged=function(t){var e,i=this;return o.isEmpty(t)||o.contains(t,/(teachers|tas|observers)$/)?this.toggleUserNote(!1):(e=o.map(this.recipientView.tokenModels(),function(t){return i.canAddNotesFor(t)}),this.toggleUserNote(o.every(e)))},r.prototype.canAddNotesFor=function(t){var e,i,s;if(!ENV.CONVERSATIONS.NOTES_ENABLED)return!1;if(null==t)return!1;if(t.id.match(/students$/)||t.id.match(/^group/))return!0;s=t.get("common_courses");for(e in s)if(i=s[e],n.call(i,"StudentEnrollment")>=0&&(ENV.CONVERSATIONS.CAN_ADD_NOTES_FOR_ACCOUNT||ENV.CONVERSATIONS.CAN_ADD_NOTES_FOR_COURSES[e]))return!0;return!1},r.prototype.toggleUserNote=function(t){return this.$userNoteInfo.toggle(t),t===!1&&this.$userNote.prop("checked",!1),this.resizeBody()},r.prototype.resizeBody=function(){return this.updateAttachmentOverflow(),this.$messageBody.height(this.$el.offset().top+this.$el.height()-this.$messageBody.offset().top-this.$attachmentsPane.height())},r.prototype.attachmentsShouldOverflow=function(){var t;return t=this.$attachments.children(),t.length*t.outerWidth()>this.$attachmentsPane.width()},r.prototype.addAttachment=function(){var t;return t=s(d()),this.$attachments.append(t),t.hide(),t.find("input").click(),this.updateAttachmentOverflow(),this.focusAddAttachment()},r.prototype.setAttachmentClip=function(t){var e,i;return i=t.find(s(".attachment-name")),e=t.find(s(".attachment-name-clip")),e.height(i.height()),i.height()<35?e.addClass("hidden"):void 0},r.prototype.imageTypes=["jpg","jpeg","png","gif","bmp","svg"],r.prototype.handleBodyClick=function(t){return t.target===t.currentTarget?this.$conversationBody.focus():void 0},r.prototype.handleAttachmentClick=function(t){return s(t.currentTarget).focus()},r.prototype.handleAttachmentDblClick=function(t){return s(t.currentTarget).find("input").click()},r.prototype.handleAttachment=function(t){var e,i,o,a,r,c,h,l,u;return c=t.currentTarget,e=s(c).closest(".attachment"),this.updateAttachmentPane(),c.value?(e.slideDown("fast"),i=e.find(".attachment-icon i"),i.empty(),a=c.files[0],h=a.name,e.find(".attachment-name").text(h),this.setAttachmentClip(e),u=e.find(".remove_link"),u.attr("aria-label",u.attr("title")+": "+h),o=h.split(".").pop().toLowerCase(),n.call(this.imageTypes,o)>=0&&window.FileReader?(l=new FileReader,l.addEventListener("load",function(t){var e;return e=t.target,i.attr("class",""),i.append(s("<img />").attr("src",e.result))}),void l.readAsDataURL(a)):(r="paperclip",n.call(this.imageTypes,o)>=0?r="image":"pdf"===o?r="pdf":"doc"===o||"docx"===o?r="ms-word":("xls"===o||"xlsx"===o)&&(r="ms-excel"),i.attr("class","icon-"+r))):void e.hide()},r.prototype.handleAttachmentKeyDown=function(t){if(37===t.keyCode)return this.focusPrevAttachment(s(t.currentTarget));if(39===t.keyCode)return this.focusNextAttachment(s(t.currentTarget));if((13===t.keyCode||32===t.keyCode)&&!s(t.target).hasClass("remove_link"))return this.handleAttachmentDblClick(t),!1;if(46===t.keyCode||68===t.keyCode||13===t.keyCode||32===t.keyCode)return this.removeAttachment(t.currentTarget),!1},r.prototype.removeEmptyAttachments=function(){return o.each(this.$attachments.find("input[value=]"),this.removeAttachment)},r.prototype.removeAttachment=function(t){var e,i=this;return e=s(t).closest(".attachment"),this.focusNextAttachment(e)||this.focusPrevAttachment(e)||this.focusAddAttachment(),e.slideUp("fast",function(){return e.remove(),i.updateAttachmentPane()})},r.prototype.focusPrevAttachment=function(t){var e;return e=t.prevAll(":visible").first(),e.length?e.focus():!1},r.prototype.focusNextAttachment=function(t){var e;return e=t.nextAll(":visible").first(),e.length?e.focus():!1},r.prototype.focusAddAttachment=function(){return this.$fullDialog.find(".attach-file").focus()},r.prototype.addMediaComment=function(){var t=this;return this.$mediaComment.mediaComment("create","any",function(e,i){return t.$mediaCommentId.val(e),t.$mediaCommentType.val(i),t.$mediaComment.show(),t.$addMediaComment.hide()})},r.prototype.removeMediaComment=function(){return this.$mediaCommentId.val(""),this.$mediaCommentType.val(""),this.$mediaComment.hide(),this.$addMediaComment.show()},r.prototype.updateAttachmentOverflow=function(){return this.$attachmentsPane.toggleClass("overflowed",this.attachmentsShouldOverflow())},r.prototype.updateAttachmentPane=function(){return this.$attachmentsPane[this.$attachmentsPane.find("input:not([value=])").length?"addClass":"removeClass"]("has-items"),this.resizeBody()},r}(r)})}).call(this);