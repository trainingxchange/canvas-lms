(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,s=function(t,s){function n(){this.constructor=t}for(var i in s)e.call(s,i)&&(t[i]=s[i]);return n.prototype=s.prototype,t.prototype=new n,t.__super__=s.prototype,t};define(["i18n!assignments","jquery","underscore","Backbone","compiled/class/cache","compiled/models/AssignmentGroup","jst/assignments/ToggleShowBy"],function(e,n,i,o,r,u,a){var h,c;return h=function(e){function o(){return this.toggleShowBy=t(this.toggleShowBy,this),this.setAssignmentGroups=t(this.setAssignmentGroups,this),this.initializeDateGroups=t(this.initializeDateGroups,this),this.initializeCache=t(this.initializeCache,this),c=o.__super__.constructor.apply(this,arguments)}return s(o,e),o.optionProperty("course"),o.optionProperty("assignmentGroups"),o.prototype.template=a,o.prototype.els={"#show_by":"$showBy","#show_by_date":"$showByDate"},o.prototype.events={"click input":"toggleShowBy"},o.prototype.initialize=function(){return o.__super__.initialize.apply(this,arguments),this.initialized=!1,this.initializeCache(),this.course.on("change",this.initializeCache),this.course.on("change",this.render),this.assignmentGroups.once("change:submissions",this.initializeDateGroups),this.on("changed:showBy",this.setAssignmentGroups),this.on("changed:showBy",this.render)},o.prototype.initializeCache=function(){return null!=this.course.get("id")?(n.extend(!0,this,r),null!=ENV.current_user_id&&this.cache.use("localStorage"),null==this.cache.get(this.cacheKey())&&this.cache.set(this.cacheKey(),!0),this.initialized=!0):void 0},o.prototype.initializeDateGroups=function(){var t,e,s,n,o,r,a,h,c,p,g;return t=i.flatten(this.assignmentGroups.map(function(t){return t.get("assignments").models})),e=i.select(t,function(t){return null!=t.dueAt()}),h=i.difference(t,e),o=[],s=[],p=[],i.each(e,function(t){return new Date>Date.parse(t.dueAt())?t.expectsSubmission()&&t.allowedToSubmit()&&t.withoutGradedSubmission()?s.push(t):o.push(t):p.push(t)}),n=new u({id:"overdue",name:"Overdue Assignments",assignments:s}),g=new u({id:"upcoming",name:"Upcoming Assignments",assignments:p}),c=new u({id:"undated",name:"Undated Assignments",assignments:h}),r=new u({id:"past",name:"Past Assignments",assignments:o}),a=this._sortGroups(n,g,c,r),this.groupedByAG=this.assignmentGroups.models,this.groupedByDate=a,this.setAssignmentGroups()},o.prototype._sortGroups=function(t,e,s,n){return this._sortAscending(t.get("assignments")),this._sortAscending(e.get("assignments")),this._sortDescending(n.get("assignments")),[t,e,s,n]},o.prototype._sortAscending=function(t){return t.comparator=function(t){return Date.parse(t.dueAt())},t.sort()},o.prototype._sortDescending=function(t){return t.comparator=function(t){return new Date-Date.parse(t.dueAt())},t.sort()},o.prototype.toJSON=function(){return{visible:this.initialized,showByDate:this.showByDate()}},o.prototype.afterRender=function(){var t;return null!=(t=this.$showBy)?t.buttonset():void 0},o.prototype.setAssignmentGroups=function(){var t,e=this;return t=this.showByDate()?this.groupedByDate:this.groupedByAG,this.setAssignmentGroupAssociations(t),t=i.select(t,function(t){var s;return s=e.course.get("apply_assignment_group_weights")&&null!=t.get("group_weight")&&t.get("group_weight")>0,t.get("assignments").length>0||s}),this.assignmentGroups.reset(t)},o.prototype.setAssignmentGroupAssociations=function(t){var e,s,n,i,o;for(o=[],n=0,i=t.length;i>n;n++)s=t[n],o.push(s.get("assignments").models.length?function(){var t,n,i,o;for(i=s.get("assignments").models,o=[],t=0,n=i.length;n>t;t++)e=i[t],e.collection=s,o.push(e.set("assignment_group_id",s.id));return o}():void 0);return o},o.prototype.showByDate=function(){return this.initialized?this.cache.get(this.cacheKey()):!0},o.prototype.cacheKey=function(){return["course",this.course.get("id"),"user",ENV.current_user_id,"assignments_show_by_date"]},o.prototype.toggleShowBy=function(t){var e,s,n;return t.preventDefault(),s=this.cacheKey(),n=this.$showByDate.is(":checked"),e=this.cache.get(s),e!==n&&(this.cache.set(s,n),this.trigger("changed:showBy")),this.assignmentGroups.trigger("cancelSearch")},o}(o.View)})}).call(this);