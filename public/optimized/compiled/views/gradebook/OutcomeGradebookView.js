(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,o=function(e,o){function r(){this.constructor=e}for(var i in o)t.call(o,i)&&(e[i]=o[i]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e};define(["i18n!gradebook2","jquery","underscore","Backbone","vendor/slickgrid","compiled/gradebook2/OutcomeGradebookGrid","compiled/views/gradebook/CheckboxView","compiled/views/gradebook/SectionMenuView","jst/gradebook2/outcome_gradebook","vendor/jquery.ba-tinypubsub","jquery.instructure_misc_plugins"],function(t,r,i,n,s,a,c,u,d){var l,p,h;return h=n.View,l={mastery:{color:"#8bab58",label:t.t("mastery","mastery")},nearMastery:{color:"#e0d679",label:t.t("near_mastery","near mastery")},remedial:{color:"#dd5c5c",label:t.t("remedial","remedial")}},p=function(t){function n(t){this.updateExportLink=e(this.updateExportLink,this),this._drawSectionMenu=e(this._drawSectionMenu,this),this._loadOutcomes=e(this._loadOutcomes,this),this.renderGrid=e(this.renderGrid,this),n.__super__.constructor.apply(this,arguments),this._validateOptions(t)}return o(n,t),n.prototype.tagName="div",n.prototype.className="outcome-gradebook-container",n.prototype.template=d,n.optionProperty("gradebook"),n.prototype.hasOutcomes=r.Deferred(),n.prototype.checkboxes={mastery:new c(l.mastery),"near-mastery":new c(l.nearMastery),remedial:new c(l.remedial)},n.prototype.events={"click .sidebar-toggle":"onSidebarToggle"},n.prototype.onSidebarToggle=function(e){var t;return e.preventDefault(),t=this._toggleSidebarCollapse(),this._toggleSidebarArrow(),this._toggleSidebarTooltips(t)},n.prototype._toggleSidebarCollapse=function(){return this.$(".outcome-gradebook-sidebar").toggleClass("collapsed").hasClass("collapsed")},n.prototype._toggleSidebarArrow=function(){return this.$(".sidebar-toggle").toggleClass("icon-arrow-open-right").toggleClass("icon-arrow-open-left")},n.prototype._toggleSidebarTooltips=function(e){return e?this.$(".checkbox-view").each(function(){return r(this).find(".checkbox").attr("data-tooltip","left").attr("title",r(this).find(".checkbox-label").text())}):this.$(".checkbox").removeAttr("data-tooltip").removeAttr("title")},n.prototype._validateOptions=function(e){var t;if(t=e.gradebook,!t)throw new Error('Missing required option: "gradebook"')},n.prototype._attachEvents=function(){var e,t,o;o=this.checkboxes;for(e in o)t=o[e],t.on("togglestate",this._createFilter(e));return r.subscribe("currentSection/change",a.Events.sectionChangeFunction(this.grid)),r.subscribe("currentSection/change",this.updateExportLink),this.updateExportLink(this.gradebook.sectionToShow)},n.prototype._attachGridEvents=function(){return this.grid.onHeaderRowCellRendered.subscribe(a.Events.headerRowCellRendered),this.grid.onHeaderCellRendered.subscribe(a.Events.headerCellRendered),this.grid.onSort.subscribe(a.Events.sort)},n.prototype.toJSON=function(){return i.extend({},this.checkboxes)},n.prototype.render=function(){var e=this;return r.when(this.gradebook.hasSections).then(function(){return n.__super__.render.apply(e,arguments)}).then(this._drawSectionMenu),r.when(this.hasOutcomes).then(this.renderGrid),this},n.prototype.renderGrid=function(e){var t,o,r;return a.Util.saveOutcomes(e.linked.outcomes),a.Util.saveStudents(e.linked.users),a.Util.saveOutcomePaths(e.linked.outcome_paths),a.Util.saveSections(this.gradebook.sections),r=a.Util.toGrid(e,{column:{formatter:a.View.cell},row:{section:this.menu.currentSection}}),t=r[0],o=r[1],this.grid=new s.Grid(".outcome-gradebook-wrapper",o,t,a.options),this._attachGridEvents(),this.grid.init(),a.Events.init(this.grid),this._attachEvents()},n.prototype.isLoaded=!1,n.prototype.onShow=function(){var e=this;return this.isLoaded||this.loadOutcomes(),this.isLoaded=!0,this.$el.fillWindowWithMe({onResize:function(){return e.grid?e.grid.resizeCanvas():void 0}})},n.prototype.loadOutcomes=function(){return r.when(this.gradebook.hasSections).then(this._loadOutcomes)},n.prototype._loadOutcomes=function(){var e;return e=ENV.context_asset_string.split("_")[1],this.$(".outcome-gradebook-wrapper").disableWhileLoading(this.hasOutcomes),this._loadPage("/api/v1/courses/"+e+"/outcome_rollups?per_page=100&include[]=outcomes&include[]=users&include[]=outcome_paths")},n.prototype._loadPage=function(e,t){var o,i=this;return o=r.getJSON(e),o.then(function(e){return t=i._mergeResponses(t,e),e.meta.pagination.next?i._loadPage(e.meta.pagination.next,t):i.hasOutcomes.resolve(t)})},n.prototype._mergeResponses=function(e,t){var o;return e?(o={},o.meta=i.extend({},e.meta,t.meta),o.linked={outcomes:e.linked.outcomes,outcome_paths:e.linked.outcome_paths,users:e.linked.users.concat(t.linked.users)},o.rollups=e.rollups.concat(t.rollups),o):t},n.prototype._drawSectionMenu=function(){return this.menu=new u({sections:this.gradebook.sectionList(),currentSection:this.gradebook.sectionToShow,el:r(".section-button-placeholder")}),this.menu.render()},n.prototype._createFilter=function(e){var t,o=this;return t=function(t){return a.filter=t?i.uniq(a.filter.concat([e])):i.reject(a.filter,function(t){return t===e}),o.grid.invalidate()}},n.prototype.updateExportLink=function(e){var t;return t=""+ENV.GRADEBOOK_OPTIONS.context_url+"/outcome_rollups.csv",e&&(t+="?section_id="+e),r(".export-content").attr("href",t)},n}(h)})}).call(this);