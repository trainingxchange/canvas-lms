(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,i=function(e,i){function s(){this.constructor=e}for(var n in i)t.call(i,n)&&(e[n]=i[n]);return s.prototype=i.prototype,e.prototype=new s,e.__super__=i.prototype,e};define(["i18n!discussion_topics","compiled/views/ValidatedFormView","compiled/views/assignments/AssignmentGroupSelector","compiled/views/assignments/GradingTypeSelector","compiled/views/assignments/GroupCategorySelector","compiled/views/assignments/PeerReviewsSelector","underscore","jst/DiscussionTopics/EditView","wikiSidebar","str/htmlEscape","compiled/models/DiscussionTopic","compiled/models/Announcement","compiled/models/Assignment","jquery","compiled/fn/preventDefault","compiled/views/calendar/MissingDateDialogView","compiled/tinymce","tinymce.editor_box","jquery.instructure_misc_helpers","compiled/jquery.rails_flash_notifications"],function(t,s,n,o,r,a,p,l,d,u,c,g,h,m,_,v){var y,f;return y=function(u){function h(){return this._validatePointsPossible=e(this._validatePointsPossible,this),this.validateBeforeSave=e(this.validateBeforeSave,this),this.submit=e(this.submit,this),this.updateAssignment=e(this.updateAssignment,this),this.renderPeerReviewOptions=e(this.renderPeerReviewOptions,this),this.renderGroupCategoryOptions=e(this.renderGroupCategoryOptions,this),this.renderGradingTypeOptions=e(this.renderGradingTypeOptions,this),this.renderAssignmentGroupOptions=e(this.renderAssignmentGroupOptions,this),this.render=e(this.render,this),this.isAnnouncement=e(this.isAnnouncement,this),this.isTopic=e(this.isTopic,this),f=h.__super__.constructor.apply(this,arguments)}return i(h,u),h.prototype.template=l,h.prototype.tagName="form",h.prototype.className="form-horizontal no-margin",h.prototype.dontRenableAfterSaveSuccess=!0,h.prototype.els={"#availability_options":"$availabilityOptions","#use_for_grading":"$useForGrading"},h.prototype.events=p.extend(h.prototype.events,{"click .removeAttachment":"removeAttachment","change #use_for_grading":"toggleAvailabilityOptions"}),h.prototype.messages={group_category_section_label:t.t("group_discussion_title","Group Discussion"),group_category_field_label:t.t("this_is_a_group_discussion","This is a Group Discussion"),group_locked_message:t.t("group_discussion_locked","Students have already submitted to this discussion, so group settings cannot be changed.")},h.optionProperty("permissions"),h.prototype.initialize=function(e){var t=this;return this.assignment=this.model.get("assignment"),this.dueDateOverrideView=e.views["js-assignment-overrides"],this.model.on("sync",function(){return t.unwatchUnload(),window.location=t.model.get("html_url")}),h.__super__.initialize.apply(this,arguments)},h.prototype.isTopic=function(){return this.model.constructor===c},h.prototype.isAnnouncement=function(){return this.model.constructor===g},h.prototype.toJSON=function(){var e,t;return e=h.__super__.toJSON.apply(this,arguments),t=p.extend(e,this.options,{showAssignment:!!this.assignmentGroupCollection,useForGrading:null!=this.model.get("assignment"),isTopic:this.isTopic(),isAnnouncement:this.isAnnouncement(),contextIsCourse:"courses"===this.options.contextType,canAttach:this.permissions.CAN_ATTACH,canModerate:this.permissions.CAN_MODERATE,isLargeRoster:("undefined"!=typeof ENV&&null!==ENV?ENV.IS_LARGE_ROSTER:void 0)||!1,threaded:"threaded"===e.discussion_type,draftStateEnabled:ENV.DRAFT_STATE&&ENV.DISCUSSION_TOPIC.PERMISSIONS.CAN_MODERATE,differentiatedAssignmnetsEnabled:("undefined"!=typeof ENV&&null!==ENV?ENV.DIFFERENTIATED_ASSIGNMENTS_ENABLED:void 0)||!1}),t.assignment=t.assignment.toView(),t},h.prototype.render=function(){var e;return h.__super__.render.apply(this,arguments),d.inited||(d.init(),m.scrollSidebar()),e=this.$("textarea[name=message]").attr("id",p.uniqueId("discussion-topic-message")),p.defer(function(){return e.editorBox(),m(".rte_switch_views_link").click(function(t){return t.preventDefault(),t.stopPropagation(),e.editorBox("toggle"),m(t.currentTarget).siblings(".rte_switch_views_link").andSelf().toggle()})}),d.attachToEditor(e),d.show(),this.assignmentGroupCollection&&(this.assignmentGroupFetchDfd||(this.assignmentGroupFetchDfd=this.assignmentGroupCollection.fetch())).done(this.renderAssignmentGroupOptions),p.defer(this.renderGradingTypeOptions),p.defer(this.renderGroupCategoryOptions),p.defer(this.renderPeerReviewOptions),p.defer(this.watchUnload),this.$(".datetime_field").datetime_field(),this},h.prototype.renderAssignmentGroupOptions=function(){return this.assignmentGroupSelector=new n({el:"#assignment_group_options",assignmentGroups:this.assignmentGroupCollection.toJSON(),parentModel:this.assignment,nested:!0}),this.assignmentGroupSelector.render()},h.prototype.renderGradingTypeOptions=function(){return this.gradingTypeSelector=new o({el:"#grading_type_options",parentModel:this.assignment,nested:!0,preventNotGraded:!0}),this.gradingTypeSelector.render()},h.prototype.renderGroupCategoryOptions=function(){return this.groupCategorySelector=new r({el:"#group_category_options",parentModel:this.model,groupCategories:ENV.GROUP_CATEGORIES,hideGradeIndividually:!0,sectionLabel:this.messages.group_category_section_label,fieldLabel:this.messages.group_category_field_label,lockedMessage:this.messages.group_locked_message}),this.groupCategorySelector.render()},h.prototype.renderPeerReviewOptions=function(){return this.peerReviewSelector=new a({el:"#peer_review_options",parentModel:this.assignment,nested:!0}),this.peerReviewSelector.render()},h.prototype.getFormData=function(){var e,i;return i=h.__super__.getFormData.apply(this,arguments),i.title||(i.title=t.t("default_discussion_title","No Title")),i.discussion_type="1"===i.threaded?"threaded":"side_comment","1"!==i.podcast_enabled&&(i.podcast_has_student_posts=!1),("undefined"!=typeof ENV&&null!==ENV?ENV.IS_LARGE_ROSTER:void 0)||(i=this.groupCategorySelector.filterFormData(i)),e=i.assignment,delete i.assignment,"1"===(null!=e?e.set_assignment:void 0)?(i.set_assignment="1",i.assignment=this.updateAssignment(e),i.delayed_post_at="",i.lock_at=""):i.assignment=this.model.createAssignment({set_assignment:"0"}),this.saveOpts={multipart:!!i.attachment,proxyAttachment:!0},i},h.prototype.updateAssignment=function(e){var t,i;return this.dueDateOverrideView.updateOverrides(),i=this.dueDateOverrideView.getDefaultDueDate(),e.lock_at=(null!=i?i.get("lock_at"):void 0)||null,e.unlock_at=(null!=i?i.get("unlock_at"):void 0)||null,e.due_at=(null!=i?i.get("due_at"):void 0)||null,e.assignment_overrides=this.dueDateOverrideView.getOverrides(),("undefined"!=typeof ENV&&null!==ENV?ENV.DIFFERENTIATED_ASSIGNMENTS_ENABLED:void 0)&&(e.only_visible_to_overrides=this.dueDateOverrideView.containsSectionsWithoutOverrides()),t=this.model.get("assignment"),t||(t=this.model.createAssignment()),t.set(e)},h.prototype.removeAttachment=function(){return this.model.set("attachments",[]),this.$el.append('<input type="hidden" name="remove_attachment" >'),this.$(".attachmentRow").remove(),this.$('[name="attachment"]').show()},h.prototype.submit=function(e){var t,i,n=this;return e.preventDefault(),e.stopPropagation(),this.dueDateOverrideView.containsSectionsWithoutOverrides()?(i=this.dueDateOverrideView.sectionsWithoutOverrides(),t=new v({validationFn:function(){return i},labelFn:function(e){return e.get("name")},success:function(){var e;return t.$dialog.dialog("close").remove(),null!=(e=n.model.get("assignment"))&&e.setNullDates(),s.prototype.submit.call(n)}}),t.cancel=function(){return t.$dialog.dialog("close").remove()},t.render()):h.__super__.submit.apply(this,arguments)},h.prototype.fieldSelectors=p.extend({},n.prototype.fieldSelectors,r.prototype.fieldSelectors),h.prototype.validateBeforeSave=function(e,t){var i;return"0"===e.delay_posting&&(e.delayed_post_at=null),this.isTopic()&&"1"===e.set_assignment?(null!=this.assignmentGroupSelector&&(t=this.assignmentGroupSelector.validateBeforeSave(e,t)),("undefined"!=typeof ENV&&null!==ENV?ENV.IS_LARGE_ROSTER:void 0)||(t=this.groupCategorySelector.validateBeforeSave(e,t)),i={assignment_overrides:this.dueDateOverrideView.getAllDates(e.assignment.toJSON())},t=this.dueDateOverrideView.validateBeforeSave(i,t),t=this._validatePointsPossible(e,t)):this.model.set("assignment",this.model.createAssignment({set_assignment:!1})),t},h.prototype._validatePointsPossible=function(e,i){var s,n;return s=e.assignment,n=p.contains(s.frozenAttributes(),"points_possible"),!n&&s.pointsPossible()&&isNaN(parseFloat(s.pointsPossible()))&&(i["assignment[points_possible]"]=[{message:t.t("points_possible_number","Points possible must be a number")}]),i},h.prototype.showErrors=function(e){return delete e.assignmentOverrides,h.__super__.showErrors.call(this,e)},h.prototype.toggleAvailabilityOptions=function(){return this.$useForGrading.is(":checked")?this.$availabilityOptions.hide():this.$availabilityOptions.show()},h}(s)})}).call(this);