(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,i=function(e,i){function r(){this.constructor=e}for(var n in i)t.call(i,n)&&(e[n]=i[n]);return r.prototype=i.prototype,e.prototype=new r,e.__super__=i.prototype,e};define(["i18n!editor","jquery","underscore","str/htmlEscape","compiled/fn/preventDefault","compiled/views/DialogBaseView","jst/tinymce/InsertUpdateImageView"],function(t,r,n,a,o,s,l){var c,h;return c=function(a){function o(){return this.update=e(this.update,this),this.onFileLinkDblclick=e(this.onFileLinkDblclick,this),this.constrainProportions=e(this.constrainProportions,this),h=o.__super__.constructor.apply(this,arguments)}return i(o,a),o.prototype.template=l,o.prototype.events={'change [name="image[width]"]':"constrainProportions",'change [name="image[height]"]':"constrainProportions","click .flickrImageResult, .treeFile":"onFileLinkClick",'change [name="image[src]"]':"onImageUrlChange","tabsshow .imageSourceTabs":"onTabsshow","dblclick .flickrImageResult, .treeFile":"onFileLinkDblclick"},o.prototype.dialogOptions={width:625,title:t.t("titles.insert_edit_image","Insert / Edit Image")},o.prototype.initialize=function(e,t){return this.editor=e,this.$editor=r("#"+this.editor.id),this.prevSelection=this.editor.selection.getBookmark(),this.$selectedNode=r(t),o.__super__.initialize.apply(this,arguments),this.render(),this.show(),"IMG"===this.$selectedNode.prop("nodeName")?this.setSelectedImage({src:this.$selectedNode.attr("src"),alt:this.$selectedNode.attr("alt"),width:this.$selectedNode.width(),height:this.$selectedNode.height()}):void 0},o.prototype.afterRender=function(){return this.$(".imageSourceTabs").tabs()},o.prototype.onTabsshow=function(e,t){var i,n=this;switch(i=function(e){var i;if(!n[""+t.panel.id+"IsLoaded"])return n[""+t.panel.id+"IsLoaded"]=!0,i=r.Deferred(),r(t.panel).disableWhileLoading(i),e(i.resolve)},t.panel.id){case"tabUploaded":return i(function(e){return require(["compiled/views/FileBrowserView"],function(i){return new i({contentTypes:"image"}).render().$el.appendTo(t.panel),e()})});case"tabFlickr":return i(function(e){return require(["compiled/views/FindFlickrImageView"],function(i){return(new i).render().$el.appendTo(t.panel),e()})})}},o.prototype.setAspectRatio=function(){var e,t;return t=Number(this.$("[name='image[width]']").val()),e=Number(this.$("[name='image[height]']").val()),t&&e?this.aspectRatio=t/e:delete this.aspectRatio},o.prototype.constrainProportions=function(e){var t;return t=Number(r(e.target).val()),this.aspectRatio&&(t||0===t)?r(e.target).is('[name="image[height]"]')?this.$('[name="image[width]"]').val(Math.round(t*this.aspectRatio)):this.$('[name="image[height]"]').val(Math.round(t/this.aspectRatio)):void 0},o.prototype.setSelectedImage=function(e){var t,i,a,o,s,l=this;null==e&&(e={});for(i in e)s=e[i],this.$("[name='image["+i+"]']").val(s);return t=r.Deferred(),o=function(r){var a,o,c;a=r.target,c=n.defaults(e,{width:a.width,height:a.height});for(i in c)s=c[i],l.$("[name='image["+i+"]']").val(s);return o=c.width&&c.height,l.setAspectRatio(),t.resolve(c)},a=function(e){var t,r,n;t=e.target,r={width:"",height:""},n=[];for(i in r)s=r[i],n.push(l.$("[name='image["+i+"]']").val(s));return n},this.$img=r("<img>",e).load(o).error(a),t},o.prototype.getAttributes=function(){var e,t,i,r,n,a,o,s,l;for(t={},s=["width","height"],r=0,a=s.length;a>r;r++)e=s[r],i=Number(this.$("[name='image["+e+"]']").val()),i&&i>0&&(t[e]=i);for(l=["src","alt"],n=0,o=l.length;o>n;n++)e=l[n],i=this.$("[name='image["+e+"]']").val(),i&&(t[e]=i);return t},o.prototype.onFileLinkClick=function(e){var t;return e.preventDefault(),this.$(".active").removeClass("active").parent().removeAttr("aria-selected"),t=r(e.currentTarget).addClass("active"),t.parent().attr("aria-selected",!0),this.flickr_link=t.attr("data-linkto"),this.setSelectedImage({src:t.attr("data-fullsize"),alt:t.attr("title")})},o.prototype.onFileLinkDblclick=function(){return this.update()},o.prototype.onImageUrlChange=function(e){return this.flickr_link=null,this.setSelectedImage({src:r(e.currentTarget).val()})},o.prototype.generateImageHtml=function(){var e;return e=this.editor.dom.createHTML("img",this.getAttributes()),this.flickr_link&&(e="<a href='"+this.flickr_link+"'>"+e+"</a>"),e},o.prototype.update=function(){return this.editor.selection.moveToBookmark(this.prevSelection),this.$editor.editorBox("insert_code",this.generateImageHtml()),this.editor.focus(),this.close()},o}(s)})}).call(this);