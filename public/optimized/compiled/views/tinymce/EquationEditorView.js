(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,i=function(t,i){function a(){this.constructor=t}for(var o in i)e.call(i,o)&&(t[o]=i[o]);return a.prototype=i.prototype,t.prototype=new a,t.__super__=i.prototype,t};define(["i18n!editor","jquery","underscore","Backbone","compiled/views/tinymce/EquationToolbarView","jst/tinymce/EquationEditorView","jqueryui/dialog","mathquill"],function(e,a,o,n,r,s){var l,h,u;return h=function(t){return o.map(t,function(t){var e;return 3===(e=t.nodeType)||4===e?t.nodeValue:"IMG"===t.nodeName&&"equation_image"===t.className?t.alt:8!==t.nodeType?h(t.childNodes):void 0}).join("")},l=function(o){function n(){return this.onSubmit=t(this.onSubmit,this),this.setView=t(this.setView,this),this.toggleView=t(this.toggleView,this),this.initialRender=t(this.initialRender,this),this.onClose=t(this.onClose,this),u=n.__super__.constructor.apply(this,arguments)}return i(n,o),n.prototype.template=s,n.prototype.el=a(document.createElement("span")).appendTo("body")[0],n.prototype.els={"#mathquill-view":"$mathquillView","#mathquill-container":"$mathquillContainer","#mathjax-view":"$mathjaxView","#mathjax-editor":"$mathjaxEditor","#mathjax-message":"$mathjaxMessage"},n.prototype.initialize=function(t){var i,o;return this.editor=t,this.$editor=a("#"+this.editor.id),this.prevSelection=this.editor.selection.getBookmark(),(this.toolbar=this.$el.data("toolbar"))||(o=a("<span>").html(this.editor.selection.getContent()),i=h(o).replace(/^\s+|\s+$/g,""),this.addToolbar(i)),this.cacheEls(),this.$el.dialog({minWidth:670,minHeight:290,resizable:!1,title:e.t("equation_editor_title","Use the toolbars here, or Switch View to Advanced to type/paste in LaTeX"),dialogClass:"math-dialog",open:this.initialRender,close:this.onClose,buttons:[{"class":"btn-primary",text:e.t("button.insert_equation","Insert Equation"),click:this.onSubmit}]})},n.prototype.onClose=function(){return this.restoreCaret()},n.prototype.initialRender=function(){var t,e;return e=a("<span>").html(this.editor.selection.getContent()),t=h(e).replace(/^\s+|\s+$/g,""),this.$mathjaxMessage.empty(),this.setView(this.$el.data("view"),t),this.renderEquation(this.opposite(this.$el.data("view")),"")},n.prototype.addToolbar=function(t){return this.$el.append(this.template),a("#mathjax-preview").html("<script type='math/tex; mode=display'>"+t+"</script>"),this.toolbar=new r({el:this.$el}),this.toolbar.render(),a("a.math-toggle-link").bind("click",this.toggleView),this.$el.data("toolbar",this.toolbar),this.$el.data("view","mathquill")},n.prototype.opposite=function(t){return"mathquill"===t?"mathjax":"mathjax"===t?"mathquill":void 0},n.prototype.getEquation=function(){var t;return t=this.$el.data("view"),"mathquill"===t?this.$mathquillContainer.mathquill("latex"):"mathjax"===t?this.$mathjaxEditor.val():void 0},n.prototype.toggleView=function(t){var e,i;return t.preventDefault(),i=this.$el.data("view"),e=this.getEquation(),this.$mathjaxMessage.empty(),this.setView(this.opposite(i),e)},n.prototype.setView=function(t,e){var i=this;return"mathquill"===t?(this.$mathjaxView.hide(),this.$mathquillView.show(),setTimeout(function(){return i.$mathquillView.find(".mathquill-tab-bar li.mathquill-tab-selected a").focus()},200)):"mathjax"===t&&(this.$mathquillView.hide(),this.$mathjaxView.show(),this.$mathjaxView.find(".mathquill-tab-bar li.mathquill-tab-selected a").focus()),this.renderEquation(t,e)?this.$el.data("view",t):this.setView("mathjax",e)},n.prototype.renderEquation=function(t,i){if("mathquill"===t){if(this.$mathquillContainer.mathquill("revert").addClass("mathquill-editor").mathquill("editor").mathquill("write",i),this.$mathquillContainer.mathquill("latex").replace(/\s+/,"")!==i.replace(/\s+/,""))return this.$mathjaxMessage.html(e.t("cannot_render_equation","This equation cannot be rendered in Basic View.")),!1}else"mathjax"===t&&(this.$mathjaxEditor.val(i),this.toolbar.renderPreview&&this.toolbar.renderPreview());return!0},n.prototype.restoreCaret=function(){return this.editor.selection.moveToBookmark(this.prevSelection)},n.prototype.onSubmit=function(t){var e,i,o,n;return t.preventDefault(),o=this.getEquation(),n="/equation_images/"+encodeURIComponent(escape(o)),i=a(document.createElement("img")).attr({src:n,alt:o,title:o,"class":"equation_image"}),e=a(document.createElement("div")).append(i),this.restoreCaret(),this.$editor.editorBox("insert_code",e.html()),this.$el.dialog("close")},n}(n.View)})}).call(this);