(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,o=function(t,o){function i(){this.constructor=t}for(var r in o)e.call(o,r)&&(t[r]=o[r]);return i.prototype=o.prototype,t.prototype=new i,t.__super__=o.prototype,t};define(["Backbone","jquery","underscore","compiled/views/CollectionView"],function(e,i,r,n){var s,p;return s=function(n){function s(){return this.updateModels=t(this.updateModels,this),this._updateSort=t(this._updateSort,this),this._onReceive=t(this._onReceive,this),this._noItemsViewIfEmpty=t(this._noItemsViewIfEmpty,this),this.modifyPlaceholder=t(this.modifyPlaceholder,this),p=s.__super__.constructor.apply(this,arguments)}return o(s,n),s.optionProperty("parentCollection"),s.optionProperty("childKey"),s.optionProperty("groupId"),s.optionProperty("groupKey"),s.optionProperty("reorderURL"),s.optionProperty("noItemTemplate"),s.prototype.sortOptions={tolerance:"pointer",opacity:.9,zIndex:100,connectWith:".draggable.collectionViewItems",placeholder:"draggable-dropzone",forcePlaceholderSize:!0},s.prototype.render=function(t){return null==t&&(t=!0),s.__super__.render.apply(this,arguments),t&&this.initSort(),this},s.prototype.attachCollection=function(){return s.__super__.attachCollection.apply(this,arguments),this.collection.on("add",this._noItemsViewIfEmpty)},s.prototype.initSort=function(){return this.$list.sortable(r.extend({},this.sortOptions,{scope:this.cid})).on("sortstart",this.modifyPlaceholder).on("sortreceive",this._onReceive).on("sortupdate",this._updateSort).on("sortremove",this._noItemsViewIfEmpty),this.$list.disableSelection(),this._noItemsViewIfEmpty()},s.prototype.modifyPlaceholder=function(t,e){return i(e.placeholder).data("group",this.groupId)},s.prototype._noItemsViewIfEmpty=function(){var t;return t=this.$list.children(),0===t.length?this.insertNoItemView():this.removeNoItemView()},s.prototype.insertNoItemView=function(){return this.noItems=new e.View({template:this.noItemTemplate,tagName:"li",className:"no-items"}),this.$list.append(this.noItems.render().el)},s.prototype.removeNoItemView=function(){return this.noItems?this.noItems.remove():void 0},s.prototype.searchItem=function(t){var e,o=this;return e=null,this.parentCollection.find(function(i){var r,n;return r=i.get(o.childKey),n=r.findWhere({id:t}),null!=n?e=n:void 0}),e},s.prototype._getItemId=function(t){var e;return e=t.children(":first").data("item-id"),e&&String(e)},s.prototype._onReceive=function(t,e){var o,i;return o=this._getItemId(e.item),i=this.searchItem(o),this._removeFromGroup(i),this._addToGroup(i)},s.prototype._removeFromGroup=function(t){var e,o,i;return i=t.get(this.groupKey),o=this.parentCollection.findWhere({id:i}),e=o.get(this.childKey),e.remove(t,{silent:!0})},s.prototype._addToGroup=function(t){var e,o;return t.set(this.groupKey,this.groupId),o=this.parentCollection.findWhere({id:this.groupId}),e=o.get(this.childKey),e.add(t,{silent:!0})},s.prototype._updateSort=function(t,e){var o,i,r,n,s;return t.stopImmediatePropagation(),s=this.$(e.item).length,o=this._getItemId(e.item),i=this.collection.get(o),n=e.item.index(),r=this.updateModels(i,n,s),s?(i.set("position",n+1),this.collection.sort(),this._sendPositions(this.collection.pluck("id"))):this.collection.sort()},s.prototype.updateModels=function(t,e,o){var i,n,s,p,h;return p=t.get("position"),p&&(s=p-1),n=e>s,h=o?p?n?[s,e+1]:[e,s+1]:[e]:(t.unset("position"),[s]),i=this.collection.slice.apply(this.collection,h),r.each(i,function(e){var i,r;return e.id!==t.id?(r=e.get("position"),i=!o||n?r-1:r+1,e.set("position",i)):void 0})},s.prototype._sendPositions=function(t){return i.post(this.reorderURL,{order:t.join(",")})},s}(n)})}).call(this);