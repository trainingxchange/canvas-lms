(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function o(){this.constructor=e}for(var s in n)t.call(n,s)&&(e[s]=n[s]);return o.prototype=n.prototype,e.prototype=new o,e.__super__=n.prototype,e};define(["i18n!course_settings","jquery","underscore","compiled/views/DialogBaseView","compiled/views/courses/roster/RosterDialogMixin","jst/courses/roster/EditSectionsView","jst/courses/roster/section","compiled/widget/ContextSearch","str/htmlEscape","compiled/jquery.rails_flash_notifications","jquery.disableWhileLoading"],function(t,o,s,i,r,c,u){var l,a;return l=function(i){function l(){return this.update=e(this.update,this),this.onNewToken=e(this.onNewToken,this),a=l.__super__.constructor.apply(this,arguments)}return n(l,i),l.mixin(r),l.prototype.events={"click #user_sections li a":"removeSection"},l.prototype.dialogOptions={id:"edit_sections",title:t.t("titles.section_enrollments","Section Enrollments")},l.prototype.render=function(){return this.$el.html(c({sectionsUrl:ENV.SEARCH_URL})),this.setupContextSearch(),this},l.prototype.setupContextSearch=function(){var e,n,o,i,r,c,l,a=this;for(this.$("#section_input").contextSearch({contexts:ENV.CONTEXTS,placeholder:t.t("edit_sections_placeholder","Enter a section name"),title:t.t("edit_sections_title","Section name"),onNewToken:this.onNewToken,added:function(e,t){return a.$("#user_sections").append(t)},selector:{baseData:{type:"section",context:"course_"+ENV.course.id+"_sections",exclude:s.map(this.model.sectionEditableEnrollments(),function(e){return"section_"+e.course_section_id})},noExpand:!0,browser:{data:{per_page:100,types:["section"],search_all_contexts:!0}}}}),this.input=this.$("#section_input").data("token_input"),this.input.$fakeInput.css("width","100%"),this.input.tokenValues=function(){var e,t,n,o,s;for(o=a.$("#user_sections input"),s=[],t=0,n=o.length;n>t;t++)e=o[t],s.push(e.value);return s},e=this.$("#user_sections"),c=this.model.sectionEditableEnrollments(),l=[],i=0,r=c.length;r>i;i++)n=c[i],l.push((o=ENV.CONTEXTS.sections[n.course_section_id])?e.append(u({id:o.id,name:o.name,role:n.role})):void 0);return l},l.prototype.onNewToken=function(e){var n,s;return n=e.find("a"),n.attr("href","#"),n.attr("title",t.t("remove_user_from_course_section","Remove user from %{course_section}",{course_section:e.find("div").attr("title")})),s=o('<span class="screenreader-only"></span>').append(t.t("remove_user_from_course_section","Remove user from %{course_section}",{course_section:e.find("div").attr("title")})),n.append(s)},l.prototype.update=function(e){var n,i,r,c,u,l,a,p,d,_,h,f,m,E,v,y,g=this;for(e.preventDefault(),u=this.model.findEnrollmentByRole(this.model.currentRole),n=s.map(this.model.sectionEditableEnrollments(),function(e){return e.course_section_id}),_=s.map(o("#user_sections").find("input"),function(e){return o(e).val().split("_")[1]}),d=s.reject(_,function(e){return s.include(n,e)}),p=[],r=[],m=0,v=d.length;v>m;m++)a=d[m],f="/api/v1/sections/"+a+"/enrollments",i={enrollment:{user_id:this.model.get("id"),type:u.type,limit_privileges_to_course_section:u.limit_priveleges_to_course_section}},u.role!==u.type&&(i.enrollment.role=u.role),r.push(o.ajaxJSON(f,"POST",i,function(e){return p.push(e)}));for(h=s.difference(n,_),l=s.filter(this.model.sectionEditableEnrollments(),function(e){return s.include(h,e.course_section_id)}),E=0,y=l.length;y>E;E++)c=l[E],f=""+ENV.COURSE_ROOT_URL+"/unenroll/"+c.id,r.push(o.ajaxJSON(f,"DELETE"));return this.disable(o.when.apply(o,r).done(function(){return g.updateEnrollments(p,l),o.flashMessage(t.t("flash.sections","Section enrollments successfully updated"))}).fail(function(){return o.flashError(t.t("flash.sectionError","Something went wrong updating the user's sections. Please try again later."))}).always(function(){return g.close()}))},l.prototype.removeSection=function(e){var t;return e.preventDefault(),t=o(e.currentTarget).closest("li"),t.closest("ul").children().length>1&&t.remove(),this.input.$input.focus()},l}(i)})}).call(this);