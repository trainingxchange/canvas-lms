(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,o=function(t,o){function n(){this.constructor=t}for(var i in o)e.call(o,i)&&(t[i]=o[i]);return n.prototype=o.prototype,t.prototype=new n,t.__super__=o.prototype,t};define(["i18n!discussions","jquery","compiled/arr/walk","Backbone","jst/discussions/EntryCollectionView","jst/discussions/entryStats","compiled/views/DiscussionTopic/EntryView"],function(e,n,i,s,r,l,d){var h,a,p;return a=s.View,h=function(s){function h(){return this.add=t(this.add,this),this.addAll=t(this.addAll,this),p=h.__super__.constructor.apply(this,arguments)}return o(h,s),h.prototype.defaults={descendants:2,showMoreDescendants:2,showReplyButton:!1,displayShowMore:!0,threaded:!1,root:!1},h.prototype.events={"click .loadNext":"loadNextFromEvent"},h.prototype.template=r,h.prototype.els={".discussion-entries":"list"},h.prototype.initialize=function(){return h.__super__.initialize.apply(this,arguments),this.childViews=[]},h.prototype.attach=function(){return this.collection.on("reset",this.addAll),this.collection.on("add",this.add)},h.prototype.toJSON=function(){return this.options},h.prototype.addAll=function(){return this.teardown(),this.collection.each(this.add)},h.prototype.add=function(t){var e;return e=new d({model:t,treeView:this.constructor,descendants:this.options.descendants,children:this.collection.options.perPage,showMoreDescendants:this.options.showMoreDescendants,threaded:this.options.threaded,collapsed:this.options.collapsed}),e.render(),t.on("change:editor",this.nestEntries),t.get("new")?this.addNewView(e):(this.options.descendants?e.renderTree():t.hasChildren()&&e.renderDescendantsLink(),this.options.threaded||this.options.root?this.list.append(e.el):this.list.prepend(e.el),this.childViews.push(e),this.nestEntries())},h.prototype.nestEntries=function(){return n(".entry-content[data-should-position]").each(function(){var t,e,o;return t=n(this),e=t.parents("li.entry").length,o=30*(e-1),t.css("padding-left",o).removeAttr("data-should-position"),t.find(".discussion-title").attr({role:"heading","aria-level":e+1})})},h.prototype.addNewView=function(t){return t.model.set("new",!1),this.options.threaded||this.options.root?this.list.append(t.el):this.list.prepend(t.el),this.nestEntries(),this.options.root?void 0:(t.$el.hide(),setTimeout(function(){return t.$el.fadeIn()},500))},h.prototype.teardown=function(){return this.list.empty()},h.prototype.afterRender=function(){return h.__super__.afterRender.apply(this,arguments),this.addAll(),this.renderNextLink()},h.prototype.renderNextLink=function(){var t,o,i,s;return null!=(s=this.nextLink)&&s.remove(),this.options.displayShowMore&&this.unShownChildren()>0?(i=this.getUnshownStats(),this.nextLink=n("<div/>"),o=!0,this.options.threaded||(t=e.t("show_all_n_replies",{one:"Show one reply",other:"Show all %{count} replies"},{count:i.total+this.collection.options.perPage})),this.nextLink.html(l({stats:i,moreText:t,showMore:!0})),this.nextLink.addClass("showMore loadNext"),this.options.threaded?this.nextLink.insertAfter(this.list):this.nextLink.insertBefore(this.list)):void 0},h.prototype.getUnshownStats=function(){var t,e,o,n,s;return e=this.collection.length,t=this.collection.fullCollection.length,s=this.collection.fullCollection.toJSON().slice(e,t),o=0,n=0,i(s,"replies",function(t){return o++,"unread"===t.read_state?n++:void 0}),{total:o,unread:n}},h.prototype.unShownChildren=function(){return this.collection.fullCollection.length-this.collection.length},h.prototype.loadNextFromEvent=function(t){return t.stopPropagation(),t.preventDefault(),this.loadNext()},h.prototype.loadNext=function(){return this.options.threaded?this.collection.add(this.collection.fullCollection.getPage("next")):this.collection.reset(this.collection.fullCollection.toArray()),this.renderNextLink()},h.prototype.filter=h.prototype.afterRender,h}(a)})}).call(this);