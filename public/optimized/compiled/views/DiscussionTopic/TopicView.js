(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,i=function(t,i){function o(){this.constructor=t}for(var s in i)e.call(i,s)&&(t[s]=i[s]);return o.prototype=i.prototype,t.prototype=new o,t.__super__=i.prototype,t};define(["i18n!discussions","jquery","Backbone","underscore","compiled/models/DiscussionTopic","compiled/views/DiscussionTopic/EntriesView","compiled/views/DiscussionTopic/EntryView","compiled/views/PublishButtonView","jst/discussions/_reply_form","compiled/discussions/Reply","compiled/widget/assignmentRubricDialog","compiled/util/wikiSidebarWithMultipleEditors","jquery.instructure_misc_helpers","str/htmlEscape"],function(e,o,s,r,n,u,c,p,a,d,l,h){var b,y;return b=function(s){function r(){return this.handleKeyDown=t(this.handleKeyDown,this),this.subscriptionStatusChanged=t(this.subscriptionStatusChanged,this),this.hideIfFiltering=t(this.hideIfFiltering,this),y=r.__super__.constructor.apply(this,arguments)}return i(r,s),r.prototype.events={"click #discussion_topic .discussion-reply-action[data-event]":"handleEvent","click .add_root_reply":"addRootReply","click .discussion_locked_toggler":"toggleLocked","click .toggle_due_dates":"toggleDueDates","click .rte_switch_views_link":"toggleEditorMode","click .topic-subscribe-button":"subscribeTopic","click .topic-unsubscribe-button":"unsubscribeTopic","click .mark_all_as_read":"markAllAsRead","click .mark_all_as_unread":"markAllAsUnread"},r.prototype.els={".add_root_reply":"$addRootReply",".topic .discussion-entry-reply-area":"$replyLink",".due_date_wrapper":"$dueDates",".reply-textarea:first":"$textarea","#discussion-toolbar":"$discussionToolbar",".topic-subscribe-button":"$subscribeButton",".topic-unsubscribe-button":"$unsubscribeButton"},r.prototype.initialize=function(){var t=this;return r.__super__.initialize.apply(this,arguments),this.model.set("id",ENV.DISCUSSION.TOPIC.ID),this.model.cid="main",this.model.set("canAttach",ENV.DISCUSSION.PERMISSIONS.CAN_ATTACH),this.filterModel=this.options.filterModel,this.filterModel.on("change",this.hideIfFiltering),this.topic=new n({id:ENV.DISCUSSION.TOPIC.ID}),this.topic.url=ENV.DISCUSSION.ROOT_URL.replace(/\/view/m,""),this.topic.set("subscribed",ENV.DISCUSSION.TOPIC.IS_SUBSCRIBED),c.on("addReply",function(){return t.setSubscribed(!0)}),o(window).on("keydown",this.handleKeyDown)},r.prototype.hideIfFiltering=function(){return this.filterModel.hasFilter()?this.$replyLink.addClass("hidden"):this.$replyLink.removeClass("hidden")},r.prototype.afterRender=function(){var t;return r.__super__.afterRender.apply(this,arguments),o(document.body).is(".with-right-side")&&o.scrollSidebar(),l.initTriggers(),this.$el.toggleClass("side_comment_discussion",!ENV.DISCUSSION.THREADED),this.subscriptionStatusChanged(),(t=this.$("#topic_publish_button"))?(this.topic.set({unpublishable:ENV.DISCUSSION.TOPIC.CAN_UNPUBLISH,published:ENV.DISCUSSION.TOPIC.IS_PUBLISHED}),new p({model:this.topic,el:t}).render()):void 0},r.prototype.filter=r.prototype.afterRender,r.prototype.toggleLocked=function(t){var e;return e=o(t.currentTarget).data("mark-locked"),this.topic.save({locked:e}).done(function(){return window.location.reload()})},r.prototype.toggleDueDates=function(t){return t.preventDefault(),this.$dueDates.toggleClass("hidden"),o(t.currentTarget).text(this.$dueDates.hasClass("hidden")?e.t("show_due_dates","Show Due Dates"):e.t("hide_due_dates","Hide Due Dates"))},r.prototype.toggleEditorMode=function(t){return t.preventDefault(),t.stopPropagation(),this.$textarea.editorBox("toggle"),o(t.currentTarget).siblings(".rte_switch_views_link").andSelf().toggle()},r.prototype.subscribeTopic=function(t){return t.preventDefault(),this.topic.topicSubscribe(),this.subscriptionStatusChanged(),this.$subscribeButton.is(":focus")?this.$unsubscribeButton.focus():void 0},r.prototype.unsubscribeTopic=function(t){return t.preventDefault(),this.topic.topicUnsubscribe(),this.subscriptionStatusChanged(),this.$unsubscribeButton.is(":focus")?this.$subscribeButton.focus():void 0},r.prototype.subscriptionStatusChanged=function(){var t;return t=this.topic.get("subscribed"),this.$discussionToolbar.removeClass("subscribed"),this.$discussionToolbar.removeClass("unsubscribed"),ENV.DISCUSSION.CAN_SUBSCRIBE?this.$discussionToolbar.addClass(t?"subscribed":"unsubscribed"):void 0},r.prototype.addReply=function(t){var e=this;return null!=t&&t.preventDefault(),null==this.reply&&(this.reply=new d(this,{topLevel:!0,focus:!0}),this.reply.on("edit",function(){var t;return null!=(t=e.$addRootReply)?t.hide():void 0}),this.reply.on("hide",function(){var t;return null!=(t=e.$addRootReply)?t.show():void 0}),this.reply.on("save",function(t){return ENV.DISCUSSION.CAN_SUBSCRIBE=!0,e.topic.set("subscription_hold",!1),e.setSubscribed(!0),e.trigger("addReply",t)})),this.model.set("notification",""),this.reply.edit()},r.prototype.setSubscribed=function(){return this.topic.set("subscribed",!0),this.subscriptionStatusChanged()},r.prototype.addReplyAttachment=c.prototype.addReplyAttachment,r.prototype.removeReplyAttachment=c.prototype.removeReplyAttachment,r.prototype.handleEvent=function(t){var e,i;return e=o(t.currentTarget),i=e.data("event"),"function"==typeof this[i]?this[i](t,e):void 0},r.prototype.render=function(){var t,e;return ENV.DISCUSSION.PERMISSIONS.CAN_REPLY&&(e=this.model.toJSON(),e.showBoxReplyLink=!0,e.root=!0,t=a(e),this.$("#discussion_topic").append(t)),r.__super__.render.apply(this,arguments)},r.prototype.format=function(t,e){return"notification"===t?e:h(e)},r.prototype.addRootReply=function(t){var e;return e=o("#discussion_topic .discussion-reply-form"),this.addReply(t),o("html, body").animate({scrollTop:e.offset().top-100})},r.prototype.markAllAsRead=function(t){return t.preventDefault(),this.trigger("markAllAsRead")},r.prototype.markAllAsUnread=function(t){return t.preventDefault(),this.trigger("markAllAsUnread")},r.prototype.handleKeyDown=function(t){var e;return e=t.target.nodeName.toLowerCase(),"input"!==e&&"textarea"!==e&&78===t.which?(this.addRootReply(t),t.preventDefault(),t.stopPropagation()):void 0},r}(s.View)})}).call(this);