(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function s(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return s.prototype=n.prototype,e.prototype=new s,e.__super__=n.prototype,e};define(["jquery","underscore","i18n!discussions","compiled/discussions/MarkAsReadWatcher","compiled/arr/walk","Backbone","compiled/collections/EntryCollection","jst/discussions/_entry_content","jst/discussions/_deleted_entry","jst/discussions/entry_with_replies","jst/discussions/entryStats","compiled/discussions/Reply","compiled/discussions/EntryEditor","str/htmlEscape","vendor/jquery.ba-tinypubsub","compiled/str/convertApiUserContent","jst/_avatar","jst/discussions/_reply_form"],function(t,s,r,o,i,a,d,l,p,u,h,c,y,g,f,m){var _,v,w;return v=f.publish,_=function(a){function l(){return this.handleKeyDown=e(this.handleKeyDown,this),this.focus=e(this.focus,this),this.renderTree=e(this.renderTree,this),this.toggleDeleted=e(this.toggleDeleted,this),this.toggleReadState=e(this.toggleReadState,this),w=l.__super__.constructor.apply(this,arguments)}return n(l,a),l.instances={},l.collapseRootEntries=function(){return s.each(this.instances,function(e){return e.model.get("parent")?void 0:e.collapse()})},l.expandRootEntries=function(){return s.each(this.instances,function(e){return e.model.get("parent")?void 0:e.expand()})},l.setAllReadState=function(e){return s.each(this.instances,function(t){return t.model.set("read_state",e)})},l.prototype.els={".discussion_entry:first":"$entryContent",".replies:first":"$replies",".headerBadges:first":"$headerBadges",".discussion-read-state-btn:first":"$readStateToggle"},l.prototype.events={"click .loadDescendants":"loadDescendants","click [data-event]":"handleDeclarativeEvent",keydown:"handleKeyDown"},l.prototype.defaults={treeView:null,descendants:2,children:5,showMoreDescendants:2},l.prototype.template=u,l.prototype.tagName="li",l.prototype.className="entry",l.prototype.initialize=function(){return l.__super__.initialize.apply(this,arguments),this.constructor.instances[this.cid]=this,this.$el.attr("id","entry-"+this.model.get("id")),this.model.on("change:deleted",this.toggleDeleted),this.model.on("change:read_state",this.toggleReadState),this.model.on("change:editor",this.render),this.model.on("change:editor",function(e){return e.trigger("edited")})},l.prototype.toggleRead=function(e){return e.preventDefault(),"read"===this.model.get("read_state")?this.model.markAsUnread():this.model.markAsRead(),l.trigger("readStateChanged",this.model,this)},l.prototype.handleDeclarativeEvent=function(e){var n,s;return n=t(e.currentTarget),s=n.data("event"),this.bypass(e)?void 0:(e.stopPropagation(),e.preventDefault(),this[s](e,n))},l.prototype.bypass=function(e){var n,s,r;return s=t(e.target),null!=s.data("bypass")?!0:(n=t(e.target).closest(".admin-links").length,r=t(e.target).data("event"),n&&!r?!0:!1)},l.prototype.toJSON=function(){var e;return e=this.model.attributes,e.edited_at=t.datetimeString(e.updated_at),e.editor?(e.editor_name=e.editor.display_name,e.editor_href='href="'+e.editor.html_url+'"'):(e.editor_name=r.t("unknown","Unknown"),e.editor_href=""),e},l.prototype.toggleReadState=function(e,t){return this.setToggleTooltip(),this.$entryContent.toggleClass("unread","unread"===t),this.$entryContent.toggleClass("read","read"===t)},l.prototype.toggleCollapsed=function(){return this.addedCountsToHeader||this.addCountsToHeader(),this.$el.toggleClass("collapsed")},l.prototype.expand=function(){return this.$el.removeClass("collapsed")},l.prototype.collapse=function(){return this.addedCountsToHeader||this.addCountsToHeader(),this.$el.addClass("collapsed")},l.prototype.addCountsToHeader=function(){var e,t;return t=this.countPosterity(),e="<div class='new-and-total-badge'>\n  <span class=\"new-items\">"+t.unread+'</span>\n  <span class="total-items">'+t.total+"</span>\n</div>",this.$headerBadges.append(h({stats:t})),this.addedCountsToHeader=!0},l.prototype.toggleDeleted=function(e,t){return this.$entryContent.toggleClass("deleted-discussion-entry",t),t?(this.model.set("updated_at",(new Date).toISOString()),this.model.set("editor",ENV.current_user)):void 0},l.prototype.setToggleTooltip=function(){var e;return e="unread"===this.model.get("read_state")?r.t("mark_as_read","Mark as Read"):r.t("mark_as_unread","Mark as Unread"),this.$readStateToggle.attr("title",e)},l.prototype.afterRender=function(){var e;return l.__super__.afterRender.apply(this,arguments),this.options.collapsed&&this.collapse(),this.setToggleTooltip(),"unread"!==this.model.get("read_state")||this.model.get("forced_read_state")||ENV.DISCUSSION.MANUAL_MARK_AS_READ||(null==(e=this.readMarker)&&(this.readMarker=new o(this)),o.checkForVisibleEntries()),v("userContent/change")},l.prototype.filter=l.prototype.afterRender,l.prototype.renderTree=function(e){var t,n,s,r,o,i;return null==e&&(e={}),null==this.treeView?(i=this.model.get("replies"),r=(e.descendants||this.options.descendants)-1,n=e.children||this.options.children,s=new d(i,{perPage:n}),t=s.map(function(e){return e.attributes}),this.model.set("replies",t),o=s.getPageAsCollection(0),this.treeView=new this.options.treeView({el:this.$replies[0],descendants:r,collection:o,threaded:this.options.threaded,showMoreDescendants:this.options.showMoreDescendants}),this.treeView.render()):void 0},l.prototype.renderDescendantsLink=function(){var e;return e=this.countPosterity(),this.descendantsLink=t("<div/>"),this.descendantsLink.html(h({stats:e,showMore:!0})),this.descendantsLink.addClass("showMore loadDescendants"),this.$replies.append(this.descendantsLink)},l.prototype.countPosterity=function(){var e;return e={unread:0,total:0},null==this.model.attributes.replies?e:(i(this.model.attributes.replies,"replies",function(t){return"unread"===t.read_state&&e.unread++,e.total++}),e)},l.prototype.loadDescendants=function(e){return e.stopPropagation(),e.preventDefault(),this.renderTree({children:this.options.children,descendants:this.options.showMoreDescendants})},l.prototype.remove=function(){var e;if(this.model.canModerate())return confirm(r.t("are_your_sure_delete","Are you sure you want to delete this entry?"))?(this.model.set("deleted",!0),this.model.destroy(),e=p(this.toJSON()),this.$(".entry-content:first").html(e)):void 0},l.prototype.edit=function(){var e,t=this;if(this.model.canModerate())return null==(e=this.editor)&&(this.editor=new y(this)),this.editor.editing||this.editor.edit(),this.editor.on("display",function(){return setTimeout(t.focus,0)})},l.prototype.focus=function(){return this.$(".author").first().focus()},l.prototype.addReply=function(){var e,t=this;return null==(e=this.reply)&&(this.reply=new c(this,{focus:!0})),this.model.set("notification",""),this.reply.edit(),this.reply.on("save",function(e){return t.renderTree(),t.treeView.collection.add(e),t.treeView.collection.fullCollection.add(e),t.model.get("replies").push(e.attributes),t.trigger("addReply"),l.trigger("addReply",e)})},l.prototype.addReplyAttachment=function(e,t){return e.preventDefault(),this.reply.addAttachment(t)},l.prototype.removeReplyAttachment=function(e,t){return e.preventDefault(),this.reply.removeAttachment(t)},l.prototype.format=function(e,t){return"message"===e?(t=m(t),this.$el.find(".message").removeClass("enhanced"),v("userContent/change"),t):"notification"===e?t:g(t)},l.prototype.handleKeyDown=function(e){var t;if(t=e.target.nodeName.toLowerCase(),"input"!==t&&"textarea"!==t){if(68===e.which)this.remove();else if(69===e.which)this.edit();else{if(82!==e.which)return;this.addReply()}return e.preventDefault(),e.stopPropagation()}},l}(a.View),s.extend(_,a.Events)})}).call(this);