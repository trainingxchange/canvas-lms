(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};define(["underscore","jquery","jst/DiscussionTopics/pageNav","Backbone","compiled/views/DiscussionTopic/EntryCollectionView","compiled/jquery/scrollIntoView","underscore.flattenObjects"],function(e,r,o,i,s){var a,l;return a=function(i){function a(){return this.handleKeyDown=t(this.handleKeyDown,this),this.render=t(this.render,this),this.goToEntry=t(this.goToEntry,this),this.addEntry=t(this.addEntry,this),this.hideIfFiltering=t(this.hideIfFiltering,this),l=a.__super__.constructor.apply(this,arguments)}return n(a,i),a.prototype.defaults={initialPage:0,descendants:2,showMoreDescendants:50,children:3},a.prototype.$window=r(window),a.prototype.events={keydown:"handleKeyDown"},a.prototype.initialize=function(){return a.__super__.initialize.apply(this,arguments),this.collection.on("add",this.addEntry),this.model.on("change",this.hideIfFiltering)},a.prototype.hideIfFiltering=function(){return this.model.hasFilter()?this.$el.addClass("hidden"):this.$el.removeClass("hidden")},a.prototype.addEntry=function(t){return this.collectionView.collection.add(t)},a.prototype.goToEntry=function(t){var e,n;return"object"==typeof t&&(n=t,t=n.entry.id),e=r("#entry-"+t),e.length?this.scrollToEl(e):(null==n&&(n=this.collection.getEntryData(t)),this.collection.currentPage===n.page?0===n.levels?this.expandToUnrenderedEntry(n):this.descendToUnrenderedEntry(n):this.renderAndGoToEntry(n))},a.prototype.expandToUnrenderedEntry=function(t){var e,n,o;for(n=t.entry,e={};!e.length;)n=n.parent,e=r("#entry-"+n.id);return o=e.data("view"),o.treeView?o.treeView.loadNext():o.renderTree(),this.goToEntry(t)},a.prototype.descendToUnrenderedEntry=function(t){var n,o,i,s,a,l,d;for(s=t.entry,a=s,i=-1,n={};!n.length;)o=a,a=o.parent,i++,l=e.without(a.replies,o),l.unshift(o),a.replies=l,n=r("#entry-"+o.id);return d=n.data("view"),d.renderTree({descendants:i}),this.goToEntry(t)},a.prototype.renderAndGoToEntry=function(t){return this.render(t.page+1),this.goToEntry(t)},a.prototype.scrollToEl=function(t){var e=this;return this.$window.scrollTo(t,200,{offset:-150,onAfter:function(){var n;return t.find(".discussion-title a").first().focus(),setTimeout(function(){return t.addClass("highlight")},200),setTimeout(function(){return t.removeClass("highlight")},400),setTimeout(function(){return t.addClass("highlight")},600),n=function(){return t.removeClass("highlight"),e.$window.off("scroll",n),e.trigger("scrollAwayFromEntry")},setTimeout(function(){return e.$window.on("scroll",n),setTimeout(n,5e3)},10)}})},a.prototype.render=function(t){return null==t&&(t=1),this.teardown(),this.collectionView=new s({el:this.$el[0],collection:this.collection.getPageAsCollection(t-1,{perPage:this.options.children}),descendants:this.options.descendants,showMoreDescendants:this.options.showMoreDescendants,displayShowMore:!1,threaded:this.options.threaded,root:!0,collapsed:this.model.get("collapsed")}),this.collectionView.render(),this.renderPageNav(),this},a.prototype.teardown=function(){return this.$el.empty()},a.prototype.renderPageNav=function(){var t,e,n,r,i,s;return i=this.collection.totalPages(),t=this.collection.currentPage+1,2>i?void 0:(r=3,n={current:t},n.showFirst=i>r&&1!==t,i>r&&t!==i&&(n.lastPage=i),n.pages=r+1>i?function(){s=[];for(var t=1;i>=1?i>=t:t>=i;i>=1?t++:t--)s.push(t);return s}.apply(this):n.showFirst&&n.lastPage?[t-1,t,t+1]:n.showFirst&&!n.lastPage?[t-2,t-1,t]:!n.showFirst&&n.lastPage?[t,t+1,t+2]:void 0,e=o(n),this.$el.prepend(e).append(e))},a.prototype.handleKeyDown=function(t){var e,n,o;return n=t.target.nodeName.toLowerCase(),"input"===n||"textarea"===n||74!==t.which&&75!==t.which?void 0:(e=r(t.target).closest(".entry"),this.traverse(e,o=75===t.which),t.preventDefault(),t.stopPropagation())},a.prototype.traverse=function(t,n){var r,o,i,s,a,l,d;return i=t.attr("id").replace("entry-",""),s=this.collection.toJSON(),a=e.flattenObjects(s,"replies",r=!this.options.threaded),o=e.find(a,function(t){return t.id+""===i}),d=e.indexOf(a,o),d+=n?-1:1,d=Math.min(Math.max(0,d),a.length-1),l=a[d],this.goToEntry(l.id)},a}(i.View)})}).call(this);