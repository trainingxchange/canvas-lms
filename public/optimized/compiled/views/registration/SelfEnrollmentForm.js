(function(){var t=function(t,i){return function(){return t.apply(i,arguments)}},i={}.hasOwnProperty,n=function(t,n){function r(){this.constructor=t}for(var e in n)i.call(n,e)&&(t[e]=n[e]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};define(["jquery","underscore","Backbone","i18n!registration","compiled/registration/registrationErrors","jquery.instructure_forms","jquery.ajaxJSON"],function(i,r,e,o,s){var l,u;return l=function(r){function e(){return this.logOutAndRefresh=t(this.logOutAndRefresh,this),this.logOut=t(this.logOut,this),this.enroll=t(this.enroll,this),this.enrollErrors=t(this.enrollErrors,this),this.errorFormatter=t(this.errorFormatter,this),this.normalizeData=t(this.normalizeData,this),this.success=t(this.success,this),this.beforeSubmit=t(this.beforeSubmit,this),this.changeAction=t(this.changeAction,this),u=e.__super__.constructor.apply(this,arguments)}return n(e,r),e.prototype.events={"change input[name=initial_action]":"changeAction","click #logout_link":"logOutAndRefresh"},e.prototype.initialize=function(t){return this.options=null!=t?t:{},e.__super__.initialize.apply(this,arguments),this.enrollUrl=this.$el.attr("action"),this.action=this.initialAction=this.$el.find("input[type=hidden][name=initial_action]").val(),this.$el.formSubmit({beforeSubmit:this.beforeSubmit,success:this.success,errorFormatter:this.errorFormatter,disableWhileLoading:"spin_on_success"})},e.prototype.changeAction=function(t){return this.action=i(t.target).val(),this.$el.find(".user_info").hide(),this.$el.find("#"+this.action+"_user_info").show(),this.$el.find("#submit_button").css({visibility:"visible"})},e.prototype.beforeSubmit=function(t){return this.action?this.options.confirmEnrollmentUrl&&"enroll"===this.action?(window.location=this.options.confirmEnrollmentUrl,!1):(this.normalizeData(t),this.$el.attr("action",function(){switch(this.action){case"create":return"/users";case"log_in":return"/login";case"enroll":return this.enrollUrl}}.call(this))):!1},e.prototype.success=function(){var t;return"enroll"===this.action?(t=window.location.search,t=t?""+t+"&":"?",t+="enrolled=1","create"===this.initialAction&&(t+="&just_created=1"),window.location.search=t):this.enroll()},e.prototype.normalizeData=function(t){var i,n;return"log_in"===this.action&&(t["pseudonym_session[unique_id]"]=null!=(i=t["pseudonym[unique_id]"])?i:"",t["pseudonym_session[password]"]=null!=(n=t["pseudonym[password]"])?n:""),t},e.prototype.errorFormatter=function(t){var i;return i=function(){switch(this.action){case"create":return s(t);case"log_in":return this.loginErrors(t);case"enroll":return this.enrollErrors(s(t))}}.call(this)},e.prototype.loginErrors=function(t){var i;return t=t.base,i=t[t.length-1].message,{"pseudonym[password]":i}},e.prototype.enrollErrors=function(t){var i;return t["user[self_enrollment_code]"]&&(null==(i=t["pseudonym[unique_id]"])&&(t["pseudonym[unique_id]"]=[]),t["pseudonym[unique_id]"].push(t["user[self_enrollment_code]"][0]),delete t["user[self_enrollment_code]"]),this.action=this.initialAction,this.logOut(),t},e.prototype.enroll=function(){return this.action="enroll",this.$el.submit()},e.prototype.logOut=function(t){return null==t&&(t=!1),i.ajaxJSON("/logout","DELETE",{},function(){return t?location.reload(!0):void 0})},e.prototype.logOutAndRefresh=function(t){return t.preventDefault(),this.logOut(!0)},e}(e.View)})}).call(this);