(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,o=function(t,o){function s(){this.constructor=t}for(var i in o)e.call(o,i)&&(t[i]=o[i]);return s.prototype=o.prototype,t.prototype=new s,t.__super__=o.prototype,t};define(["Backbone","jquery","i18n!context_modules","jquery.loadingImg"],function(e,s,i){var r,n;return r=function(e){function r(){return this.onKeyDown=t(this.onKeyDown,this),this.error=t(this.error,this),this.success=t(this.success,this),this.toggleWorkflowState=t(this.toggleWorkflowState,this),n=r.__super__.constructor.apply(this,arguments)}return o(r,e),r.optionProperty("modules"),r.prototype.toggleWorkflowState=function(t){var e,o,i=this;return t.preventDefault(),this.$context_module=s(t.target).parents(".context_module"),e=this.$context_module.data("module-url"),this.workflow_state=this.$context_module.data("workflow-state"),o={url:e,type:"PUT",beforeSend:function(){return i.$context_module.loadingImage()},success:this.success,error:this.error},this.setRequestPublishOptions(o),s.ajax(o)},r.prototype.success=function(t){return this.$context_module.data("workflow-state",t.context_module.workflow_state),"unpublished"===t.context_module.workflow_state?this.addUnpublishAttributes():this.addPublishAttributes(),this.$context_module.loadingImage("remove")},r.prototype.error=function(){return alert("This module could not be published"),this.$context_module.loadingImage("remove")},r.prototype.setRequestPublishOptions=function(t){return t.data="active"===this.workflow_state?"unpublish=1":"publish=1"},r.prototype.addUnpublishAttributes=function(){return this.$context_module.find(".workflow-state-action").text(i.t("context_modules.publish","Publish")),this.$context_module.find(".workflow-state-icon").addClass("publish-module-link").removeClass("unpublish-module-link"),this.$context_module.find(".draft-text").removeClass("hide"),this.$context_module.addClass("unpublished_module")},r.prototype.addPublishAttributes=function(){return this.$context_module.find(".workflow-state-action").text(i.t("context_module.unpublish","Unpublish")),this.$context_module.find(".workflow-state-icon").addClass("unpublish-module-link").removeClass("publish-module-link"),this.$context_module.find(".draft-text").addClass("hide"),this.$context_module.removeClass("unpublished_module")},r.prototype.keyCodes={32:"Space",38:"UpArrow",40:"DownArrow"},r.prototype.moduleSelector="div.context_module",r.prototype.itemSelector="table.context_module_item",r.prototype.initialize=function(){return r.__super__.initialize.apply(this,arguments),this.$contextModules=s("#context_modules"),this.$contextModules.parent().on("keydown",this.onKeyDown)},r.prototype.onKeyDown=function(t){var e,o;return e=s(t.target),o="on"+this.keyCodes[t.keyCode]+"Key",this[o]?(t.preventDefault(),this[o].call(this,t,e)):void 0},r.prototype.getFocusedElement=function(t){var e;return e=t.parents(this.itemSelector).first(),this.empty(e)||(t=e),t.is(this.itemSelector)||(e=t.parents(this.moduleSelector).first(),this.empty(e)||(t=e),t.is(this.moduleSelector)||(t=this.$contextModules)),t},r.prototype.onUpArrowKey=function(t,e){var o,s,i;return o=this.getFocusedElement(e),o.is(this.itemSelector)?(i=o.prev(this.itemSelector),(this.empty(i)||this.$contextModules.data("dragModule"))&&(i=o.parents(this.moduleSelector).first())):o.is(this.moduleSelector)&&(this.$contextModules.data("dragItem")?i=this.$contextModules.data("dragItemModule"):(i=o.prev(this.moduleSelector),this.empty(i)?i=this.$contextModules:this.$contextModules.data("dragModule")||(s=i.find(this.itemSelector).last(),this.empty(s)||(i=s)))),i&&!this.empty(i)?i.focus():void 0},r.prototype.onDownArrowKey=function(t,e){var o,s,i;return o=this.getFocusedElement(e),o.is(this.itemSelector)?(s=o.next(this.itemSelector),this.empty(s)&&!this.$contextModules.data("dragItem")&&(i=o.parents(this.moduleSelector).first(),s=i.next(this.moduleSelector))):o.is(this.moduleSelector)?(s=o.find(this.itemSelector).first(),(this.empty(s)||this.$contextModules.data("dragModule"))&&(s=o.next(this.moduleSelector))):s=this.$contextModules.find(this.moduleSelector).first(),s&&!this.empty(s)?s.focus():void 0},r.prototype.onSpaceKey=function(t,e){var o,s,i,r;return i=this.getFocusedElement(e),(o=this.$contextModules.data("dragItem"))?(i.is(o)||(r=this.$contextModules.data("dragItemModule"),i.is(this.itemSelector)&&!this.empty(i.parents(r))?i.after(o):r.find(".items").prepend(o),modules.updateModuleItemPositions(null,{item:o.parent()})),o.attr("aria-grabbed",!1),this.$contextModules.data("dragItem",null),this.$contextModules.data("dragItemModule",null),o.focus()):(s=this.$contextModules.data("dragModule"))?(i.is(this.itemSelector)&&(i=i.parents(this.moduleSelector).first()),i.is(s)||(this.empty(i)||i.is(this.$contextModules)?this.$contextModules.prepend(s):i.after(s),modules.updateModulePositions()),s.attr("aria-grabbed",!1),this.$contextModules.data("dragModule",null),s.focus()):i.is(this.$contextModules)?void 0:(i.attr("aria-grabbed",!0),i.is(this.itemSelector)?(this.$contextModules.data("dragItem",i),this.$contextModules.data("dragItemModule",i.parents(this.moduleSelector).first())):i.is(this.moduleSelector)&&this.$contextModules.data("dragModule",i),i.blur(),i.focus())},r.prototype.empty=function(t){return 0===t.length},r}(e.View)})}).call(this);