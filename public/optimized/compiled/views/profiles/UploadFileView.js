(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,r=function(e,r){function o(){this.constructor=e}for(var i in r)t.call(r,i)&&(e[i]=r[i]);return o.prototype=r.prototype,e.prototype=new o,e.__super__=r.prototype,e};define(["underscore","compiled/views/profiles/AvatarUploadBaseView","jst/profiles/uploadFileView","compiled/util/BlobFactory","vendor/jquery.jcrop"],function(t,o,i,n){var a,p;return a=function(o){function a(){return this.saveCropPosition=e(this.saveCropPosition,this),this.loadPreview=e(this.loadPreview,this),p=a.__super__.constructor.apply(this,arguments)}return r(a,o),a.optionProperty("avatarSize"),a.prototype.template=i,a.prototype.events={"click .select-photo-link":"onChooseAvatar","change #selected-photo":"onSelectAvatar","dragover .select-photo-link":"onDragOver","dragleave .select-photo-link":"onDragLeave","drop .select-photo-link":"onFileDrop"},a.prototype.onChooseAvatar=function(e){return e.preventDefault(),this.openFileDialog()},a.prototype.onSelectAvatar=function(e){return e.preventDefault(),this.loadPreview(e.target.files[0])},a.prototype.onDragLeave=function(){return this.toggleOverStyle(!1)},a.prototype.onDragOver=function(e){return e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy",this.toggleOverStyle(!0)},a.prototype.onFileDrop=function(e){return e.stopPropagation(),e.preventDefault(),this.loadPreview(e.originalEvent.dataTransfer.files[0])},a.prototype.openFileDialog=function(){return this.$("#selected-photo").click()},a.prototype.toggleOverStyle=function(e){return this.$(".select-photo-link").toggleClass("over",e)},a.prototype.loadPreview=function(e){var t,r,o=this;return e.type.match(/^image/)?(t=$.Deferred(),r=new FileReader,r.onload=function(e){return o.showPreview(e.target.result),t.resolve(e.target.result)},r.readAsDataURL(e),t):(alert("Invalid file type."),!1)},a.prototype.showPreview=function(e){return e.match(/^data:image/)?(this.preview=e,this.render(),this.initCropping()):(alert("Invalid file."),!1)},a.prototype.hidePreview=function(){return delete this.preview,this.render()},a.prototype.render=function(){return this.revokeURLObjects(),a.__super__.render.apply(this,arguments)},a.prototype.teardown=function(){return this.hidePreview(),this.revokeURLObjects()},a.prototype.revokeURLObjects=function(){return this.$("img").each(function(){var e,t;return e=$(this).attr("src"),e.match(/^data/)&&"function"==typeof(t=window.URL).revokeObjectURL?t.revokeObjectURL(e):void 0})},a.prototype.imageDimensions=function(e,t){var r,o,i;return o=t.height()/e.height(),i=t.width()/e.width(),r={heightRatio:o,widthRatio:i,x:Math.floor(this.currentCoords.x*i),y:Math.floor(this.currentCoords.y*o),w:Math.floor(this.currentCoords.w*i),h:Math.floor(this.currentCoords.h*o)}},a.prototype.getImage=function(){var e,t,r,o,i,a;return t=this.$(".avatar-preview"),e=this.$("#upload-fullsize-preview"),r=this.$("#upload-canvas")[0],o=r.getContext("2d"),i=this.imageDimensions(t,e),a=$.Deferred(),o.drawImage(e[0],i.x,i.y,i.w,i.h,0,0,this.avatarSize.w,this.avatarSize.h),a.resolve(n.fromCanvas(r,"image/jpeg"))},a.prototype.initCropping=function(){var e,r=this;return e=setInterval(function(){var o,i;return o=r.$(".avatar-preview"),o[0].complete?(clearInterval(e),i=t.min([o.height(),o.width()]),o.Jcrop({aspectRatio:1,setSelect:[0,0,i,i],onSelect:r.saveCropPosition,minSize:[20,20]}),r.trigger("ready")):void 0},50)},a.prototype.saveCropPosition=function(e){return this.currentCoords=e},a.prototype.toJSON=function(){return{hasPreview:!!this.preview,previewURL:this.preview}},a}(o)})}).call(this);