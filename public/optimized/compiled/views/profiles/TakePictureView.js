(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,i=function(e,i){function r(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return r.prototype=i.prototype,e.prototype=new r,e.__super__=i.prototype,e};define(["jquery","underscore","compiled/views/profiles/AvatarUploadBaseView","jst/profiles/takePictureView","compiled/util/BlobFactory"],function(t,r,o,a,n){var p,s;return p=function(o){function p(){return this.displayMedia=e(this.displayMedia,this),s=p.__super__.constructor.apply(this,arguments)}return i(p,o),p.optionProperty("avatarSize"),p.prototype.template=a,p.prototype.events={"click .take-snapshot-btn":"onSnapshot","click .retry-snapshot-btn":"onRetry"},p.prototype.els={".webcam-live-preview":"$video",".webcam-clip":"$clip",".webcam-preview":"$preview",".webcam-capture-wrapper":"$captureWrapper",".webcam-preview-wrapper":"$previewWrapper",".webcam-preview-staging-area":"$canvas"},p.prototype.getUserMedia=(navigator.getUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.webkitGetUserMedia||t.noop).bind(navigator),p.prototype.setup=function(){return this.startMedia()},p.prototype.teardown=function(){var e;return delete this.img,delete this.preview,null!=(e=this.stream)?e.stop():void 0},p.prototype.startMedia=function(){return this.getUserMedia({video:!0},this.displayMedia,t.noop)},p.prototype.displayMedia=function(e){return this.stream=e,this.$video.removeClass("pending"),this.$video.attr("src",window.URL.createObjectURL(this.stream)),this.$video.on("onloadedmetadata loadedmetadata",r.once(this.onMediaMetadata).bind(this))},p.prototype.onMediaMetadata=function(){var e,t=this;return e=window.setInterval(function(){var i,o;if(0!==t.$video[0].videoHeight)return window.clearInterval(e),o=r.min([t.$video.height(),t.$video.width()]),t.$clip.height(o).width(o),t.$video.width()>o?(i=(t.$video.width()-o)/2*-1,t.$video.css("left",i)):void 0},100)},p.prototype.toggleView=function(){return this.$captureWrapper.toggle(),this.$previewWrapper.toggle(),this.trigger("ready",!!this.preview)},p.prototype.getImage=function(){var e;return e=t.Deferred(),e.resolve(this.img)},p.prototype.onSnapshot=function(){var e,t,i,r,o,a=this;return e=this.$canvas[0],o=this.$video[0],i=new Image,t=e.getContext("2d"),e.height=o.clientHeight,e.width=o.clientWidth,t.drawImage(o,0,0,e.width,e.height),r=e.toDataURL(),i.onload=function(){var r,p;return r=(o.clientWidth-a.$clip.width())/2,p=(o.clientHeight-a.$clip.height())/2,e.height=a.$clip.height(),e.width=a.$clip.width(),t.drawImage(i,r,p,a.$clip.width(),a.$clip.height(),0,0,a.$clip.width(),a.$clip.height()),a.preview=e.toDataURL(),a.toggleView(),a.$preview.attr("src",a.preview),a.img=n.fromCanvas(e)},i.src=r},p.prototype.onRetry=function(){return this.resetSnapshot()},p.prototype.resetSnapshot=function(){return delete this.preview,delete this.img,this.toggleView()},p.prototype.previewSrc=function(){return this.preview?this.preview.split(",")[1]:""},p.prototype.toJSON=function(){return{hasPreview:!!this.preview,previewURL:this.preview}},p}(o)})}).call(this);