(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,i=function(e,i){function n(){this.constructor=e}for(var r in i)t.call(i,r)&&(e[r]=i[r]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e};define(["jquery","underscore","Backbone","wikiSidebar","jst/wiki/WikiPageEdit","compiled/views/ValidatedFormView","compiled/views/wiki/WikiPageDeleteDialog","compiled/views/wiki/WikiPageReloadView","i18n!pages","compiled/tinymce","tinymce.editor_box"],function(t,n,r,o,a,s,u,l,d){var c,h;return c=function(r){function s(){return this.onUnload=e(this.onUnload,this),h=s.__super__.constructor.apply(this,arguments)}return i(s,r),s.mixin({els:{'[name="body"]':"$wikiPageBody",".header-bar-outer-container":"$headerBarOuterContainer",".page-changed-alert":"$pageChangedAlert"},events:{"click a.switch_views":"switchViews","click .delete_page":"deleteWikiPage","click .form-actions .cancel":"cancel"}}),s.prototype.template=a,s.prototype.className="form-horizontal edit-form validated-form-view",s.prototype.dontRenableAfterSaveSuccess=!0,s.optionProperty("wiki_pages_path"),s.optionProperty("WIKI_RIGHTS"),s.optionProperty("PAGE_RIGHTS"),s.prototype.initialize=function(){var e=this;return s.__super__.initialize.apply(this,arguments),this.WIKI_RIGHTS||(this.WIKI_RIGHTS={}),this.PAGE_RIGHTS||(this.PAGE_RIGHTS={}),this.on("success",function(){return window.location.href=e.model.get("html_url")})},s.prototype.toJSON=function(){var e,t,i;return i=s.__super__.toJSON.apply(this,arguments),i.IS=e={TEACHER_ROLE:!1,STUDENT_ROLE:!1,MEMBER_ROLE:!1,ANYONE_ROLE:!1},t=i.editing_roles||"",t=n.map(t.split(","),function(e){return e.trim()}),n.contains(t,"public")?e.ANYONE_ROLE=!0:n.contains(t,"members")?e.MEMBER_ROLE=!0:n.contains(t,"students")?e.STUDENT_ROLE=!0:e.TEACHER_ROLE=!0,i.CAN={PUBLISH:!!this.WIKI_RIGHTS.manage&&"courses"===i.contextName,DELETE:!!this.PAGE_RIGHTS["delete"],EDIT_TITLE:!!this.PAGE_RIGHTS.update||i.new_record,EDIT_ROLES:!!this.WIKI_RIGHTS.manage},i.SHOW={COURSE_ROLES:"courses"===i.contextName},i},s.prototype.onUnload=function(e){var t;return this&&this.checkUnsavedOnLeave&&this.hasUnsavedChanges()?(t=this.unsavedWarning(),(e||window.event).returnValue=t,t):void 0},s.prototype.afterRender=function(){var e,i=this;return s.__super__.afterRender.apply(this,arguments),this.$wikiPageBody.editorBox(),this.initWikiSidebar(),this.checkUnsavedOnLeave=!0,e=this,window.addEventListener("beforeunload",this.onUnload),this.firstRender||(this.firstRender=!0,t(function(){return t("[autofocus]:not(:focus)").eq(0).focus()})),this.reloadPending=!1,this.reloadView=new l({el:this.$pageChangedAlert,model:this.model,reloadMessage:d.t("reload_editing_page","This page has changed since you started editing it. *Reloading* will lose all of your changes.",{wrapper:'<a class="reload" href="#">$1</a>'}),warning:!0}),this.reloadView.on("changed",function(){return i.$headerBarOuterContainer.addClass("page-changed"),i.reloadPending=!0}),this.reloadView.on("reload",function(){return i.render()}),this.reloadView.pollForChanges()},s.prototype.initWikiSidebar=function(){var e;return o.inited||(e=this.$wikiPageBody,t(function(){return o.init(),t.scrollSidebar(),o.attachToEditor(e).show()})),t(function(){return o.show()})},s.prototype.switchViews=function(e){return null!=e&&e.preventDefault(),this.$wikiPageBody.editorBox("toggle"),t(e.currentTarget).siblings("a").andSelf().toggle()},s.prototype.validateFormData=function(e){var t;return t={},""===e.title&&(t.title=[{type:"required",message:d.t("errors.require_title","You must enter a title")}]),t},s.prototype.hasUnsavedChanges=function(){var e,t,i,n;return t=this.toJSON(),e=this.$wikiPageBody.editorBox("is_dirty"),t.CAN.EDIT_TITLE&&(e||(e=(null!=(i=this.model.get("title"))?i:"")!==(null!=(n=this.getFormData().title)?n:""))),e},s.prototype.unsavedWarning=function(){return d.t("warnings.unsaved_changes","You have unsaved changes. Do you want to continue without saving these changes?")},s.prototype.submit=function(e){var t;return this.checkUnsavedOnLeave=!1,this.reloadPending&&!confirm(d.t("warnings.overwrite_changes","You are about to overwrite other changes that have been made since you started editing.\n\nOverwrite these changes?"))?void(null!=e&&e.preventDefault()):(null!=(t=this.reloadView)&&t.stopPolling(),s.__super__.submit.apply(this,arguments))},s.prototype.cancel=function(e){return null!=e&&e.preventDefault(),!this.hasUnsavedChanges()||confirm(this.unsavedWarning())?(this.checkUnsavedOnLeave=!1,this.trigger("cancel")):void 0},s.prototype.deleteWikiPage=function(e){var t;return null!=e&&e.preventDefault(),this.model.get("deletable")?(t=new u({model:this.model,wiki_pages_path:this.wiki_pages_path}),t.open()):void 0},s}(s)})}).call(this);