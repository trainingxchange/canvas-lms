(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","compiled/calendar/commonEventFactory","jst/calendar/editAssignment","jst/calendar/editAssignmentOverride","jst/calendar/genericSelectOptions","jquery.instructure_date_and_time","jquery.instructure_forms","jquery.instructure_misc_helpers"],function(e,n,i,s,r){var o;return o=function(){function o(n,r,o,a){var h;this.event=r,this.contextChangeCB=o,this.closeCB=a,this.formSubmit=t(this.formSubmit,this),this.setupTimeAndDatePickers=t(this.setupTimeAndDatePickers,this),this.contextChange=t(this.contextChange,this),this.setContext=t(this.setContext,this),this.moreOptionsClick=t(this.moreOptionsClick,this),this.activate=t(this.activate,this),this.currentContextInfo=null,h=this.event.override?s:i,this.form=e(h({title:this.event.title,contexts:this.event.possibleContexts()})),e(n).append(this.form),this.setupTimeAndDatePickers(),this.form.submit(this.formSubmit),this.form.find(".more_options_link").click(this.moreOptionsClick),this.form.find("select.context_id").change(this.contextChange),this.form.find("select.context_id").triggerHandler("change",!1),this.event.isNewEvent()||(this.form.find(".context_select").hide(),this.form.attr("method","PUT"),this.form.attr("action",e.replaceTags(this.event.contextInfo.assignment_url,"id",this.event.object.id)))}return o.prototype.contextInfoForCode=function(t){var e,n,i,s;for(s=this.event.possibleContexts(),n=0,i=s.length;i>n;n++)if(e=s[n],e.asset_string===t)return e;return null},o.prototype.activate=function(){var t;return this.form.find("select.context_id").change(),(null!=(t=this.event.assignment)?t.assignment_group_id:void 0)?this.form.find(".assignment_group_select .assignment_group").val(this.event.assignment.assignment_group_id):void 0},o.prototype.moreOptionsClick=function(t){var n,i,s;return t.preventDefault(),s=e(t.target).attr("href").split("#"),n=this.form.getFormData({object_name:"assignment"}),i={},n.title&&(i.title=n.title),n.due_at&&(i.due_at=n.due_at),n.assignment_group_id&&(i.assignment_group_id=n.assignment_group_id),i.return_to=window.location.href,s[0]+="?"+e.param(i),window.location.href=s.join("#")},o.prototype.setContext=function(t){return this.form.find("select.context_id").val(t).triggerHandler("change",!1)},o.prototype.contextChange=function(t,n){var i,s,o;if(!this.ignoreContextChange&&(s=e(t.target).val(),this.currentContextInfo=this.contextInfoForCode(s),this.event.contextInfo=this.currentContextInfo,null!==this.currentContextInfo))return n!==!1&&this.contextChangeCB(s),i={collection:this.currentContextInfo.assignment_groups},this.form.find(".assignment_group").html(r(i)),this.form.attr("action",this.currentContextInfo.create_assignment_url),o=this.event.assignment?""+this.event.assignment.html_url+"/edit":this.currentContextInfo.new_assignment_url,this.form.find(".more_options_link").attr("href",o)},o.prototype.setupTimeAndDatePickers=function(){var t,e;return this.form.find(".datetime_field").datetime_field(),e=this.event.startDate(),t=this.event.endDate(),this.event.allDay?this.form.find(".datetime_field").val(e.toString("MMM d, yyyy")).change():e?this.form.find(".datetime_field").val(e.toString("MMM d, yyyy h:mmtt")).change():void 0},o.prototype.formSubmit=function(t){var e;return t.preventDefault(),e=this.form.getFormData(),null!=e["assignment[due_at]"]?this.submitAssignment(e):this.submitOverride(e)},o.prototype.submitAssignment=function(t){var i,s,r,o,a;return s=t["assignment[due_at]"],i=""===s?null:this.form.find("#assignment_due_at").data("date"),a={"assignment[name]":this.form.find("#assignment_title").val(),"assignment[due_at]":i?e.unfudgeDateForProfileTimezone(i).toISOString():"","assignment[assignment_group_id]":this.form.find(".assignment_group").val()},this.event.isNewEvent()?(o={assignment:{title:a["assignment[name]"],due_at:i?i.toISOString():null,context_code:this.form.find(".context_id").val()}},r=n(o,this.event.possibleContexts()),r.save(a)):(this.event.title=a["assignment[name]"],this.event.start=i,this.event.save(a)),this.closeCB()},o.prototype.submitOverride=function(t){var n,i;return n=t["assignment_override[due_at]"],n=""===n?null:this.form.find("#assignment_override_due_at").data("date"),i={"assignment_override[due_at]":n?e.unfudgeDateForProfileTimezone(n).toISOString():""},this.event.start=n,this.event.save(i),this.closeCB()},o}()})}).call(this);