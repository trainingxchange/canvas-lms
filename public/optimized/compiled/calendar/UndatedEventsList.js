(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["i18n!calendar","jquery","jst/calendar/undatedEvents","compiled/calendar/EventDataSource","compiled/calendar/ShowEventDetailsDialog","jqueryui/draggable","jquery.disableWhileLoading","vendor/jquery.ba-tinypubsub"],function(e,n,i,s,a){var d;return d=function(){function s(e,s,a){var d;this.dataSource=s,this.calendar=a,this.eventSaved=t(this.eventSaved,this),this.eventSaving=t(this.eventSaving,this),this.visibleContextListChanged=t(this.visibleContextListChanged,this),this.clickEvent=t(this.clickEvent,this),this.toggle=t(this.toggle,this),this.show=t(this.show,this),this.load=t(this.load,this),this.div=n(e).html(i({unloaded:!0})),this.hidden=!0,this.visibleContextList=[],n.subscribe({"CommonEvent/eventDeleting":this.eventSaving,"CommonEvent/eventDeleted":this.eventSaved,"CommonEvent/eventSaving":this.eventSaving,"CommonEvent/eventSaved":this.eventSaved,"Calendar/visibleContextListChanged":this.visibleContextListChanged}),this.div.on("click keyclick",".event",this.clickEvent).on("click",".undated_event_title",this.clickEvent).on("click",".undated-events-link",this.show),(d=this.div.prev(".element_toggler"))&&(d.on("click keyclick",this.toggle),this.div.find(".undated-events-link").hide())}return s.prototype.load=function(t){var s,a,d=this;return null==t&&(t=!1),this.hidden?void 0:(s=new n.Deferred,this.div.disableWhileLoading(s,{buttons:[".undated-events-link"],opacity:1,lines:8,length:2,width:2,radius:3}),a=setTimeout(function(){return n.screenReaderFlashMessage(e.t("loading_undated_events","Loading undated events"))},0),this.dataSource.getEvents(null,null,this.visibleContextList,function(e){var o,r,v,l,h;for(clearTimeout(a),s.resolve(),r=0,l=e.length;l>r;r++)o=e[r],o.details_url=o.fullDetailsURL(),o.icon=o.iconType();for(d.div.html(i({events:e})),v=0,h=e.length;h>v;v++)o=e[v],d.div.find("."+o.id).data("calendarEvent",o);return d.div.find(".event").draggable({revert:"invalid",revertDuration:0,helper:"clone",start:function(){return d.calendar.closeEventPopups(),n(d).hide()},stop:function(){return n(this).data("calendarEvent").start?void 0:n(this).show()}}),d.div.droppable({hoverClass:"droppable-hover",accept:".fc-event",drop:function(){var t;if(t=d.calendar.lastEventDragged)return t.start=null,t.end=null,t.saveDates()}}),t?d.div.find(".undated_event_title:first").focus():void 0}))},s.prototype.show=function(t){var e;return t.preventDefault(),this.hidden=!1,this.load(e=!0)},s.prototype.toggle=function(){var t=this;return setTimeout(function(){var e;return t.hidden=!t.div.is(":visible"),t.load(e=!0)},0)},s.prototype.clickEvent=function(t){var e,i;return t.preventDefault(),i=n(t.target).data("event-id"),i||(i=n(t.target).closest(".event").data("event-id")),e=this.dataSource.eventWithId(i),e?new a(e,this.dataSource).show(t):void 0},s.prototype.visibleContextListChanged=function(t){return this.visibleContextList=t,this.hidden?void 0:this.load()},s.prototype.eventSaving=function(t){return this.div.find("."+t.id).addClass("event_pending")},s.prototype.eventSaved=function(){return this.load()},s}()})}).call(this);