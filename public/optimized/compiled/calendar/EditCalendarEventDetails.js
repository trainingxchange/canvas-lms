(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","compiled/calendar/commonEventFactory","compiled/calendar/TimeBlockList","jst/calendar/editCalendarEvent","jquery.instructure_date_and_time","jquery.instructure_forms","jquery.instructure_misc_helpers","vendor/date"],function(e,n,i,o){var r;return r=function(){function i(n,i,r,a){this.event=i,this.contextChangeCB=r,this.closeCB=a,this.formSubmit=t(this.formSubmit,this),this.setupTimeAndDatePickers=t(this.setupTimeAndDatePickers,this),this.contextChange=t(this.contextChange,this),this.setContext=t(this.setContext,this),this.moreOptionsClick=t(this.moreOptionsClick,this),this.activate=t(this.activate,this),this.currentContextInfo=null,this.form=e(o({title:this.event.title,contexts:this.event.possibleContexts(),lockedTitle:this.event.lockedTitle,location_name:this.event.location_name})),e(n).append(this.form),this.setupTimeAndDatePickers(),this.form.submit(this.formSubmit),this.form.find(".more_options_link").click(this.moreOptionsClick),this.form.find("select.context_id").change(this.contextChange),this.form.find("select.context_id").triggerHandler("change",!1),this.event.isNewEvent()||this.form.find(".context_select").hide()}return i.prototype.contextInfoForCode=function(t){var e,n,i,o;for(o=this.event.possibleContexts(),n=0,i=o.length;i>n;n++)if(e=o[n],e.asset_string===t)return e;return null},i.prototype.activate=function(){return this.form.find("select.context_id").change()},i.prototype.moreOptionsClick=function(t){var n,i,o;if(!this.event.object.parent_event_id)return t.preventDefault(),o=e(t.target).attr("href").split("#"),n=e("#edit_calendar_event_form").getFormData({object_name:"calendar_event"}),i={},n.title&&(i.title=n.title),n.location_name&&(i.location_name=n.location_name),n.date&&(i.start_at=""+n.date+" "+(n.start_time||""),i.end_at=""+n.date+" "+(n.end_time||"")),i.return_to=window.location.href,o[0]+="?"+e.param(i),window.location.href=o.join("#")},i.prototype.setContext=function(t){return this.form.find("select.context_id").val(t).triggerHandler("change",!1)},i.prototype.contextChange=function(t,n){var i,o;return i=e(t.target).val(),this.currentContextInfo=this.contextInfoForCode(i),this.event.contextInfo=this.currentContextInfo,null!==this.currentContextInfo?(n!==!1&&this.contextChangeCB(i),o=null,o=this.event.isNewEvent()?this.currentContextInfo.new_calendar_event_url:this.event.fullDetailsURL()+"/edit",this.form.find(".more_options_link").attr("href",o)):void 0},i.prototype.setupTimeAndDatePickers=function(){var t,n,i=this;return this.form.find(".date_field").date_field(),this.form.find(".time_field").time_field().blur(function(t){var n,o,r,a;return a=i.form.find(".time_field.start_time").next(".datetime_suggest").text(),i.form.find(".time_field.start_time").next(".datetime_suggest").hasClass("invalid_datetime")&&(a=null),null==a&&(a=i.form.find(".time_field.start_time").val()),o=i.form.find(".time_field.end_time").next(".datetime_suggest").text(),i.form.find(".time_field.end_time").next(".datetime_suggest").hasClass("invalid_datetime")&&(o=null),null==o&&(o=i.form.find(".time_field.end_time").val()),r=Date.parse(a),n=Date.parse(o),r=r||n,n=n||r,e(t.target).hasClass("end_time")?r>n&&(r=n):r>n&&(n=r),r&&i.form.find(".time_field.start_time").val(r.toString("h:mmtt").toLowerCase()),n?i.form.find(".time_field.end_time").val(n.toString("h:mmtt").toLowerCase()):void 0}),n=this.event.startDate(),t=this.event.endDate(),this.event.allDay||(n&&this.form.find(".time_field.start_time").val(n.toString("h:mmtt")).change().blur(),t&&this.form.find(".time_field.end_time").val(t.toString("h:mmtt")).change().blur()),n?this.form.find(".date_field").val(n.toString("MMM d, yyyy")).change():void 0},i.prototype.formSubmit=function(t){var i,o,r,a,s,l,d,m,c;return t.preventDefault(),i=this.form.getFormData({object_name:"calendar_event"}),i.date?(d=Date.parse(""+i.date+" "+i.start_time),null==(m=i.end_time)&&(i.end_time=i.start_time),o=Date.parse(""+i.date+" "+i.end_time)):(d=null,o=null),r=i.location_name?i.location_name:"",l={"calendar_event[title]":null!=(c=i.title)?c:this.event.title,"calendar_event[start_at]":d?e.unfudgeDateForProfileTimezone(d).toISOString():"","calendar_event[end_at]":o?e.unfudgeDateForProfileTimezone(o).toISOString():"","calendar_event[location_name]":r},this.event.isNewEvent()?(l["calendar_event[context_code]"]=i.context_code,s={calendar_event:{title:l["calendar_event[title]"],start_at:d?d.toISOString():null,end_at:o?o.toISOString():null,location_name:r,context_code:this.form.find(".context_id").val()}},a=n(s,this.event.possibleContexts()),a.save(l)):(this.event.title=l["calendar_event[title]"],this.event.start=d,this.event.end=o,this.event.location_name=r,this.event.save(l)),this.closeCB()},i}()})}).call(this);