(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","underscore","i18n!EditAppointmentGroupDetails","compiled/calendar/TimeBlockList","jst/calendar/editAppointmentGroup","jst/calendar/genericSelect","jst/calendar/sectionCheckboxes","compiled/calendar/ContextSelector","compiled/fn/preventDefault","jquery.ajaxJSON","jquery.disableWhileLoading","jquery.instructure_forms"],function(e,n,i,o,p,r,a,s,c){var h;return h=function(){function a(i,r,a,h){var u,l,d,_,g,m,f,x,v,b,k,C,y,G=this;for(this.apptGroup=r,this.contexts=a,this.closeCB=h,this.toggleContextsMenu=t(this.toggleContextsMenu,this),this.contextsChanged=t(this.contextsChanged,this),this.save=t(this.save,this),this.saveClick=t(this.saveClick,this),this.saveWithoutPublishingClick=t(this.saveWithoutPublishingClick,this),this.openHelpDialog=t(this.openHelpDialog,this),this.currentContextInfo=null,e(i).html(p({title:this.apptGroup.title,contexts:this.contexts,appointment_group:n.extend({use_group_signup:"Group"===this.apptGroup.participant_type},this.apptGroup)})),this.contextsHash={},y=this.contexts,k=0,C=y.length;C>k;k++)m=y[k],this.contextsHash[m.asset_string]=m;this.form=e(i).find("form"),this.contextSelector=new s(".ag-menu-container",this.apptGroup,this.contexts,this.contextsChanged,this.toggleContextsMenu),this.editing()?(this.form.attr("action",this.apptGroup.url),this.form.find(".context_id").val(this.apptGroup.context_code).attr("disabled",!0),this.form.find("select.context_id").change(),this.disableGroups(),"Group"===this.apptGroup.participant_type?(this.form.find(".group-signup-checkbox").prop("checked",!0),this.form.find(".group_category").val(this.apptGroup.sub_context_codes[0])):this.form.find(".group-signup-checkbox").prop("checked",!1),e(".reservation_help").click(this.openHelpDialog)):this.form.attr("action","/api/v1/appointment_groups"),this.form.find(".ag_contexts_selector").click(c(this.toggleContextsMenu)),b=function(){var t,e,n,i;for(n=this.apptGroup.appointmentEvents||[],i=[],t=0,e=n.length;e>t;t++)g=n[t],i.push([g.start,g.end,!0]);return i}.call(this),this.timeBlockList=new o(this.form.find(".time-block-list-body"),this.form.find(".splitter"),b),this.form.find('[name="slot_duration"]').change(function(t){return G.form.find('[name="autosplit_option"]').is(":checked")?(G.timeBlockList.split(t.target.value),G.timeBlockList.render()):void 0}),this.form.find('[name="participant_visibility"]').prop("checked","protected"===this.apptGroup.participant_visibility),this.form.find(".group-signup-checkbox").change(function(t){var e;return e=!!t.target.checked,G.form.find(".per_appointment_groups_label").toggle(e),G.form.find(".per_appointment_users_label").toggle(!e),G.form.find(".group-signup").toggle(e)}),this.form.find(".group-signup-checkbox").change(),d=this.form.find(".appointment-blocks-per-slot-option-button"),_=this.form.find('[name="participants_per_appointment"]'),v=function(){return G.perSlotChange(d,_)},e.merge(d,_).on("change",v),this.apptGroup.participants_per_appointment>0?(d.prop("checked",!0),_.val(this.apptGroup.participants_per_appointment)):_.attr("disabled",!0),u=this.form.find(".max-per-student-option"),l=this.form.find('[name="max_appointments_per_participant"]'),x=function(){return G.maxStudentAppointmentsChange(u,l)},e.merge(u,l).on("change",x),f=this.apptGroup.max_appointments_per_participant,l.val(f),f>0||this.creating()?(u.prop("checked",!0),this.creating()&&""===l.val()&&l.val("1")):l.attr("disabled",!0),"active"===this.apptGroup.workflow_state&&this.form.find("#appointment-blocks-active-button").attr("disabled",!0).prop("checked",!0)}return a.prototype.creating=function(){return!this.editing()},a.prototype.editing=function(){return null!=this.apptGroup.id},a.prototype.perSlotChange=function(t,e){var i;return this.checkBoxInputChange(t,e),i=parseInt(e.val()),this.helpIconShowIf(t,n.any(this.apptGroup.appointments,function(t){return t.child_events_count>i}))},a.prototype.maxStudentAppointmentsChange=function(t,e){var i,o,p,r,a,s,c,h,u,l,d;for(this.checkBoxInputChange(t,e),p=parseInt(e.val()),o={},l=this.apptGroup.appointments,a=0,c=l.length;c>a;a++)for(i=l[a],d=i.child_events,s=0,h=d.length;h>s;s++)r=d[s],o[u=r.user.id]||(o[u]=0),o[r.user.id]+=1;return this.helpIconShowIf(t,n.any(o,function(t){return t>p}))},a.prototype.helpIconShowIf=function(t,e){var n;return n=t.closest("li").find(".reservation_help"),e&&t.is(":checked")?n.removeClass("hidden"):n.addClass("hidden")},a.prototype.checkBoxInputChange=function(t,e){return t.prop("checked")&&""===e.val()&&e.val("1"),e.prop("disabled",!t.prop("checked"))},a.prototype.openHelpDialog=function(t){return t.preventDefault(),e("#options_help_dialog").dialog({title:i.t("affect_reservations","How will this affect reservations?"),width:400})},a.prototype.saveWithoutPublishingClick=function(t){return t.preventDefault(),this.save(!1)},a.prototype.saveClick=function(t){return t.preventDefault(),this.save(!0)},a.prototype.save=function(t){var n,o,p,r,a,s,c,h,u,l,d,_,g=this;if(o=this.form.getFormData({object_name:"appointment_group"}),c={"appointment_group[title]":o.title,"appointment_group[description]":o.description,"appointment_group[location_name]":o.location},"1"===o.max_appointments_per_participant_option){if(o.max_appointments_per_participant<1)return e('[name="max_appointments_per_participant"]').errorBox(i.t("bad_max_appts","You must allow at least one appointment per participant")),!1;c["appointment_group[max_appointments_per_participant]"]=o.max_appointments_per_participant}else c["appointment_group[max_appointments_per_participant]"]="";if(c["appointment_group[new_appointments]"]=[],!this.timeBlockList.validate())return!1;for(_=this.timeBlockList.blocks(),l=0,d=_.length;d>l;l++)h=_[l],c["appointment_group[new_appointments]"].push([e.unfudgeDateForProfileTimezone(h[0]).toISOString(),e.unfudgeDateForProfileTimezone(h[1]).toISOString()]);if("1"===o.per_slot_option){if(o.participants_per_appointment<1)return e('[name="participants_per_appointment"]').errorBox(i.t("bad_per_slot","You must allow at least one appointment per time slot")),!1;c["appointment_group[participants_per_appointment]"]=o.participants_per_appointment}else c["appointment_group[participants_per_appointment]"]="";return t&&"active"!==this.apptGroup.workflow_state&&(c["appointment_group[publish]"]="1"),c["appointment_group[participant_visibility]"]="1"===o.participant_visibility?"protected":"private",delete o["context_codes[]"],delete o["sections[]"],n=this.contextSelector.selectedContexts(),0===n.length?void e(".ag_contexts_selector").errorBox(i.t("context_required","You need to select a calendar")):(c["appointment_group[context_codes]"]=n,this.creating()&&("1"===o.use_group_signup&&o.group_category_id?c["appointment_group[sub_context_codes]"]=[o.group_category_id]:(u=this.contextSelector.selectedSections(),u&&(c["appointment_group[sub_context_codes]"]=u)),c["appointment_group[min_appointments_per_participant]"]=1),s=function(){return g.closeCB(!0)},a=function(){},r=this.editing()?"PUT":"POST",p=e.ajaxJSON(this.form.attr("action"),r,c,s,a),this.form.disableWhileLoading(p))},a.prototype.contextsChanged=function(t,e){var o,p,r,a,s,c;return 0===e.length&&0===t.length?this.form.find(".ag_contexts_selector").text(i.t("select_calendars","Select Calendars")):(t.length>0&&(p=t[0],s=this.contextsHash[p].name,t.length>1&&(s+=i.t("and_n_contexts"," and %{n} others",{n:t.length-1})),this.form.find(".ag_contexts_selector").text(s)),e.length>0&&(a=e[0],r=n.chain(this.contexts).pluck("course_sections").flatten().find(function(t){return t.asset_string===a}).value(),s=r.name,e.length>1&&(s+=i.t("and_n_sectionCodes"," and %{n} others",{n:e.length-1})),this.form.find(".ag_contexts_selector").text(s))),o=this.contextsHash[t[0]],1===t.length&&0===e.length&&(null!=(c=o.group_categories)?c.length:void 0)>0?(this.enableGroups(o),this.apptGroup.sub_context_codes.length>0?this.form.find("[name=group_category_id]").prop("disabled",!0):void 0):this.disableGroups()},a.prototype.disableGroups=function(){return this.form.find(".group-signup-checkbox").attr("disabled",!0).prop("checked",!1),this.form.find(".group-signup").hide()},a.prototype.enableGroups=function(t){var e;return this.form.find(".group-signup-checkbox").attr("disabled",!1),e={cssClass:"group_category",name:"group_category_id",collection:t.group_categories},this.form.find(".group_select").html(r(e))},a.prototype.toggleContextsMenu=function(){var t;return t=e(".ag_contexts_menu").toggleClass("hidden"),t.hasClass("hidden")?e(".ag_contexts_selector").focus():void 0},a}()})}).call(this);