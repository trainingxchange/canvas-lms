(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};define(["jquery","underscore","i18n!calendar","jst/calendar/appointmentGroupList","jst/calendar/schedulerRightSideAdminSection","compiled/calendar/EditAppointmentGroupDialog","compiled/calendar/MessageParticipantsDialog","jst/calendar/deleteItem","compiled/util/semanticDateRange","jquery.instructure_date_and_time","jqueryui/dialog","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","vendor/jquery.spin"],function(i,n,a,r,o,s,d,l,h){var p;return p=function(){function p(e,a){this.calendar=a,this.messageLinkClick=t(this.messageLinkClick,this),this.deleteLinkClick=t(this.deleteLinkClick,this),this.editLinkClick=t(this.editLinkClick,this),this.showList=t(this.showList,this),this.doneClick=t(this.doneClick,this),this.viewCalendarForGroup=t(this.viewCalendarForGroup,this),this.viewCalendarForGroupId=t(this.viewCalendarForGroupId,this),this.viewCalendarForElement=t(this.viewCalendarForElement,this),this.showEventLinkClick=t(this.showEventLinkClick,this),this.viewCalendarLinkClick=t(this.viewCalendarLinkClick,this),this.redraw=t(this.redraw,this),this.loadData=t(this.loadData,this),this.canManageAGroup=t(this.canManageAGroup,this),this.hide=t(this.hide,this),this.show=t(this.show,this),this.eventDeleted=t(this.eventDeleted,this),this.eventSaved=t(this.eventSaved,this),this.dialogCloseCB=t(this.dialogCloseCB,this),this.createClick=t(this.createClick,this),this.div=i(e),this.contexts=this.calendar.contexts,this.listDiv=this.div.find(".appointment-list"),this.div.delegate(".view_calendar_link","click",this.viewCalendarLinkClick),this.listDiv.delegate(".edit_link","click",this.editLinkClick),this.listDiv.delegate(".message_link","click",this.messageLinkClick),this.listDiv.delegate(".delete_link","click",this.deleteLinkClick),this.listDiv.delegate(".show_event_link","click",this.showEventLinkClick),this.canManageAGroup()&&(this.div.addClass("can-manage"),this.rightSideAdminSection=i(o()),this.rightSideAdminSection.find(".create_link").click(this.createClick),this.appointmentGroupContexts=n.filter(this.contexts,function(t){return t.can_create_appointment_groups})),i.subscribe("CommonEvent/eventSaved",this.eventSaved),i.subscribe("CommonEvent/eventDeleted",this.eventDeleted)}return p.prototype.createClick=function(t){var e;return t.preventDefault(),e={context_codes:[],sub_context_codes:[]},this.createDialog=new s(e,this.appointmentGroupContexts,this.dialogCloseCB),this.createDialog.show()},p.prototype.dialogCloseCB=function(t){return t?(this.calendar.dataSource.clearCache(),this.loadData()):void 0},p.prototype.eventSaved=function(){return this.active?(this.calendar.dataSource.clearCache(),this.loadData()):void 0},p.prototype.eventDeleted=function(){return this.active?(this.calendar.dataSource.clearCache(),this.loadData()):void 0},p.prototype.toggleListMode=function(t){var e;return t?(delete this.viewingGroup,this.calendar.updateFragment({appointment_group_id:null}),this.showList(),this.canManageAGroup()?(i("#right-side .rs-section").hide(),this.rightSideAdminSection.appendTo("#right-side")):i("#right-side-wrapper").hide()):(i("#right-side-wrapper").show(),i("#right-side .rs-section").not("#undated-events-section, #calendar-feed").show(),null!=(e=this.rightSideAdminSection)?e.detach():void 0)},p.prototype.show=function(){return i("#undated-events-section, #calendar-feed").hide(),this.active=!0,this.div.show(),this.loadData(),this.toggleListMode(!0)},p.prototype.hide=function(){return i("#undated-events-section, #calendar-feed").show(),this.active=!1,this.div.hide(),this.toggleListMode(!1),this.calendar.displayAppointmentEvents=null,i.publish("Calendar/restoreVisibleContextList")},p.prototype.canManageAGroup=function(){var t,e,i,n;for(n=this.contexts,e=0,i=n.length;i>e;e++)if(t=n[e],t.can_create_appointment_groups)return!0;return!1},p.prototype.loadData=function(){var t,e=this;return(!this.loadingDeferred||this.loadingDeferred&&!this.loadingDeferred.isResolved())&&(this.loadingDeferred=new i.Deferred),this.groups={},null==(t=this.loadingDiv)&&(this.loadingDiv=i('<div id="scheduler-loading" />').appendTo(this.div).spin()),this.calendar.dataSource.getAppointmentGroups(this.canManageAGroup(),function(t){var i,n,a;for(n=0,a=t.length;a>n;n++)i=t[n],e.groups[i.id]=i;return e.redraw(),e.loadingDeferred.resolve()})},p.prototype.redraw=function(){var t,a,o,s,d,l,p,c;if(this.loadingDiv.hide(),this.groups){a=[],p=this.groups;for(s in p){t=p[s],c=t.reserved_times;for(l in c)d=c[l],d.formatted_time=h(d.start_at,d.end_at);t.contexts=n.filter(this.contexts,function(i){var n;return n=i.asset_string,e.call(t.context_codes,n)>=0}),t.published="active"===t.workflow_state,a.push(t)}o=r({appointment_groups:a,canManageAGroup:this.canManageAGroup()}),this.listDiv.find(".list-wrapper").html(o),this.viewingGroup&&(this.viewingGroup=this.groups[this.viewingGroup.id],this.viewingGroup?(this.listDiv.find(".appointment-group-item[data-appointment-group-id='"+this.viewingGroup.id+"']").addClass("active"),this.calendar.displayAppointmentEvents=this.viewingGroup):this.toggleListMode(!0))}return i.publish("Calendar/refetchEvents")},p.prototype.viewCalendarLinkClick=function(t){return t.preventDefault(),this.viewCalendarForElement(i(t.target))},p.prototype.showEventLinkClick=function(t){var e,n,a,r,o,s,d,l,h,p;if(t.preventDefault(),r=this.viewCalendarForElement(i(t.target)),a=i(t.target).data("event-id"))for(h=r.object.appointmentEvents,o=0,d=h.length;d>o;o++)for(e=h[o],p=e.object.childEvents,s=0,l=p.length;l>s;s++)if(n=p[s],n.id===a)return void this.calendar.gotoDate(n.start)},p.prototype.viewCalendarForElement=function(t){var e,i,n,a,r;return n=t.closest(".appointment-group-item"),i=n.data("appointment-group-id"),n.addClass("active"),e=null!=(a=this.groups)?a[i]:void 0,this.viewCalendarForGroup(null!=(r=this.groups)?r[i]:void 0),e},p.prototype.viewCalendarForGroupId=function(t){var e=this;return this.loadData(),this.loadingDeferred.done(function(){var i;return e.viewCalendarForGroup(null!=(i=e.groups)?i[t]:void 0)})},p.prototype.viewCalendarForGroup=function(t){var e=this;return this.calendar.updateFragment({appointment_group_id:t.id}),this.toggleListMode(!1),this.viewingGroup=t,this.loadingDeferred.done(function(){return e.div.addClass("showing-single"),e.calendar.showSchedulerSingle(),e.calendar.gotoDate(e.viewingGroup.start_at?i.fudgeDateForProfileTimezone(e.viewingGroup.start_at):new Date),e.calendar.displayAppointmentEvents=e.viewingGroup,i.publish("Calendar/refetchEvents"),e.redraw()})},p.prototype.doneClick=function(t){return null!=t&&t.preventDefault(),this.toggleListMode(!0)},p.prototype.showList=function(){return this.div.removeClass("showing-single"),this.listDiv.find(".appointment-group-item").removeClass("active"),this.calendar.calendar.hide(),this.calendar.displayAppointmentEvents=null},p.prototype.editLinkClick=function(t){var e,n,a=this;return t.preventDefault(),(e=null!=(n=this.groups)?n[i(t.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0)?this.calendar.dataSource.getEventsForAppointmentGroup(e,function(){return a.loadData(),a.loadingDeferred.done(function(){return e=a.groups[e.id],a.createDialog=new s(e,a.appointmentGroupContexts,a.dialogCloseCB),a.createDialog.show()})}):void 0},p.prototype.deleteLinkClick=function(t){var e,n,r=this;return t.preventDefault(),(e=null!=(n=this.groups)?n[i(t.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0)?i("<div />").confirmDelete({url:e.url,message:i(l({message:a.t("confirm_appointment_group_deletion","Are you sure you want to delete this appointment group?"),details:a.t("appointment_group_deletion_details","Deleting it will also delete any appointments that have been signed up for by students.")})),dialog:{title:a.t("confirm_deletion","Confirm Deletion")},prepareData:function(t){return{cancel_reason:t.find("#cancel_reason").val()}},confirmed:function(){return i(t.target).closest(".appointment-group-item").addClass("event_pending")},success:function(){return r.calendar.dataSource.clearCache(),r.loadData()}}):void 0},p.prototype.messageLinkClick=function(t){var e,n;return t.preventDefault(),e=null!=(n=this.groups)?n[i(t.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0,this.messageDialog=new d({group:e,dataSource:this.calendar.dataSource}),this.messageDialog.show()},p}()})}).call(this);