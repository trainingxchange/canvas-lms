(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","underscore","jst/calendar/contextSelector","jst/calendar/contextSelectorItem","compiled/fn/preventDefault"],function(e,s,n,o,i){var c,r;return r=function(){function n(e){this.context=e,this.sectionChange=t(this.sectionChange,this),this.setState=t(this.setState,this),this.change=t(this.change,this),this.toggleSections=t(this.toggleSections,this),this.state="off",this.locked=!1}return n.prototype.render=function(t){return this.$listItem=e(o(this.context)),this.$listItem.appendTo(t),this.$sectionsList=this.$listItem.find(".ag_sections"),this.$listItem.find(".ag_sections_toggle").click(i(this.toggleSections)),this.$contentCheckbox=this.$listItem.find('[name="context_codes[]"]'),this.$contentCheckbox.change(i(this.change)),this.$sectionCheckboxes=this.$listItem.find('[name="sections[]"]'),this.$sectionCheckboxes.change(this.sectionChange)},n.prototype.toggleSections=function(t){return e(t.target).toggleClass("ag-sections-expanded"),this.$sectionsList.toggleClass("hidden")},n.prototype.change=function(){var t;return t=function(){switch(this.state){case"off":return"on";case"on":return"off";case"partial":return"on"}}.call(this),this.setState(t)},n.prototype.setState=function(t){var s;if(!this.locked){switch(this.state=t,this.state){case"on":case"off":s="on"===this.state,this.$contentCheckbox.prop("checked",s),this.$contentCheckbox.prop("indeterminate",!1),this.$sectionCheckboxes.prop("checked",s);break;case"partial":this.$contentCheckbox.prop("checked",!0),this.$contentCheckbox.prop("indeterminate",!0)}return e.publish("/contextSelector/changed")}},n.prototype.sectionChange=function(){switch(this.$sectionCheckboxes.filter(":checked").length){case 0:return this.setState("off");case this.$sectionCheckboxes.length:return this.setState("on");default:return this.setState("partial")}},n.prototype.disable=function(){return this.$contentCheckbox.prop("disabled",!0),this.disableSections()},n.prototype.disableSections=function(){return this.$sectionCheckboxes.prop("disabled",!0)},n.prototype.lock=function(){return this.locked=!0,this.disable(),this.disableSections()},n.prototype.isChecked=function(){return"off"!==this.state},n.prototype.sections=function(){var t;return t=this.$sectionCheckboxes.filter(":checked"),t.length===this.$sectionCheckboxes.length?[]:s.map(t,function(t){return t.value})},n}(),c=function(){function t(t,s,o,c,h){var a,l,u,p,f,d,g,x,k,S,b,m,C,$,_,v,y,I,G,j,w,L,q,D,T=this;for(this.apptGroup=s,this.contexts=o,this.$menu=e(t).html(n()),a=this.$menu.find(".ag-contexts"),e.subscribe("/contextSelector/changed",function(){return c(T.selectedContexts(),T.selectedSections())}),this.contextSelectorItems={},G=this.contexts,k=0,C=G.length;C>k;k++)l=G[k],d=new r(l),d.render(a),this.contextSelectorItems[d.context.asset_string]=d;if(this.apptGroup.sub_context_codes.length>0&&this.apptGroup.sub_context_codes[0].match(/^group_category_/)){j=this.contextSelectorItems;for(l in j)d=j[l],l===this.apptGroup.context_codes[0]&&d.setState("on"),d.lock()}else{for(f={},w=this.contexts,S=0,$=w.length;$>S;S++)for(l=w[S],L=l.course_sections,b=0,_=L.length;_>b;b++)g=L[b],f[g.asset_string]=l.asset_string;for(q=this.apptGroup.sub_context_codes,m=0,v=q.length;v>m;m++)x=q[m],e("[value='"+x+"']").prop("checked",!0),u=f[x],d=this.contextSelectorItems[u],d.sectionChange(),d.lock();for(D=this.apptGroup.context_codes,I=0,y=D.length;y>I;I++)p=D[I],d=this.contextSelectorItems[p],"off"===d.state&&(d.setState("on"),d.lock())}e(".ag_contexts_done").click(i(h)),c(this.selectedContexts(),this.selectedSections())}return t.prototype.selectedContexts=function(){var t;return t=s.chain(this.contextSelectorItems).values().filter(function(t){return"off"!==t.state}).map(function(t){return t.context.asset_string}).value()},t.prototype.selectedSections=function(){var t;return t=s.chain(this.contextSelectorItems).values().map(function(t){return t.sections()}).reject(function(t){return 0===t.length}).flatten().value()},t}()})}).call(this);