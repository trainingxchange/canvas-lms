(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define(["i18n!calendar","jquery","underscore","compiled/userSettings","compiled/util/hsvToRgb","bower/color-slicer/dist/color-slicer","jst/calendar/calendarApp","compiled/calendar/EventDataSource","compiled/calendar/commonEventFactory","compiled/calendar/ShowEventDetailsDialog","compiled/calendar/EditEventDetailsDialog","compiled/calendar/Scheduler","compiled/views/calendar/CalendarNavigator","compiled/views/calendar/AgendaView","compiled/calendar/CalendarDefaults","compiled/util/deparam","vendor/fullcalendar","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","jqueryui/button"],function(t,n,i,a,r,s,o,d,h,l,c,u,v,p,g,f){var m;return m=function(){function r(t,i,a,r,s){var d,h,l,c,g,f,m=this;this.contexts=i,this.manageContexts=a,this.dataSource=r,this.options=s,this.dataFromDocumentHash=e(this.dataFromDocumentHash,this),this.colorizeContexts=e(this.colorizeContexts,this),this.schedulerSingleDoneClick=e(this.schedulerSingleDoneClick,this),this.renderDateRange=e(this.renderDateRange,this),this.loadView=e(this.loadView,this),this.gotoDate=e(this.gotoDate,this),this.refetchEvents=e(this.refetchEvents,this),this.ajaxEnded=e(this.ajaxEnded,this),this.ajaxStarted=e(this.ajaxStarted,this),this.visibleContextListChanged=e(this.visibleContextListChanged,this),this.updateOverrides=e(this.updateOverrides,this),this.eventSaveFailed=e(this.eventSaveFailed,this),this.eventSaved=e(this.eventSaved,this),this.eventSaving=e(this.eventSaving,this),this.eventDeleted=e(this.eventDeleted,this),this.eventDeleting=e(this.eventDeleting,this),this.reloadClick=e(this.reloadClick,this),this.fragmentChange=e(this.fragmentChange,this),this.drop=e(this.drop,this),this.setDateTitle=e(this.setDateTitle,this),this.drawNowLine=e(this.drawNowLine,this),this.viewDisplay=e(this.viewDisplay,this),this.dayClick=e(this.dayClick,this),this.eventClick=e(this.eventClick,this),this.addEventClick=e(this.addEventClick,this),this.eventResize=e(this.eventResize,this),this.eventDrop=e(this.eventDrop,this),this.eventResizeStart=e(this.eventResizeStart,this),this.eventDragStart=e(this.eventDragStart,this),this.eventAfterRender=e(this.eventAfterRender,this),this.eventRender=e(this.eventRender,this),this.windowResize=e(this.windowResize,this),this.getEvents=e(this.getEvents,this),this.today=e(this.today,this),this.contextCodes=function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)d=i[e],n.push(d.asset_string);return n}(),this.visibleContextList=[],this.displayAppointmentEvents=null,this.activateEvent=null!=(g=this.options)?g.activateEvent:void 0,this.activeAjax=0,this.subscribeToEvents(),this.header=this.options.header,this.el=n(t).html(o()),this.schedulerNavigator=new v({el:n(".scheduler_navigator")}),this.schedulerNavigator.hide(),this.agenda=new p({el:n(".agenda-wrapper"),dataSource:this.dataSource}),this.scheduler=new u(".scheduler-wrapper",this),c=this.initializeFullCalendarParams(),h=this.dataFromDocumentHash(),!h.view_start&&(null!=(f=this.options)?f.viewStart:void 0)&&(h.view_start=this.options.viewStart,this.updateFragment(h)),l=h.view_start?n.fullCalendar.parseISO8601(h.view_start):n.fudgeDateForProfileTimezone(new Date),c.year=l.getFullYear(),c.month=l.getMonth(),c.date=l.getDate(),this.calendar=this.el.find("div.calendar").fullCalendar(c),h.show&&""!==h.show&&(this.visibleContextList=h.show.split(",")),n(document).fragmentChange(this.fragmentChange),this.colorizeContexts(),this.options.showScheduler&&this.dataSource.getAppointmentGroups(!1,function(e){var t,n,i,a;for(n=0,i=0,a=e.length;a>i;i++)t=e[i],t.requiring_action&&(n+=1);return m.header.setSchedulerBadgeCount(n)}),this.connectHeaderEvents(),this.connectSchedulerNavigatorEvents(),this.connectAgendaEvents(),this.header.selectView(this.getCurrentView()),"scheduler"===h.view_name&&h.appointment_group_id&&this.scheduler.viewCalendarForGroupId(h.appointment_group_id),window.setInterval(this.drawNowLine,6e4)}var d;return r.prototype.subscribeToEvents=function(){return n.subscribe({"CommonEvent/eventDeleting":this.eventDeleting,"CommonEvent/eventDeleted":this.eventDeleted,"CommonEvent/eventSaving":this.eventSaving,"CommonEvent/eventSaved":this.eventSaved,"CommonEvent/eventSaveError":this.eventSaveFailed,"Calendar/visibleContextListChanged":this.visibleContextListChanged,"EventDataSource/ajaxStarted":this.ajaxStarted,"EventDataSource/ajaxEnded":this.ajaxEnded,"Calendar/refetchEvents":this.refetchEvents,"CommonEvent/assignmentSaved":this.updateOverrides,"Calendar/colorizeContexts":this.colorizeContexts})},r.prototype.connectHeaderEvents=function(){var e=this;return this.header.on("navigatePrev",function(){return e.handleArrow("prev")}),this.header.on("navigateToday",this.today),this.header.on("navigateNext",function(){return e.handleArrow("next")}),this.header.on("navigateDate",this.gotoDate),this.header.on("week",function(){return e.loadView("week")}),this.header.on("month",function(){return e.loadView("month")}),this.header.on("agenda",function(){return e.loadView("agenda")}),this.header.on("scheduler",function(){return e.loadView("scheduler")}),this.header.on("createNewEvent",this.addEventClick),this.header.on("refreshCalendar",this.reloadClick),this.header.on("done",this.schedulerSingleDoneClick)},r.prototype.connectSchedulerNavigatorEvents=function(){var e=this;return this.schedulerNavigator.on("navigatePrev",function(){return e.handleArrow("prev")}),this.schedulerNavigator.on("navigateToday",this.today),this.schedulerNavigator.on("navigateNext",function(){return e.handleArrow("next")}),this.schedulerNavigator.on("navigateDate",this.gotoDate)},r.prototype.connectAgendaEvents=function(){return this.agenda.on("agendaDateRange",this.renderDateRange)},r.prototype.initializeFullCalendarParams=function(){return i.defaults({header:!1,editable:!0,columnFormat:{month:"ddd",week:"ddd M/d"},buttonText:{today:t.t("today","Today")},defaultEventMinutes:60,slotMinutes:30,firstHour:7,droppable:!0,dropAccept:".undated_event",events:this.getEvents,eventRender:this.eventRender,eventAfterRender:this.eventAfterRender,eventDragStart:this.eventDragStart,eventDrop:this.eventDrop,eventClick:this.eventClick,eventResize:this.eventResize,eventResizeStart:this.eventResizeStart,dayClick:this.dayClick,addEventClick:this.addEventClick,titleFormat:{week:"MMM d[ yyyy]{ '&ndash;'[ MMM] d, yyyy}"},viewDisplay:this.viewDisplay,windowResize:this.windowResize,drop:this.drop,dragRevertDuration:{month:0},dragHelper:{month:"clone"},dragAppendTo:{month:"#calendar-drag-and-drop-container"},dragZIndex:{month:350},dragCursorAt:{month:{top:-5,left:-5}}},g)},r.prototype.today=function(){var e;return e=n.fudgeDateForProfileTimezone(new Date),this.gotoDate(e)},r.prototype.getEvents=function(e,t,n){var i,a=this;return i=function(e){var t,n,i,r,s,o,d;if(n={},!(e.length>0))return e;for(i=s=o=e.length-1;0>=o?0>=s:s>=0;i=0>=o?++s:--s)t=e[i],r=!0,n[t.id]?r=!1:t.isAppointmentGroupEvent()&&(r=a.displayAppointmentEvents?a.displayAppointmentEvents.id===(null!=(d=t.calendarEvent)?d.appointment_group_id:void 0)?!!t.calendarEvent.reserve_url:!t.calendarEvent.reserve_url:t.calendarEvent.reserve_url?t.calendarEvent.child_events_count>0&&!t.calendarEvent.reserved&&t.can_edit?!0:!1:!0),r||e.splice(i,1),n[t.id]=!0;return e},this.dataSource.getEvents(e,t,this.visibleContextList,function(e){return a.displayAppointmentEvents?a.dataSource.getEventsForAppointmentGroup(a.displayAppointmentEvents,function(t){var a,r,s,o,d;for(r=0,o=e.length;o>r;r++)a=e[r],a.removeClass("current-appointment-group");for(s=0,d=t.length;d>s;s++)a=t[s],a.addClass("current-appointment-group");return n(i(e.concat(t)))}):n(i(e))})},r.prototype.closeEventPopups=function(){return n(".event-details").each(function(){var e;return e=n(this).data("showEventDetailsDialog"),e?e.close():void 0})},r.prototype.windowResize=function(){return this.closeEventPopups(),this.drawNowLine()},r.prototype.eventRender=function(e,i){var a,r,s,o;return a=n(i),e.isAppointmentGroupEvent()&&this.displayAppointmentEvents&&this.displayAppointmentEvents.id===e.calendarEvent.appointment_group_id&&(s="Available",e.calendarEvent.available_slots>0&&(s=""+e.calendarEvent.available_slots+" Available"),0===e.calendarEvent.available_slots&&(s="Filled"),e.calendarEvent.reserved===!0&&(s="Reserved"),a.find(".fc-event-title").text(s)),o=e.endDate()&&e.startDate().getTime()!==e.endDate().getTime()?this.calendar.fullCalendar("formatDates",e.startDate(),e.endDate(),"h:mmtt{ â€“ h:mmtt}"):this.calendar.fullCalendar("formatDate",e.startDate(),"h:mmtt"),r=e.eventType.match(/assignment/)?t.t("event_assignment_title","Assignment Title: "):t.t("event_event_title","Event Title: "),a.attr("title",n.trim(""+o+"\n"+a.find(".fc-event-title").text()+"\n\n"+t.t("calendar_title","Calendar:")+" "+e.contextInfo.name)),a.find(".fc-event-inner").prepend(n("<span class='screenreader-only'>"+t.t("calendar_title","Calendar:")+" "+e.contextInfo.name+"</span>")),a.find(".fc-event-title").prepend(n("<span class='screenreader-only'>"+r+"</span>")),i.find(".fc-event-inner").prepend(n("<i />",{"class":"icon-"+e.iconType()})),!0},r.prototype.eventAfterRender=function(e,t,n){var i,a,r,s;return e.isDueAtMidnight()&&(a=t.find(".fc-event-time"),i=a.html(),i=i.replace(/^\d+:\d+\w?/,this.calendar.fullCalendar("formatDate",e.startDate(),"h(:mm)t")),a.html(i)),e.eventType.match(/assignment/)&&"agendaWeek"===n.name&&t.height("").find(".ui-resizable-handle").remove(),e.eventType.match(/assignment/)&&e.isDueAtMidnight()&&"month"===n.name&&t.find(".fc-event-time").empty(),"calendar_event"===e.eventType&&(null!=(r=this.options)?r.activateEvent:void 0)&&e.id==="calendar_event_"+(null!=(s=this.options)?s.activateEvent:void 0)?(this.options.activateEvent=null,this.eventClick(e,{currentTarget:t,pageX:t.offset().left+parseInt(t.width()/2)},n)):void 0},r.prototype.eventDragStart=function(e){return this.lastEventDragged=e,this.closeEventPopups()},r.prototype.eventResizeStart=function(){return this.closeEventPopups()},r.prototype.eventDrop=function(e,t,n,i,a){return this._eventDrop(e,n,i,a)},r.prototype._eventDrop=function(e,t,n,i){var a;return"week"===this.currentView&&n&&"assignment"===e.eventType?void i():("assignment"===e.eventType&&e.isDueAtMidnight()&&0===t&&e.start.setMinutes(59),"calendar_event"===e.eventType&&n&&(e.allDay=!0),e.end&&e.endDate()&&(a=e.endDate().getTime()-e.startDate().getTime(),e.end=new Date(e.start.getTime()+a)),e.saveDates(null,i),!0)},r.prototype.eventResize=function(e,t,n,i){return e.saveDates(null,i)},r.prototype.addEventClick=function(e){var t,n;if(!this.displayAppointmentEvents)return n=a.get("checked_calendar_codes")||i.pluck(this.contexts,"asset_string"),t=i.filter(this.contexts,function(e){return i.contains(n,e.asset_string)}),e=h(null,t),e.date=this.getCurrentDate(),new c(e).show()},r.prototype.eventClick=function(e,t){var i,a;return i=n(t.currentTarget),i.hasClass("event_pending")?void 0:(a=new l(e),i.data("showEventDetailsDialog",a),a.show(t))},r.prototype.dayClick=function(e,t){var n,r,s;if(!this.displayAppointmentEvents)return r=a.get("checked_calendar_codes")||i.pluck(this.contexts,"asset_string"),n=i.filter(this.contexts,function(e){return i.contains(r,e.asset_string)}),s=h(null,n),s.allDay=t,s.date=e,new c(s).show()},r.prototype.updateFragment=function(e){var t,i,a,r;i=this.dataFromDocumentHash(),t=!1;for(a in e)r=e[a],i[a]!==r&&(t=!0),r?i[a]=r:delete i[a];return t?location.href="#"+n.param(i):void 0},r.prototype.viewDisplay=function(e){return this.setDateTitle(e.title),this.drawNowLine()},r.prototype.isSameWeek=function(e,t){var n,i,a;return n=new Date(e.getTime()),n.setDate(n.getDate()-n.getDay()),a=n.getTime(),i=a+6048e5,t>=a&&i>=t},r.prototype.drawNowLine=function(){var e,t,i,a;if("week"===this.currentView)return this.nowLine||(this.nowLine=n("<div />",{"class":"calendar-nowline"})),n(".fc-agenda-slots").parent().append(this.nowLine),t=n.fudgeDateForProfileTimezone(new Date),e=new Date(t.getTime()),e.setHours(0,0,0),a=(t.getTime()-e.getTime())/1e3,this.nowLine.toggle(this.isSameWeek(this.getCurrentDate(),t)),this.nowLine.css("width",n(".fc-agenda-slots .fc-widget-content:first").css("width")),i=n(".fc-agenda-slots").css("height").replace("px","")/24/3600,this.nowLine.css("top",a*i+"px")},r.prototype.setDateTitle=function(e){return this.header.setHeaderText(e),this.schedulerNavigator.setTitle(e)},r.prototype.drop=function(e,t,i,a){var r,s,o;return s=n(a.helper).data("event-id"),r=n("[data-event-id="+s+"]").data("calendarEvent"),r&&(r.start=e,r.addClass("event_pending"),o=function(){return console.log("could not save date on undated event")},this._eventDrop(r,0,t,o))?this.calendar.fullCalendar("renderEvent",r):void 0},r.prototype.dropOnMiniCalendar=function(e){var t,n,i,a,r=this;return(t=this.lastEventDragged)?(i=new Date(t.start.getTime()),n=new Date(null!=(a=t.end)?a.getTime():void 0),this.copyYMD(t.start,e),this.copyYMD(t.end,e),this._eventDrop(t,0,!1,function(){return t.start=i,t.end=n,r.calendar.fullCalendar("updateEvent",t)})):void 0},r.prototype.copyYMD=function(e,t){return e?(e.setFullYear(t.getFullYear()),e.setMonth(t.getMonth()),e.setDate(t.getDate())):void 0},r.prototype.fragmentChange=function(){var e;return e=this.dataFromDocumentHash(),n.isEmptyObject(e)?void 0:(e.view_name!==this.currentView&&this.loadView(e.view_name),this.gotoDate(this.getCurrentDate()))},r.prototype.reloadClick=function(e){return null!=e&&e.preventDefault(),0===this.activeAjax?(this.dataSource.clearCache(),"scheduler"===this.currentView&&this.scheduler.loadData(),this.calendar.fullCalendar("refetchEvents")):void 0},r.prototype.eventDeleting=function(e){return e.addClass("event_pending"),this.calendar.fullCalendar("updateEvent",e)},r.prototype.eventDeleted=function(e){return this.calendar.fullCalendar("removeEvents",e.id)},r.prototype.eventSaving=function(e){return e.start?(e.addClass("event_pending"),e.isNewEvent()?this.calendar.fullCalendar("renderEvent",e):this.calendar.fullCalendar("updateEvent",e)):void 0},r.prototype.eventSaved=function(e){return e.removeClass("event_pending"),delete e._id,this.calendar.fullCalendar("refetchEvents"),this.closeEventPopups()},r.prototype.eventSaveFailed=function(e){return e.removeClass("event_pending"),e.isNewEvent()?this.calendar.fullCalendar("removeEvents",e.id):this.calendar.fullCalendar("updateEvent",e)},r.prototype.updateOverrides=function(e){return i.each(this.dataSource.cache.contexts[e.contextCode()].events,function(t,n){return n.match(/override/)&&e.assignment.id===t.assignment.id?t.updateAssignmentTitle(e.title):void 0})},r.prototype.visibleContextListChanged=function(e){return this.visibleContextList=e,"agenda"===this.currentView&&this.loadAgendaView(),this.calendar.fullCalendar("refetchEvents")},r.prototype.ajaxStarted=function(){return this.activeAjax+=1,this.header.animateLoading(!0)},r.prototype.ajaxEnded=function(){return this.activeAjax-=1,this.header.animateLoading(this.activeAjax>0)},r.prototype.refetchEvents=function(){return this.calendar.fullCalendar("refetchEvents")},r.prototype.gotoDate=function(e){return this.calendar.fullCalendar("gotoDate",e),"agenda"===this.currentView&&this.agendaViewFetch(e),this.setCurrentDate(e)},r.prototype.handleArrow=function(e){var t,i,a;return this.calendar.fullCalendar(e),t=this.calendar.fullCalendar("getDate"),i=n.fudgeDateForProfileTimezone(new Date),"month"===this.currentView?t.getMonth()===i.getMonth()&&t.getFullYear()===i.getFullYear()?a=i:(a=new Date(t.getTime()),a.setDate(1)):this.isSameWeek(t,i)?a=i:(a=new Date(t.getTime()),a.setDate(a.getDate()-a.getDay())),this.setCurrentDate(a)},r.prototype.setCurrentDate=function(e){return this.updateFragment({view_start:e.toISOString()}),n.publish("Calendar/currentDate",e)},r.prototype.getCurrentDate=function(){var e;return e=this.dataFromDocumentHash(),e.view_start?n.fullCalendar.parseISO8601(e.view_start):n.fudgeDateForProfileTimezone(new Date)},r.prototype.setCurrentView=function(e){return this.updateFragment({view_name:e}),this.currentView=e,a.set("calendar_view",e)},r.prototype.getCurrentView=function(){var e;return this.currentView?this.currentView:(e=this.dataFromDocumentHash())&&e.view_name?e.view_name:a.get("calendar_view")?a.get("calendar_view"):"month"},r.prototype.loadView=function(e){return e!==this.currentView?(this.setCurrentView(e),n(".agenda-wrapper").removeClass("active"),this.header.showNavigator(),this.header.showPrevNext(),this.header.hideAgendaRecommendation(),"scheduler"!==e&&"agenda"!==e?(this.calendar.removeClass("scheduler-mode").removeClass("agenda-mode"),this.displayAppointmentEvents=null,this.scheduler.hide(),this.header.showAgendaRecommendation(),this.calendar.show(),this.schedulerNavigator.hide(),this.calendar.fullCalendar("refetchEvents"),this.calendar.fullCalendar("changeView","week"===e?"agendaWeek":"month"),this.calendar.fullCalendar("render")):"scheduler"===e?(this.calendar.addClass("scheduler-mode"),this.calendar.hide(),this.header.showSchedulerTitle(),this.schedulerNavigator.hide(),this.scheduler.show()):(this.calendar.hide(),this.scheduler.hide(),this.header.hidePrevNext())):void 0},r.prototype.loadAgendaView=function(){var e;return e=this.getCurrentDate(),this.agendaViewFetch(e)},r.prototype.agendaViewFetch=function(e){return e.setHours(0),e.setMinutes(0),e.setSeconds(0),this.setDateTitle(t.l("#date.formats.medium",e)),this.agenda.fetch(this.visibleContextList,e)},r.prototype.renderDateRange=function(e,i){return this.setDateTitle(t.l("#date.formats.medium",e)+" &ndash; "+t.l("#date.formats.medium",i)),window.setTimeout(function(){return n.screenReaderFlashMessage(t.t("agenda_view_displaying_start_end","Now displaying %{start} through %{end}",{start:t.l("#date.formats.long",e),end:t.l("#date.formats.long",i)}))},500)},r.prototype.showSchedulerSingle=function(){return this.calendar.show(),this.calendar.fullCalendar("changeView","agendaWeek"),this.header.showDoneButton(),this.schedulerNavigator.show()},r.prototype.schedulerSingleDoneClick=function(){return this.scheduler.doneClick(),this.header.showSchedulerTitle(),this.schedulerNavigator.hide()},d=n("<div />").appendTo("body"),r.prototype.colorizeContexts=function(){var e,t,n,i,a;return t=s.getColors(this.contextCodes.length,275),i=function(){var i,r,s,o;for(s=this.contextCodes,o=[],a=i=0,r=s.length;r>i;a=++i)n=s[a],e=t[a],o.push(".group_"+n+"{           color: "+e+";           border-color: "+e+";           background-color: "+e+";        }");return o}.call(this),d.html("<style>"+i.join("")+"</style>")},r.prototype.dataFromDocumentHash=function(){var e,t,i;e={};try{i=location.hash.substring(1),e=-1!==i.indexOf("=")?f(location.hash.substring(1))||{}:n.parseJSON(n.decodeFromHex(location.hash.substring(1)))||{}}catch(a){t=a,e={}}return e},r}()})}).call(this);