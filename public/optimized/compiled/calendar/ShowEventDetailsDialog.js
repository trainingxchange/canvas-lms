(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define(["jquery","i18n!calendar","compiled/util/Popover","compiled/calendar/CommonEvent","compiled/calendar/EditEventDetailsDialog","jst/calendar/eventDetails","jst/calendar/deleteItem","jst/calendar/reservationOverLimitDialog","compiled/calendar/MessageParticipantsDialog","compiled/fn/preventDefault","underscore","vendor/jquery.ba-tinypubsub","jquery.ajaxJSON","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins"],function(t,n,i,r,o,s,l,a,v,c,u,h){var p,d,m;return m=h.publish,d=function(e){return function(){return e.apply(this,[])}},p=function(){function r(t,n){this.dataSource=n,this.openShowPage=e(this.openShowPage,this),this.close=e(this.close,this),this.show=e(this.show,this),this.cancelAppointment=e(this.cancelAppointment,this),this.unreserveEvent=e(this.unreserveEvent,this),this.reserveEvent=e(this.reserveEvent,this),this.reserveSuccessCB=e(this.reserveSuccessCB,this),this.reserveErrorCB=e(this.reserveErrorCB,this),this.deleteEvent=e(this.deleteEvent,this),this.showEditDialog=e(this.showEditDialog,this),this.event=t,this.contexts=t.contexts}return r.prototype.showEditDialog=function(){return this.popover.hide(),new o(this.event).show()},r.prototype.deleteEvent=function(e,i){var r,o=this;return null==i&&(i={}),null==e&&(e=this.event),this.event.isNewEvent()?void 0:(r=e.object.url,e.assignment&&(r=t.replaceTags(this.event.deleteURL,"id",this.event.object.id)),t("<div />").confirmDelete({url:r,message:t(l({message:i.message||e.deleteConfirmation,hide_reason:"locked"!==e.object.workflow_state})),dialog:{title:i.dialogTitle||n.t("confirm_deletion","Confirm Deletion")},prepareData:function(e){return{cancel_reason:e.find("#cancel_reason").val()}},confirmed:function(){return o.popover.hide(),t.publish("CommonEvent/eventDeleting",e)},success:function(){return t.publish("CommonEvent/eventDeleted",e)}}))},r.prototype.reserveErrorCB=function(e){var i,r,o,s,l,v=this;for(s=0,l=e.length;l>s;s++)r=e[s],"participant has met per-participant limit"===r.message&&(o=!0,r.reschedulable=1===r.reservations.length,i=t(a(r)).dialog({resizable:!1,width:450,buttons:r.reschedulable?[{text:n.t("do_nothing","Do Nothing"),click:function(){return i.dialog("close")}},{text:n.t("reschedule","Reschedule"),"class":"btn-primary",click:function(){return i.disableWhileLoading(v.reserveEvent({cancel_existing:!0}).always(function(){return i.dialog("close")}))}}]:[{text:n.t("ok","OK"),click:function(){return i.dialog("close")}}]}));return o?void 0:(alert("Could not reserve event: "+e),t.publish("CommonEvent/eventSaveFailed",this.event))},r.prototype.reserveSuccessCB=function(){return this.popover.hide(),t.publish("CommonEvent/eventSaved",this.event)},r.prototype.reserveEvent=function(e){return null==e&&(e={}),t.publish("CommonEvent/eventSaving",this.event),t.ajaxJSON(this.event.object.reserve_url,"POST",e,this.reserveSuccessCB,this.reserveErrorCB)},r.prototype.unreserveEvent=function(){var e,t,i,r,o;for(r=this.event.childEvents,t=0,i=r.length;i>t;t++)if(e=r[t],null!=(o=e.object)?o.own_reservation:void 0)return void this.deleteEvent(e,{dialogTitle:n.t("confirm_unreserve","Confirm Reservation Removal"),message:n.t("prompts.unreserve_event","Are you sure you want to delete your reservation to this event?")})},r.prototype.cancelAppointment=function(e){var i,r,o,s=this;return r=e.data("url"),i=u.detect(this.event.calendarEvent.child_events,function(e){return e.url===r}),t("<div/>").confirmDelete({url:r,message:t(l({message:n.t("cancel_appointment","Are you sure you want to cancel your appointment with %{name}?",{name:(null!=(o=i.user)?o.short_name:void 0)||i.group.name})})),dialog:{title:n.t("confirm_removal","Confirm Removal"),width:"400px",resizable:!1},prepareData:function(e){return{cancel_reason:e.find("#cancel_reason").val()}},success:function(){var n,i;return s.event.object.child_events=u(s.event.object.child_events).reject(function(t){return t.url===e.data("url")}),e.remove(),i=t("#scheduler").prop("checked"),n=s.event.calendarEvent.child_events,i||0!==n.length?void 0:(t.publish("CommonEvent/eventDeleted",s.event),s.popover.hide())}})},r.prototype.show=function(e){var n,r,o,l,a,u,h,p,f,_,g,E,b,w,j,y=this;if(r=t.extend(!0,{},this.event,{can_reserve:null!=(u=this.event.object)?u.reserve_url:void 0}),this.event.contextInfo.can_create_appointment_groups&&(r.can_reserve=!1),null!=(h=this.event.object)?h.child_events:void 0)for(this.event.object.reserved&&(r.can_unreserve=!0,r.can_reserve=!1),p=this.event.object.child_events,l=0,a=p.length;a>l;l++)n=p[l],o={id:(null!=(f=n.user)?f.id:void 0)||n.group.id,name:(null!=(_=n.user)?_.short_name:void 0)||n.group.name,event_url:n.url},(null!=(g=r.reservations)?g:r.reservations=[]).push(o),n.user&&(null!=(E=r.reserved_users)?E:r.reserved_users=[]).push(o),n.group&&(null!=(b=r.reserved_groups)?b:r.reserved_groups=[]).push(o);return 0===(null!=(w=this.event.object)?w.available_slots:void 0)?(r.can_reserve=!1,r.availableSlotsText="None"):(null!=(j=this.event.object)?j.available_slots:void 0)>0&&(r.availableSlotsText=this.event.object.available_slots),r.showEventLink=r.fullDetailsURL(),r.showEventLink||(r.showEventLink=r.isAppointmentGroupEvent()),this.popover=new i(e,s(r)),this.popover.el.data("showEventDetailsDialog",this),this.popover.el.find(".view_event_link").click(c(this.openShowPage)),this.popover.el.find(".edit_event_link").click(c(this.showEditDialog)),this.popover.el.find(".delete_event_link").click(c(d(this.deleteEvent))),this.popover.el.find(".reserve_event_link").click(c(d(this.reserveEvent))),this.popover.el.find(".unreserve_event_link").click(c(this.unreserveEvent)),this.popover.el.find(".cancel_appointment_link").click(c(function(e){var n;return n=t(e.target).closest("li"),y.cancelAppointment(n)})),this.popover.el.find(".message_students").click(c(function(){return new v({timeslot:y.event.calendarEvent}).show()})),m("userContent/change")},r.prototype.close=function(){return this.popover?(this.popover.el.removeData("showEventDetailsDialog"),this.popover.hide()):void 0},r.prototype.openShowPage=function(e){var n;return n=t(e.target).attr("href").split("#"),n[0]+="?"+t.param({return_to:window.location.href}),window.location.href=n.join("#")},r}()})}).call(this);