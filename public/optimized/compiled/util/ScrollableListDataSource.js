(function(){var t=[].slice;define(["jquery","jquery.ajaxJSON"],function(e){return function(){function i(t,e){var i,s,r,h,n,o,l,a,u;this.list=t,this.pageOffset=null!=(i=e.pageOffset)?i:1,this.perPage=null!=(s=e.perPage)?s:25,this.pageKey=null!=(r=e.pageKey)?r:"page",this.perPageKey=null!=(h=e.perPageKey)?h:"per_page",this.itemIdsKey=null!=(n=e.itemIdsKey)?n:"item_ids",this.itemsKey=null!=(o=e.itemsKey)?o:"items",this.sortKey=null!=(l=e.sortKey)?l:"id",this.sortDir=null!=(a=e.sortDir)?a:"asc",this.params=null!=(u=e.params)?u:{},this.baseUrl=e.baseUrl,this.model=e.model}return i.prototype.load=function(t,e){return this.initialized=!0,null!=t.sortKey&&(this.sortKey=t.sortKey),null!=t.params&&(this.params=t.params),this.itemIds=null,this.items=[],this.pages=[],this.resetRequests(),this.fetchPage(0,e)},i.prototype.addItem=function(t){return this._addItem(this.modelize(t)),this.recompute()},i.prototype.updateItems=function(t){var e,i,s,r;for(t=this.modelize(t),e=t.length<=1,s=0,r=t.length;r>s;s++)i=t[s],i.get("visible")||i.get("defer_visibility_check")?null!=this.itemMap[i.id]?this._updateItem(i,e):this._addItem(i,e):this._removeItem(i,e);return this.recompute(!e)},i.prototype.removeItem=function(t){return this._removeItem(this.modelize(t)),this.recompute()},i.prototype.modelize=function(t){var e,i,s,r,h,n=this;if(i=function(t){return t=new n.model(t),t.list=n.list,t},null!=t.length){for(h=[],s=0,r=t.length;r>s;s++)e=t[s],h.push(i(e));return h}return i(t)},i.prototype.positionOrReload=function(t,e){var i,s;return i=this.positionFor(t,e),null==i||this.deferredPositionChecks?(null==(s=this.deferredPositionChecks)&&(this.deferredPositionChecks=[]),this.deferredPositionChecks.push(t.id),null):i},i.prototype.positionFor=function(t,e){var i,s,r,h,n,o,l,a=this;for(i="asc"===this.sortDir?function(t,e){return t.get(a.sortKey)<e.get(a.sortKey)}:function(t,e){return t.get(a.sortKey)>e.get(a.sortKey)},s=h=0,n=this.items.length-1;n>=0?n>h:h>n;s=n>=0?++h:--h)if(this.items[s]&&(r=e===s&&t.id===this.items[s].id&&t.get(this.sortKey)===this.items[s].get(this.sortKey),r||i(t,this.items[s])))return s>1&&!this.items[s-1]?null:s;return this.items.length===(null!=(o=this.itemIds)?o.length:void 0)||0===(null!=(l=this.itemIds)?l.length:void 0)?this.itemIds.length:void 0},i.prototype.refreshList=function(){var t,e,i,s,r;for(r=[],e=i=0,s=this.pages.length;s>=0?s>i:i>s;e=s>=0?++i:--i)"loaded"===this.pages[e]&&(t=e*this.perPage,r.push(this.list.replaceItems(t,this.items.slice(t,Math.min(t+this.perPage,this.itemIds.length)),this.itemIds.length)));return r},i.prototype.fetchRange=function(t,e){var i,s,r,h;if(null==e&&(e=t),!this.itemIds)return[];for(r=Math.floor(t/this.perPage),i=Math.floor(e/this.perPage),i=Math.min(i,Math.floor(this.itemIds.length/this.perPage)),s=h=r;i>=r?i>=h:h>=i;s=i>=r?++h:--h)this.pages[s]||this.fetchPage(s);return this.requests},i.prototype.fetchPage=function(t,i){var s,r,h=this;return s=e.extend({},this.params),s[this.perPageKey]=this.perPage,s[this.pageKey]=t+this.pageOffset,this.pages[t]="loading",null!=(r=this.requests[t])&&r.abort(),this.requests[t]=e.ajaxJSON(this.baseUrl,"GET",s,function(e){var s,r;return delete h.requests[t],r=h.modelize(e[h.itemsKey]),s=e[h.itemIdsKey],h.fetchedPage(t,s,r),"function"==typeof i?i(s.length):void 0})},i.prototype.fetchedPage=function(e,i,s){var r,h,n,o,l,a;return h=e*this.perPage,r=s.length,i.length<(e+1)*this.perPage&&(r=(null!=(o=[])?o:this.itemIds).length-h),this.setItemIds(i,e),null==(l=(n=this.items)[h])&&(n[h]=null),(a=this.items).splice.apply(a,[h,r].concat(t.call(s))),this.pages[e]="loaded",this.list.replaceItems(h,s,this.itemIds.length)},i.prototype.resetRequests=function(){var t,e,i,s;if(this.requests)for(s=this.requests,e=0,i=s.length;i>e;e++)t=s[e],null!=t&&t.abort();return this.requests=[]},i.prototype.setItemIds=function(t,e){var i;return i=null==this.itemIds,i||this.itemIds.toString()!==t.toString()?(this.itemIds=t,this.resetItemMap(),i?void 0:this.refetchPages(e)):void 0},i.prototype.resetItemMap=function(){var t,e,i,s;for(this.itemMap={},s=[],t=e=0,i=this.itemIds.length;i>=0?i>e:e>i;t=i>=0?++e:--e)s.push(this.itemMap[this.itemIds[t]]=t);return s},i.prototype.recompute=function(t){var e,i,s,r=this;if(null==t&&(t=!1),this.deferredPositionChecks)return this.fetchPage(0,function(){var e,i,s,h;for(h=r.deferredPositionChecks,i=0,s=h.length;s>i;i++)e=h[i],r.fetchRange(r.itemMap[e]);return delete r.deferredPositionChecks,t?r.refreshList():void 0});for(e=i=0,s=this.pages.length;s>=0?s>i:i>s;e=s>=0?++i:--i)"loaded"===this.pages[e]&&this.checkPage(e);return t?this.refreshList():void 0},i.prototype.refetchPages=function(t){var e,i,s,r,h;for(h=[],e=i=0,s=this.pages.length;s>=0?s>i:i>s;e=s>=0?++i:--i)"loaded"===this.pages[e]&&e!==t&&(e*this.perPage<this.itemIds.length?h.push(this.fetchPage(e)):(null!=(r=this.requests[e])&&r.abort(),h.push(delete this.pages[e])));return h},i.prototype.checkPage=function(t){var e,i,s,r;for(i=t*this.perPage,e=s=i,r=Math.min(i+this.perPage,this.itemIds.length);r>=i?r>s:s>r;e=r>=i?++s:--s)if(!this.items[e])return this.fetchPage(t)},i.prototype._addItem=function(t,e,i){var s;return null==e&&(e=!0),null==i&&(i=null),s=null!=i?i:this.positionOrReload(t),null!=s?(this.itemIds.splice(s,0,t.id),this.items.splice(s,0,t),e&&this.list.addedItem(t,s),this.resetItemMap()):void 0},i.prototype._updateItem=function(t,e,i){var s,r;return null==e&&(e=!0),null==i&&(i=null),s=this.itemMap[t.id],r=null!=i?i:this.positionOrReload(t,s),this.items[s]&&(t=this.items[s].set(t.toJSON())),null!=r?(r!==s&&this._moveItem(t,s,r),e&&this.list.updatedItem(t,s,r),this.resetItemMap()):void 0},i.prototype._moveItem=function(t,e,i){return i>e&&i--,this._removeItem(t,!1,e),this._addItem(t,!1,i)},i.prototype._removeItem=function(t,e,i){return null==e&&(e=!0),null==i&&(i=null),null==i&&(i=this.itemMap[t.id]),null!=i?(this.itemIds.splice(i,1),this.items.length>=i&&this.items.splice(i,1),e&&this.list.removedItem(t,i),this.resetItemMap()):void 0},i}()})}).call(this);