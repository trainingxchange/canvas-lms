(function(){var t=function(t,n){return function(){return t.apply(n,arguments)}};define(["jquery","jquery.ajaxJSON"],function(n){var e;return e=function(){function e(n,e,s){var i,r,l,a,h;this.url=n,this.handler=e,null==s&&(s={}),this.handle=t(this.handle,this),this.poll=t(this.poll,this),this.baseInterval=null!=(i=s.baseInterval)?i:1e3,this.backoffFactor=null!=(r=s.backoffFactor)?r:1.5,this.maxAttempts=null!=(l=s.maxAttempts)?l:8,this.handleErrors=null!=(a=s.handleErrors)?a:!1,this.initialDelay=null!=(h=s.initialDelay)?h:!0}return e.prototype.start=function(){return this.running?this.reset():this.nextPoll(!0),this},e.prototype.then=function(t){var n;return null==(n=this.callbacks)&&(this.callbacks=[]),this.callbacks.push(t)},e.prototype.reset=function(){return this.nextInterval=this.baseInterval,this.attempts=0},e.prototype.stop=function(t){var n,e,s,i;if(null==t&&(t=!1),this.running&&clearTimeout(this.running),delete this.running,t&&this.callbacks)for(i=this.callbacks,e=0,s=i.length;s>e;e++)(n=i[e])();return delete this.callbacks},e.prototype.poll=function(){var t=this;return this.running=!0,this.attempts++,n.ajaxJSON(this.url,"GET",{},this.handle,function(n,e){return t.handleErrors?t.handle(n,e):t.stop()})},e.prototype.handle=function(t,n){switch(this.handler(t,n)){case"continue":return this.nextPoll();case"reset":return this.nextPoll(!0);case"stop":return this.stop(!0);default:return this.stop()}},e.prototype.nextPoll=function(t){if(null==t&&(t=!1),t){if(this.reset(),!this.initialDelay)return this.poll()}else this.nextInterval=parseInt(this.nextInterval*this.backoffFactor);return this.attempts>=this.maxAttempts?this.stop():this.running=setTimeout(this.poll,this.nextInterval)},e}()})}).call(this);