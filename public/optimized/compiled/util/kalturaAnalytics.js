(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define(["jquery","underscore","vendor/jquery.cookie"],function(t,n){var i;return i=function(){function i(t,n,i){this.mediaId=t,this.mediaElement=n,this.pluginSettings=i,this.addListeners=e(this.addListeners,this),this.queueApiCall=e(this.queueApiCall,this),this.setupApiIframes=e(this.setupApiIframes,this),this.generateApiUrl=e(this.generateApiUrl,this),this.ensureAnalyticSession=e(this.ensureAnalyticSession,this),this.queueAnalyticEvent=e(this.queueAnalyticEvent,this),this.ensureAnalyticSession(),this.generateApiUrl(),this.defaultData={service:"stats",action:"collect","event:entryId":this.mediaId,"event:sessionId":this.kaSession,"event:isFirstInSession":"false","event:objectType":"KalturaStatsEvent","event:partnerId":this.pluginSettings.partner_id,"event:uiconfId":this.pluginSettings.kcw_ui_conf,"event:queryStringReferrer":window.location.href}}return i.prototype.queueAnalyticEvent=function(e){var i;return i=n.clone(this.defaultData),i["event:eventType"]=e,i["event:duration"]=this.mediaElement.duration,i["event:currentPoint"]=parseInt(1e3*this.mediaElement.currentTime),i["event:eventTimestamp"]=(new Date).getTime(),this.queueApiCall(this.apiUrl+t.param(i))},i.prototype.ensureAnalyticSession=function(){return this.kaSession=t.cookie("kaltura_analytic_tracker",void 0,{path:"/"}),this.kaSession?void 0:(this.kaSession=(Math.random().toString(16)+Math.random().toString(16)+Math.random().toString(16)).replace(/\./g,""),t.cookie("kaltura_analytic_tracker",this.kaSession,{path:"/"}))},i.prototype.generateApiUrl=function(){var e;return e="http:"===window.location.protocol?"http://"+this.pluginSettings.domain:"https://"+this.pluginSettings.domain,this.apiUrl=""+e+"/api_v3/index.php?"},i.prototype.setupApiIframes=function(e){var i,a,s,r,u,d;for(this.qIndex=0,this.iframes=[],a=u=0,d=e-1;d>=0?d>=u:u>=d;a=d>=0?++u:--u)s=document.createElement("iframe"),t(s).addClass("hidden kaltura-analytics"),t(document.body).append(s),r=[],i=function(e,t){return function(){var n;return(n=t.shift())?e.src=n:void 0}}(s,r),this.iframes[a]={iframe:s,queue:r,pinger:n.throttle(i,4e3)};return this.iframes},i.prototype.queueApiCall=function(e){return this.iframes||this.setupApiIframes(this.pluginSettings.parallel_api_calls||3),this.iframes[this.qIndex].queue.push(e),this.iframes[this.qIndex].pinger(),this.qIndex=(this.qIndex+1)%this.iframes.length,this.qIndex},i.prototype.addListeners=function(){var e,t,n=this;return this.queueAnalyticEvent(1),this.mediaElement.addEventListener("play",function(){return n.mediaElement.pauseObserved=!1,n.mediaElement.endedObserved=!1,n.mediaElement.endedOnce&&(n.queueAnalyticEvent(mediaId,16),n.mediaElement.endedOnce=!1),n.queueAnalyticEvent(3)}),this.mediaElement.addEventListener("canplay",function(){return n.queueAnalyticEvent(2)}),this.mediaElement.addEventListener("seeked",function(){return n.mediaElement.endedObserved?void 0:n.queueAnalyticEvent(17)}),this.mediaElement.addEventListener("pause",function(){return n.mediaElement.pauseObserved?void 0:n.mediaElement.pauseObserved=!0}),this.mediaElement.addEventListener("progress",function(){return n.mediaElement.endedOnce?void 0:n.queueAnalyticEvent(12)}),t=0,e=!1,this.mediaElement.addEventListener("playing",function(){var i;if(!n.mediaElement.listeningToPlaying)return i=setInterval(function(){var i,a,s,r;if(!n.mediaElement.paused&&!isNaN(n.mediaElement.duration)&&n.mediaElement.duration&&(n.mediaElement.isFullScreen!==e&&(n.queueAnalyticEvent(e?15:14),e=n.mediaElement.isFullScreen),r=[.25*n.mediaElement.duration,.5*n.mediaElement.duration,.75*n.mediaElement.duration,.98*n.mediaElement.duration],a=n.mediaElement.currentTime,!isNaN(a)&&a>0)){for(s=r.length-1;s>=0;)i=r[s],i>t&&a>=i&&(0===s?n.queueAnalyticEvent(4):1===s?n.queueAnalyticEvent(5):2===s?n.queueAnalyticEvent(6):3===s&&n.queueAnalyticEvent(7)),--s;return t=a}},50),n.mediaElement.listeningToPlaying=!0},!1)},i}(),function(e,t,n){var a;return n&&n.do_analytics?(a=new i(e,t,n),a.addListeners(),a):void 0}})}).call(this);