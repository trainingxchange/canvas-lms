(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,o=function(t,o){function r(){this.constructor=t}for(var i in o)e.call(o,i)&&(t[i]=o[i]);return r.prototype=o.prototype,t.prototype=new r,t.__super__=o.prototype,t};define(["i18n!jobs","jquery","vendor/slickgrid","jquery.ajaxJSON","jqueryui/dialog"],function(e,r,i){var n,s,a,l,h;return l=function(t){return r("#show-job .show-field").each(function(e,o){var i;return i=o.id.replace("job-",""),r(o).text(t[i]||"")}),r("#job-id-link").attr("href","/jobs?flavor=id&q="+t.id)},h=null,n=function(){function e(e,o,i){this.options=e,this.type_name=o,this.grid_name=i,this.change_flavor=t(this.change_flavor,this),this.refresh=t(this.refresh,this),this.restoreSelection=t(this.restoreSelection,this),this.saveSelection=t(this.saveSelection,this),this.setTimer=t(this.setTimer,this),this.data=[],this.$element=r(this.grid_name),this.setTimer(),this.query=""}return e.prototype.setTimer=function(){var t=this;return setTimeout(this.refresh,0),this.options.refresh_rate?setTimeout(function(){return t.refresh(t.setTimer)},this.options.refresh_rate):void 0},e.prototype.saveSelection=function(){var t,e,o,r,i;if("running"===this.type_name){for(this.oldSelected={},r=this.grid.getSelectedRows(),i=[],e=0,o=r.length;o>e;e++)t=r[e],i.push(this.oldSelected[this.data[t].id]=!0);return i}},e.prototype.restoreSelection=function(){var t,e,o,r,i,n;if("running"===this.type_name){for(t=0,o=[],n=this.data,r=0,i=n.length;i>r;r++)e=n[r],this.oldSelected[e.id]&&o.push(t),t+=1;return this.restoringSelection=!0,this.grid.setSelectedRows(o),this.restoringSelection=!1}},e.prototype.refresh=function(t){var e=this;return this.$element.queue(function(){return r.ajaxJSON(e.options.url,"GET",{flavor:e.options.flavor,q:e.query},function(o){var r,i,n,s,a,l,h,u;for(e.saveSelection(),e.data.length=0,e.loading={},l=o[e.type_name],n=0,a=l.length;a>n;n++)i=l[n],e.data.push(i);if(o.total&&o.total>e.data.length)for(r=s=h=e.data.length,u=o.total;u>=h?u>s:s>u;r=u>=h?++s:--s)e.data.push({});return e.sortData?e.sort(null,e.sortData):(e.grid.invalidate(),e.restoreSelection()),"function"==typeof t&&t(),"function"==typeof e.updated&&e.updated(),e.$element.dequeue()})})},e.prototype.change_flavor=function(t){return this.options.flavor=t,this.grid.setSelectedRows([]),this.refresh()},e.prototype.grid_options=function(){return{rowHeight:20}},e.prototype.init=function(){return this.columns=this.build_columns(),this.loading={},this.grid=new i.Grid(this.grid_name,this.data,this.columns,this.grid_options()),this},e}(),window.Jobs=function(n){function s(e,o,i){null==o&&(o="jobs"),null==i&&(i="#jobs-grid"),this.id_formatter=t(this.id_formatter,this),this.load=t(this.load,this),this.attempts_formatter=t(this.attempts_formatter,this),this.change_flavor=t(this.change_flavor,this),this.show_search=t(this.show_search,this),e.max_attempts&&(s.max_attempts=e.max_attempts),s.__super__.constructor.call(this,e,o,i),e.starting_query&&(this.query=e.starting_query),this.show_search(r("#jobs-flavor").val())}return o(s,n),s.prototype.search=function(t){return this.query=t,this.refresh()},s.prototype.show_search=function(t){switch(t){case"id":case"strand":case"tag":return r("#jobs-search").show(),r("#jobs-search").attr("placeholder",t);default:return r("#jobs-search").hide()}},s.prototype.change_flavor=function(t){return this.show_search(t),s.__super__.change_flavor.call(this,t)},s.prototype.attempts_formatter=function(t,e,o){var r,i,n;return this.data[t].id?(i=this.data[t].max_attempts||s.max_attempts,0===o?r="":i>o?r="has-failed-attempts":o===this.options.on_hold_attempt_count?(r="on-hold",o="hold"):r="has-failed-max-attempts",n="hold"===o?"":"/ "+i,"<span class='"+r+"'>"+o+n+"</span>"):""},s.prototype.load=function(t){var e=this;return this.$element.queue(function(){return t-=t%e.options.limit,e.loading[t]?void e.$element.dequeue():(e.loading[t]=!0,r.ajaxJSON(e.options.url,"GET",{flavor:e.options.flavor,q:e.query,offset:t},function(o){var r;return[].splice.apply(e.data,[t,t+o[e.type_name].length-t].concat(r=o[e.type_name])),r,e.grid.invalidate(),e.$element.dequeue()}))})},s.prototype.id_formatter=function(t){return this.data[t].id?this.data[t].id:(this.load(t),"<span class='unloaded-id'>-</span>")},s.prototype.build_columns=function(){return[{id:"id",name:e.t("columns.id","id"),field:"id",width:100,formatter:this.id_formatter},{id:"tag",name:e.t("columns.tag","tag"),field:"tag",width:200},{id:"attempts",name:e.t("columns.attempt","attempt"),field:"attempts",width:65,formatter:this.attempts_formatter},{id:"priority",name:e.t("columns.priority","priority"),field:"priority",width:60},{id:"strand",name:e.t("columns.strand","strand"),field:"strand",width:100},{id:"run_at",name:e.t("columns.run_at","run at"),field:"run_at",width:165}]},s.prototype.init=function(){var t=this;return s.__super__.init.call(this),this.grid.setSelectionModel(new i.RowSelectionModel),this.grid.onSelectedRowsChanged.subscribe(function(){var e,o;if(!t.restoringSelection)return o=t.grid.getSelectedRows(),e=1===(null!=o?o.length:void 0)?o[0]:-1,h=t.data[o[0]]||{},l(h)}),this},s.prototype.selectAll=function(){var t;return this.grid.setSelectedRows(function(){t=[];for(var e=0,o=this.data.length;o>=0?o>e:e>o;o>=0?e++:e--)t.push(e);return t}.apply(this)),this.grid.onSelectedRowsChanged.notify()},s.prototype.onSelected=function(t){var o,i,n,s;return n={flavor:this.options.flavor,q:this.query,update_action:t},this.grid.getSelectedRows().length<1?void alert("No jobs are selected"):(o=this.grid.getSelectedRows().length>1&&this.grid.getSelectedRows().length===this.data.length,!o||(i=function(){switch(t){case"hold":return e.t("confirm.hold_all","Are you sure you want to hold *all* jobs of this type and matching this query?");case"unhold":return e.t("confirm.unhold_all","Are you sure you want to unhold *all* jobs of this type and matching this query?");case"destroy":return e.t("confirm.destroy_all","Are you sure you want to destroy *all* jobs of this type and matching this query?")}}(),confirm(i))?(o||(n.job_ids=function(){var t,e,o,r;for(o=this.grid.getSelectedRows(),r=[],t=0,e=o.length;e>t;t++)s=o[t],r.push(this.data[s].id);return r}.call(this)),r.ajaxJSON(this.options.batch_update_url,"POST",n,this.refresh),this.grid.setSelectedRows([])):void 0)},s.prototype.updated=function(){return r("#jobs-total").text(this.data.length),1===this.data.length&&"jobs"===this.type_name?(this.grid.setSelectedRows([0]),this.grid.onSelectedRowsChanged.notify()):void 0},s.prototype.getFullJobDetails=function(t){return!h||h.handler?t():r.ajaxJSON(""+this.options.job_url+"/"+h.id,"GET",{flavor:this.options.flavor},function(e){return h.handler=e.handler,h.last_error=e.last_error,l(h),t()})},s}(n),a=function(r){function i(e){this.runtime_formatter=t(this.runtime_formatter,this),i.__super__.constructor.call(this,e,"running","#running-grid")}return o(i,r),i.prototype.runtime_formatter=function(t,e,o){var r,i,n,s;return n=(new Date-Date.parse(o))/1e3,i=n>=this.options.super_slow_threshold?"super-slow":n>this.options.slow_threshold?"slow":"",r="HH:mm:ss",n>86400&&(r="d\\dHH:mm:ss"),s=new Date(null,null,null,null,null,n).toString(r),n>2419200&&(s="FOREVA"),"<span class='"+i+"'>"+s+"</span>"},i.prototype.build_columns=function(){var t,o,r,n;for(o=[{id:"worker",name:e.t("columns.worker","worker"),field:"locked_by",width:90}].concat(i.__super__.build_columns.call(this)),o.pop(),o.push({id:"runtime",name:e.t("columns.runtime","runtime"),field:"locked_at",width:85,formatter:this.runtime_formatter}),r=0,n=o.length;n>r;r++)t=o[r],t.sortable=!0;return o},i.prototype.updated=function(){},i.prototype.init=function(){var t=this;return i.__super__.init.call(this),this.sort=function(e,o){var r;return t.sortData=o,e&&t.saveSelection(),r=o.sortCol.field,t.data.sort(function(t,e){var i,n,s;return i=t[r]||"",n=e[r]||"",s=i>n?1:n>i?-1:0,o.sortAsc||(s=-s),"locked_at"===r&&(s=-s),s}),t.grid.invalidate(),t.restoreSelection()},this.grid.onSort.subscribe(this.sort),this.grid.setSortColumn("runtime",!1),this.sortData={sortCol:{field:"locked_at"},sortAsc:!1}},i}(Jobs),s=function(t){function n(t){n.__super__.constructor.call(this,t,"tags","#tags-grid")}return o(n,t),n.prototype.build_columns=function(){return[{id:"tag",name:e.t("columns.tag","tag"),field:"tag",width:200},{id:"count",name:e.t("columns.count","count"),field:"count",width:50}]},n.prototype.grid_options=function(){return r.extend(n.__super__.grid_options.call(this),{enableCellNavigation:!1})},n.prototype.init=function(){return n.__super__.init.call(this),this.grid.setSelectionModel(new i.RowSelectionModel),this},n}(n),r.extend(window,{Jobs:Jobs,Workers:a,Tags:s}),r(document).ready(function(){var t;return r("#tags-flavor").change(function(){return window.tags.change_flavor(r(this).val())}),r("#jobs-flavor").change(function(){return window.jobs.change_flavor(r(this).val())}),r("#jobs-refresh").click(function(){return window.jobs.refresh()}),t=void 0===r("#jobs-search")[0].onsearch?"change":"search",r("#jobs-search").bind(t,function(){return window.jobs.search(r(this).val())}),r("#select-all-jobs").click(function(){return window.jobs.selectAll()}),r("#hold-jobs").click(function(){return window.jobs.onSelected("hold")}),r("#un-hold-jobs").click(function(){return window.jobs.onSelected("unhold")}),r("#delete-jobs").click(function(){return window.jobs.onSelected("destroy")}),r("#job-handler-show").click(function(){return window.jobs.getFullJobDetails(function(){return r("#job-handler-wrapper").clone().dialog({title:e.t("titles.job_handler","Job Handler"),width:900,height:700,modal:!0})}),!1}),r("#job-last_error-show").click(function(){return window.jobs.getFullJobDetails(function(){return r("#job-last_error-wrapper").clone().dialog({title:e.t("titles.last_error","Last Error"),width:900,height:700,modal:!0})}),!1})}),{Jobs:Jobs,Workers:a,Tags:s}})}).call(this);