(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function n(){this.constructor=t}for(var i in r)e.call(r,i)&&(t[i]=r[i]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t},n=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};define(["i18n!discussions","jquery","underscore","Backbone","compiled/util/BackoffPoller","compiled/arr/walk","compiled/arr/erase","jquery.ajaxJSON"],function(e,i,a,s,o,u,p){var l,d,h,c;return h=a.each,d={avatar_image_url:null,display_name:e.t("uknown_author","Unknown Author"),id:null},l=function(e){function a(){return this.parseNewEntry=t(this.parseNewEntry,this),this.parseEntry=t(this.parseEntry,this),c=a.__super__.constructor.apply(this,arguments)}return r(a,e),a.prototype.defaults={view:[],entries:[],new_entries:[],unread_entries:[],forced_entries:[]},a.prototype.url=function(){return""+this.get("root_url")+"?include_new_entries=1"},a.prototype.fetch=function(t){var e,r=this;return null==t&&(t={}),e=new o(this.url(),function(e,n){return 503===n.status?"continue":200!==n.status?"abort":(r.set(r.parse(e,200,n)),"function"==typeof t.success&&t.success(r,e),"stop")},{handleErrors:!0,initialDelay:!1,baseInterval:2e3,maxAttempts:12,backoffFactor:1.6}),e.start()},a.prototype.markAllAsRead=function(){return i.ajaxJSON(ENV.DISCUSSION.MARK_ALL_READ_URL,"PUT",{forced_read_state:!1}),this.setAllReadState("read")},a.prototype.markAllAsUnread=function(){return i.ajaxJSON(ENV.DISCUSSION.MARK_ALL_UNREAD_URL,"DELETE",{forced_read_state:!1}),this.setAllReadState("unread")},a.prototype.setAllReadState=function(t){return h(this.flattened,function(e){return e.read_state=t})},a.prototype.parse=function(t){return this.data=t,this.data.entries=[],this.flattened={},this.lastRoot=null,this.participants={},this.flattenParticipants(),u(this.data.view,"replies",this.parseEntry),h(this.data.new_entries,this.parseNewEntry),delete this.lastRoot,this.data},a.prototype.flattenParticipants=function(){var t,e,r,n,i;for(n=this.data.participants,i=[],e=0,r=n.length;r>e;e++)t=n[e],i.push(this.participants[t.id]=t);return i},a.prototype.setEntryAuthor=function(t){return t.author=null!=t.user_id?this.participants[t.user_id]:d},a.prototype.parseEntry=function(t){var e,r,i;return this.flattened[t.id]=t,e=this.flattened[t.parent_id],t.parent=e,r=t.id,n.call(this.data.unread_entries,r)>=0&&(t.read_state="unread"),i=t.id,n.call(this.data.forced_entries,i)>=0&&(t.forced_read_state=!0),this.setEntryAuthor(t),null!=t.editor_id&&(t.editor=this.participants[t.editor_id]),null!=t.parent_id?(t.root_entry=this.lastRoot,t.root_entry_id=this.lastRoot.id):(this.lastRoot=t,this.data.entries.push(t)),t},a.prototype.parseNewEntry=function(t){var e,r;if(this.flattened[t.id]=t,e=this.flattened[t.parent_id],this.setEntryAuthor(t),null!=e){for((null!=(r=e.replies)?r:e.replies=[]).push(t),t.parent=e;e.parent;)e=e.parent;return t.root_entry=e,t.root_entry_id=e.id}return this.data.entries.push(t)},a.prototype.maybeRemove=function(t){var e;return t.deleted&&!t.replies?(null!=(null!=(e=t.parent)?e.replies:void 0)&&p(t.parent.replies,t),delete this.flattened[t.id]):void 0},a}(s.Model)})}).call(this);