(function(){var t={}.hasOwnProperty,e=function(e,n){function r(){this.constructor=e}for(var a in n)t.call(n,a)&&(e[a]=n[a]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e};define(["underscore","Backbone","compiled/str/TextHelper"],function(t,n,r){var a,s,i,o;return i=n.Model,a=n.Collection,s=function(n){function s(){return o=s.__super__.constructor.apply(this,arguments)}return e(s,n),s.prototype.initialize=function(){return this.messageCollection=new a,this.on("change:messages",this.handleMessages)},s.prototype.parse=function(e){var n;return e.messages&&(n=function(n){return t.find(e.participants,{id:n})}),t.each(e.messages,function(t){var a,s,i,o,p;for(t.author=n(t.author_id),t.participants=[],t.participantNames=[],p=t.participating_user_ids,i=0,o=p.length;o>i;i++)a=p[i],a!==t.author_id&&(s=n(a))&&(t.participants.push(s),t.participantNames.push(s.name));return t.participants.length>2&&(t.summarizedParticipantNames=t.participantNames.slice(0,2),t.hiddenParticipantCount=t.participants.length-2),t.context_name=e.context_name,t.has_attachments=t.media_comment||t.attachments.length,t.bodyHTML=r.formatMessage(t.body)}),e},s.prototype.handleMessages=function(){return this.messageCollection.reset(this.get("messages")||[]),this.listenTo(this.messageCollection,"change:selected",this.handleSelection)},s.prototype.handleSelection=function(t,e){return e?this.messageCollection.each(function(e){return e!==t?e.set({selected:!1}):void 0}):void 0},s.prototype.unread=function(){return"unread"===this.get("workflow_state")},s.prototype.starred=function(){return this.get("starred")},s.prototype.toggleReadState=function(t){return null==t&&(t=this.unread()),this.set("workflow_state",t?"read":"unread")},s.prototype.toggleStarred=function(t){return null==t&&(t=!this.starred()),this.set("starred",t)},s.prototype.timestamp=function(){var e,n;return n=new Date(this.get("last_message_at")).getTime(),e=new Date(this.get("last_authored_message_at")).getTime(),new Date(t.max([n,e]))},s.prototype.toJSON=function(){return{conversation:t.extend(s.__super__.toJSON.apply(this,arguments),{unread:this.unread(),starred:this.starred(),timestamp:this.timestamp()})}},s}(i)})}).call(this);