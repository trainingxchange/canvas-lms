(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,i=function(t,i){function a(){this.constructor=t}for(var n in i)e.call(i,n)&&(t[n]=i[n]);return a.prototype=i.prototype,t.prototype=new a,t.__super__=i.prototype,t},a=[].slice;define(["i18n!images","jquery","underscore","compiled/models/File","vendor/FileAPI/FileAPI.min"],function(e,n,r,o,s){var l,h;return l=function(o){function l(){return this.present=t(this.present,this),this.save=t(this.save,this),h=l.__super__.constructor.apply(this,arguments)}return i(l,o),l.prototype.initialize=function(t,e){var i;return null==t&&(t={}),null==e&&(e={}),this.validations={maxSize:32e3,width:100,height:100,types:["jpeg","png","gif"]},r.extend(this.validations,null!=(i=e.validations)?i:{}),l.__super__.initialize.apply(this,arguments)},l.prototype.loadFile=function(){var t,e,i=this;return this.valid=!1,(e=s.getFiles(this.get("file"))[0])?(t=n.Deferred(),s.filterFiles([e],function(e,a){return i.validateFile(e,a,t)},function(){}),t.then(function(){var t;return t=1<=arguments.length?a.call(arguments,0):[],i.trigger.apply(i,["loaded"].concat(a.call(t)))},function(t){return i.error=t,i.trigger("load_failed",t)})):void 0},l.prototype.validateFile=function(t,i,a){var n;return n=t.type.replace(/^image\//,""),t.type===n?a.reject(e.t("not_an_image","Selected file is not an image")):null!=this.validations.types&&this.validations.types.indexOf(n)<0?a.reject(e.t("invalid_file_type","Invalid file type %{type}. Allowed types include: %{type_list}",{type:n,type_list:this.validations.types.join(", ")})):null==this.validations.width||null==this.validations.height||i.width===this.validations.width&&i.height===this.validations.height?this.validations.maxSize&&t.size>this.validations.maxSize?a.reject(e.t("invalid_file_size","Image file size is too large (max %{max} bytes, got %{actual})",{actual:t.size,max:this.validations.maxSize})):this.validations.backgroundColor?this.validateBackground(t,i,a):(this.valid=!0,a.resolve(t,i)):a.reject(e.t("invalid_dimensions","Invalid image dimensions (got %{actual}, expected: %{expected})",{actual:""+i.width+"x"+i.height,expected:""+this.validations.width+"x"+this.validations.height}))},l.prototype.validateBackground=function(t,i,a){var n=this;return s.Image(t).preview(t.width,t.height).get(function(o,s){return o?a.reject(e.t("error_checking_color","Error checking image color")):r.any(n.cornerColors(s),function(t){return t!==n.validations.backgroundColor})?a.reject(e.t("invalid_background_color","Background color must be %{color}",{color:n.validations.backgroundColor})):(n.valid=!0,a.resolve(t,i))})},l.prototype.cornerColors=function(t){var e;return e=t.getContext("2d"),[this.rgbToHex.apply(this,e.getImageData(0,0,1,1).data),this.rgbToHex.apply(this,e.getImageData(t.width-1,0,1,1).data),this.rgbToHex.apply(this,e.getImageData(t.width-1,t.height-1,1,1).data),this.rgbToHex.apply(this,e.getImageData(0,t.height-1,1,1).data)]},l.prototype.toHex=function(t){var e;return e=t.toString(16),1===e.length&&(e="0"+e),e},l.prototype.rgbToHex=function(t,e,i){return"#"+this.toHex(t)+this.toHex(e)+this.toHex(i)},l.prototype.save=function(){return null!=this.valid?this.valid?l.__super__.save.apply(this,arguments):!1:this.load().then(this.save)},l.prototype.present=function(){return r.extend(l.__super__.present.apply(this,arguments),this.validations,{error:this.error,valid:this.valid})},l}(o)})}).call(this);