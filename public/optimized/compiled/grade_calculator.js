(function(){define(["underscore"],function(n){var t,r;return r=function(t,r){var e,u;return u=[],e=[],n(t).each(function(n){return(r(n)?u:e).push(n)}),[u,e]},t=function(){function t(){}return t.calculate=function(t,r,e){var u,o=this;return u={},u.group_sums=n(r).map(function(n){return{group:n,current:o.create_group_sum(n,t,!0),"final":o.create_group_sum(n,t,!1)}}),u.current=this.calculate_total(u.group_sums,!0,e),u["final"]=this.calculate_total(u.group_sums,!1,e),u},t.create_group_sum=function(t,r,e){var u,o,i,s,c,a,l,f,p,h,d,g,m,v,_=this;return u=function(n,t){var r,e,u,o;for(e={},u=0,o=n.length;o>u;u++)r=n[u],e[r[t]]=r;return e},s=n(t.assignments).filter(function(t){return!n.isEqual(t.submission_types,["not_graded"])}),o=u(s,"id"),r=n(r).filter(function(n){return null!=o[n.assignment_id]}),e||(d=n(r).map(function(n){return n.assignment_id.toString()}),a=n.difference(n.keys(o),d),i=n(a).map(function(n){var t;return t={assignment_id:n,score:null}}),r.push.apply(r,i)),m=u(r,"assignment_id"),g=n(r).map(function(n){var t;return t={total:_.parse(o[n.assignment_id].points_possible),score:_.parse(n.score),submitted:null!=n.score&&""!==n.score,submission:n}}),f=e?n(g).filter(function(n){return n.submitted}):g,c=this.dropAssignments(f,t.rules),v=n.reduce(c,function(n,t){var r,e,u,o;return e=n[0],o=n[1],r=t.score,u=t.total,[e+_.parse(r),o+u]},[0,0]),h=v[0],l=v[1],p={possible:l,score:h,submission_count:n(g).filter(function(n){return n.submitted}).length,submissions:n(g).map(function(n){var t;return t={drop:n.drop,percent:_.parse(n.score/n.total),possible:n.total,score:_.parse(n.score),submission:n.submission,submitted:n.submitted}})}},t.dropAssignments=function(t,e){var u,o,i,s,c,a,l,f,p,h,d,g,m;if(e||(e={}),i=e.drop_lowest||0,o=e.drop_highest||0,p=e.never_drop||[],!i&&!o)return t;if(p.length>0?(m=r(t,function(t){return n.indexOf(p,t.submission.assignment_id)>=0}),u=m[0],t=m[1]):u=[],0===t.length)return u;for(i>=t.length&&(i=t.length-1),i+o>=t.length&&(o=0),a=t.length-i,l=a-o,t.sort(function(n,t){return n.submission.assignment_id-t.submission.assignment_id}),c=function(){var n,r,e;for(e=[],n=0,r=t.length;r>n;n++)h=t[n],h.total>0&&e.push(h.total);return e}().length>0,f=c?this.dropPointed(t,u,a,l):this.dropUnpointed(t,a,l),f.push.apply(f,u),s=n.difference(t,f),d=0,g=s.length;g>d;d++)h=s[d],h.drop=!0;return f},t.dropUnpointed=function(t,r,e){var u;return u=t.sort(function(n,t){return n.score-t.score}),n.chain(u).last(r).first(e).value()},t.dropPointed=function(t,e,u,o){var i,s,c,a,l,f=this;return l=function(){var n,r,e;for(e=[],n=0,r=t.length;r>n;n++)a=t[n],e.push(a.total);return e}(),c=Math.max.apply(Math,l),i=function(t,u,o){var i,s,l,p,h,d,g,m,v,_,b,w,y,M;if(0>=u&&(u=1),t.length<=u)return t;for(i=t.concat(e),w=r(i,function(n){return 0===n.total}),_=w[0],h=w[1],l=function(){var n,t,r;for(r=[],n=0,t=h.length;t>n;n++)a=h[n],r.push(a.score/a.total);return r}().sort(function(n,t){return n-t}),d=f.estimateQHigh(h,_,l),g=l[0],m=(g+d)/2,s=function(t,r){var i,s,c,l,f,p,h;return h=n(r).map(function(n){var r;return r=n.score-t*n.total,[r,n]}),f=h.sort(o),i=f.slice(0,u),l=n.reduce(i,function(n,t){var r,e;return r=t[0],e=t[1],n+r},0),s=function(){var n,t,r,e;for(e=[],n=0,t=i.length;t>n;n++)r=i[n],p=r[0],a=r[1],e.push(a);return e}(),c=n.reduce(e,function(n,r){return n+r.score-t*r.total},0),[l+c,s]},y=s(m,t),b=y[0],p=y[1],v=1/(2*u*Math.pow(c,2));!(v>d-g)&&(0>b?d=m:g=m,m=(g+d)/2,m!==d&&m!==g);)M=s(m,t),b=M[0],p=M[1];return p},s=i(t,u,function(n,t){var r,e,u,o;return r=n[0],u=n[1],e=t[0],o=t[1],e-r}),s=i(s,o,function(n,t){var r,e,u,o;return r=n[0],u=n[1],e=t[0],o=t[1],r-e})},t.estimateQHigh=function(t,r,e){var u,o,i,s,c;return r.length>0?(i=n(t).reduce(function(n,t){return n+t.total},0),u=Math.max(i,n(t).reduce(function(n,t){return n+t.score},0)),c=n(r).reduce(function(n,t){return n+t.score},0),o=u+c,o/i):s=e[e.length-1]},t.calculate_total=function(t,r,e){var u,o,i,s,c,a,l,f;return u=r?"current":"final",t=n(t).map(function(n){return n[u].weight=n.group.group_weight,n[u]}),"percent"===e?(c=n(t).filter(function(n){return n.possible}),o=n.reduce(c,function(n,t){return n+t.score/t.possible*t.weight},0),i=n.reduce(c,function(n,t){var r;return r=t.weight,n+r},0),0===i?o=null:100>i&&(o*=100/i),a={score:o&&Math.round(10*o)/10,possible:100}):(f=n.reduce(t,function(n,t){var r,e,u,o;return r=n[0],e=n[1],o=t.score,u=t.possible,[r+o,e+u]},[0,0]),l=f[0],s=f[1],a={score:l,possible:s})},t.parse=function(n){var t;return t=parseFloat(n),t&&isFinite(t)?t:0},t.letter_grade=function(t,r){var e,u;return 0>r&&(r=0),u=n(t).filter(function(n,e){return r>=100*n[1]||e===t.length-1}),e=u[0],e[0]},t}()})}).call(this);