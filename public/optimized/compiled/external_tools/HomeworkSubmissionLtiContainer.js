(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define(["Backbone","i18n!assignments","jquery","underscore","jst/assignments/homework_submission_tool","compiled/views/ExternalTools/ExternalContentReturnView","compiled/external_tools/ExternalToolCollection","compiled/views/assignments/ExternalContentHomeworkSubmissionView","jquery.disableWhileLoading"],function(t,i,o,s,n,r,l,u){var a;return a=function(){function a(t){this.uploadFailure=e(this.uploadFailure,this),this.uploadSuccess=e(this.uploadSuccess,this),this.submissionFailure=e(this.submissionFailure,this),this.submitAssignment=e(this.submitAssignment,this),this.disableLoader=e(this.disableLoader,this),this.redirectSuccessfulAssignment=e(this.redirectSuccessfulAssignment,this),this.checkFileStatus=e(this.checkFileStatus,this),this.renderedViews={},this.toolsForm=o(t),this.externalToolCollection=new l,this.externalToolCollection.add(ENV.EXTERNAL_TOOLS)}return a.prototype.loadExternalTools=function(){var e=this;return this.externalToolCollection.length>0?(o(".submit_from_external_tool_option").parent().show(),this.toolsForm.find("ul.tools").empty(),this.externalToolCollection.forEach(function(t){return e.addToolToMoreList(t)})):this.toolsForm.find("ul.tools li").text(i.t("no_tools_found","No tools found"))},a.prototype.embedLtiLaunch=function(e){var t,i;return i=this.externalToolCollection.findWhere({id:e.toString(10)}),this.cleanupViewsForTool(i),t=this.createReturnView(i),o("#submit_from_external_tool_form_"+e).append(t.el),t.render(),this.renderedViews[e.toString(10)].push(t)},a.prototype.cleanupViewsForTool=function(e){var t;return s.has(this.renderedViews,e.get("id"))&&(t=this.renderedViews[e.get("id")],t.forEach(function(e){return e.remove()})),this.renderedViews[e.get("id")]=[]},a.prototype.cancelSubmission=function(){return o("#submit_assignment").hide(),o(".submit_assignment_link").show()},a.prototype.addToolToMoreList=function(e){var t,i;return e.attributes.display_text=e.get("homework_submission").label,i=n(e.attributes),t=o(i).data("tool",e),this.toolsForm.find("ul.tools").append(t)},a.prototype.createReturnView=function(e){var t,i=this;return t=new r({model:e,launchType:"homework_submission",launchParams:{assignment_id:ENV.SUBMIT_ASSIGNMENT.ID},displayAsModal:!1}),t.on("ready",function(t){var s;return e=this.model,s=i.createHomeworkSubmissionView(e,t),s.parentView=i,this.remove(),o("#submit_from_external_tool_form_"+e.get("id")).append(s.el),i.cleanupViewsForTool(e),i.renderedViews[e.get("id")].push(s),s.render()}),t.on("cancel",function(){}),t},a.prototype.createHomeworkSubmissionView=function(e,i){var o,s=this;return o=new u({externalTool:e,model:new t.Model(i)}),o.on("relaunchTool",function(e){return this.remove(),this.parentView.embedLtiLaunch(e.get("id"))}),o.on("submit",function(e,t){return s.uploadFileFromUrl(e,t)}),o.on("cancel",function(){return this.parentView.cancelSubmission()}),o},a.prototype.checkFileStatus=function(e,t,i){var s=this;return o.ajaxJSON(e,"GET",{},function(o){"ready"===o.upload_status?t(o.attachment):"errored"===o.upload_status?i(o.message):setTimeout(function(){s.checkFileStatus(e,t,i)},2500)},function(e){return i(e.message)})},a.prototype.redirectSuccessfulAssignment=function(){window.onbeforeunload=function(){},window.location.reload(),this.loaderPromise.resolve()},a.prototype.disableLoader=function(){return this.loaderPromise.resolve()},a.prototype.submitAssignment=function(e){var t,i;t={submission:{submission_type:"online_upload",file_ids:[e.id]},comment:{text_comment:this.assignmentSubmission.get("comment")}},i="/api/v1/courses/"+ENV.COURSE_ID+"/assignments/"+ENV.SUBMIT_ASSIGNMENT.ID+"/submissions",o.ajaxJSON(i,"POST",t,this.redirectSuccessfulAssignment,this.disableLoader)},a.prototype.submissionFailure=function(){return this.loaderPromise.resolve(),thisForm.find(".submit_button").text(i.t("file_retrieval_error","Retrieving File Failed")),o.flashError(i.t("invalid_file_retrieval","There was a problem retrieving the file sent from this tool."))},a.prototype.uploadSuccess=function(e){this.checkFileStatus(e.status_url,this.submitAssignment,this.submissionFailure)},a.prototype.uploadFailure=function(){this.loaderPromise.resolve(),thisForm.find(".submit_button").text(i.t("file_retrieval_error","Retrieving File Failed"))},a.prototype.uploadFileFromUrl=function(e,t){var s,n,r;this.loaderPromise=o.Deferred(),r=o("#submit_from_external_tool_form_"+e.get("id")),this.assignmentSubmission=t,s={url:this.assignmentSubmission.get("url"),name:this.assignmentSubmission.get("text"),content_type:""},n="/api/v1/courses/"+ENV.COURSE_ID+"/assignments/"+ENV.SUBMIT_ASSIGNMENT.ID+"/submissions/"+ENV.current_user_id+"/files",o.ajaxJSON(n,"POST",s,this.uploadSuccess,this.uploadFailure),r.disableWhileLoading(this.loaderPromise,{buttons:{".submit_button":i.t("getting_file","Retrieving File...")}})},a}()})}).call(this);