(function(){define(["i18n!gradebook2","jquery","underscore","compiled/views/gradebook/HeaderFilterView","compiled/views/gradebook/OutcomeColumnView","compiled/util/NumberCompare","jst/gradebook2/outcome_gradebook_cell","jst/gradebook2/outcome_gradebook_student_cell"],function(e,t,n,r,o,u,i,l){var a;return a={filter:["mastery","near-mastery","remedial"],averageFn:"mean",dataSource:{},outcomes:[],options:{headerRowHeight:42,rowHeight:38,syncColumnCellResize:!0,showHeaderRow:!0,explicitInitialization:!0,fullWidthRows:!0,numberOfColumnsToFreeze:1},Events:{headerRowCellRendered:function(e,t){return a.View.headerRowCell(t)},headerCellRendered:function(e,t){return a.View.headerCell(t)},init:function(){var e,r;return r=t(".outcome-gradebook-wrapper .slick-header"),e=t(".outcome-gradebook-wrapper .slick-headerrow"),n.each(n.zip(r,e),function(e){var n,r;return n=e[0],r=e[1],t(r).insertBefore(t(n))})},sectionChangeFunction:function(e){return function(t){var n;return n=a.Util.toRows(a.dataSource.rollups,{section:t}),e.setData(n,!1),a.View.redrawHeader(e),e.invalidate()}},sort:function(e,t){var n,r,o,u,i;return n=t.grid,o=t.sortAsc,u=t.sortCol,i="student"===u.field?"_sortStudents":"_sortResults",r=n.getData().sort(function(e,t){return a.Events[i].call(null,e,t,o,u.field)}),n.setData(r),n.invalidate()},_sortStudents:function(e,t,n){var r,o,u,i;return"".localeCompare?(u=e.student.sortable_name,i=t.student.sortable_name,o=n?1:-1,u.localeCompare(i,window.I18n.locale||"en",{sensitivity:"accent",ignorePunctuation:!0,numeric:!0})*o):(u=e.student.sortable_name.toLowerCase(),i=t.student.sortable_name.toLowerCase(),r=n?1:-1,i>u?-1*r:u>i?1*r:0)},_sortResults:function(e,t,n,r){var o,i,l;return o=e[r],i=t[r],l=u(o,i,{descending:!n}),0===l?a.Events._sortStudents(e,t,n):l}},Util:{COLUMN_OPTIONS:{width:121,minWidth:50,sortable:!0},toGrid:function(e,t){return null==t&&(t={column:{},row:{}}),a.dataSource=e,[a.Util.toColumns(e.linked.outcomes,t.column),a.Util.toRows(e.rollups,t.row)]},toColumns:function(e,t){var r;return null==t&&(t={}),t=n.extend({},a.Util.COLUMN_OPTIONS,t),r=n.map(e,function(e){return n.extend({id:"outcome_"+e.id},{name:e.title,field:"outcome_"+e.id,cssClass:"outcome-result-cell",outcome:e},t)}),[a.Util._studentColumn()].concat(r)},_studentColumn:function(){var t;return t={width:228},n.extend({id:"student",name:e.t("learning_outcome","Learning Outcome"),field:"student",cssClass:"outcome-student-cell",headerCssClass:"outcome-student-header-cell",formatter:a.View.studentCell},n.extend(a.Util.COLUMN_OPTIONS,t))},toRows:function(e,t){var r;return null==t&&(t={}),r=n.reject(n.map(e,a.Util._toRowFn(t.section)),function(e){return null===e}),r.sort(function(e,t){return a.Events._sortStudents(e,t,!0)})},_toRowFn:function(e){return function(t){return a.Util._toRow(t,e)}},_toRow:function(e,t){var r,o;return a.Util.sectionFilter(t,e)?(o=a.Util.lookupStudent(e.links.user),t=a.Util.lookupSection(e.links.section),r={student:n.extend({grades_html_url:"/courses/"+t.course_id+"/grades/"+o.id+"#tab-outcomes",section:n.keys(a.sections).length>1?t:null},o),section:e.links.section},n.each(e.scores,function(e){return r["outcome_"+e.links.outcome]=e.score}),r):null},sectionFilter:function(e,t){return e?n.isEqual(e.toString(),t.links.section.toString()):!0},saveOutcomes:function(e){var t,r,o,u;return u=ENV.context_asset_string.split("_"),r=u[0],t=u[1],o="/"+r+"s/"+t+"/outcomes",a.outcomes=n.reduce(e,function(e,t){return t.url=o,e["outcome_"+t.id]=t,e},{})},saveOutcomePaths:function(e){return e.forEach(function(e){var t;return t=n.pluck(e.parts,"name").join(" > "),a.outcomes["outcome_"+e.id].path=t})},lookupOutcome:function(e){return a.outcomes[e]},saveStudents:function(e){return a.students=n.reduce(e,function(e,t){return e[t.id]=t,e},{})},lookupStudent:function(e){return a.students[e]},saveSections:function(e){return a.sections=n.reduce(e,function(e,t){return e[t.id]=t,e},{})},lookupSection:function(e){return a.sections[e]}},Math:{mean:function(e,t){var r;return null==t&&(t=!1),r=n.reduce(e,function(e,t){return e+t},0),t?Math.round(r/e.length):parseFloat((r/e.length).toString().slice(0,4))},median:function(e){var t,r;return r=n.sortBy(e,n.identity),e.length%2===0?(t=e.length/2,a.Math.mean(r.slice(t-1,t+1))):r[Math.floor(e.length/2)]},mode:function(e){var t,r,o;return t=n.chain(e).countBy(n.identity).reduce(function(e,t,n){return e.push([t,parseInt(n)]),e},[]).sortBy(n.first).reverse().value(),r=t[0][0],o=n.reject(t,function(e){return e[0]<r}),o=a.Math.mean(n.map(o,n.last),!0)},max:function(e){return Math.max.apply(Math,e)},min:function(e){return Math.min.apply(Math,e)},cnt:function(e){return e.length}},View:{cell:function(e,t,n,r){return a.View.cellHtml(n,r,!0)},cellHtml:function(e,t,r){var o,u;return u=a.Util.lookupOutcome(t.field),u&&n.isNumber(e)?(o=a.View.masteryClassName(e,u),r&&!n.include(a.filter,o)?"":i({score:Math.round(100*e)/100,className:o,masteryScore:u.mastery_points})):void 0},studentCell:function(e,t,n){return l(n)},masteryClassName:function(e,t){var n,r;return n=t.mastery_points,r=n/2,e>=n?"mastery":e>=r?"near-mastery":"remedial"},getColumnResults:function(e,t){return n.chain(e).pluck(t.field).filter(n.isNumber).value()},headerRowCell:function(e,n){var r,o,u,i,l;return u=e.node,r=e.column,o=e.grid,null==n&&(n=a.averageFn),"student"===r.field?a.View.studentHeaderRowCell(u,r,o):(i=a.View.getColumnResults(o.getData(),r),i.length?(l=a.Math[n].call(this,i),t(u).empty().append(a.View.cellHtml(l,r,!1))):t(u).empty())},redrawHeader:function(e,t){var r;return null==t&&(t=a.averageFn),a.averageFn=t,r=e.getColumns(),n.each(r,function(n){var r;return r=e.getHeaderRowColumn(n.id),a.View.headerRowCell({node:r,column:n,grid:e},t)})},studentHeaderRowCell:function(e,n,o){var u;return t(e).addClass("average-filter"),u=new r({grid:o,redrawFn:a.View.redrawHeader}),u.render(),t(e).append(u.$el)},headerCell:function(e,t){var r,u,i,l,s;return i=e.node,r=e.column,u=e.grid,null==t&&(t=a.averageFn),"student"!==r.field?(l=n.partial(a.View.calculateRatingsTotals,u,r),s=new o({el:i,attributes:r.outcome,totalsFn:l}),s.render()):void 0},calculateRatingsTotals:function(e,t){var r,o,u,i;return i=a.View.getColumnResults(e.getData(),t),u=t.outcome.ratings,u.result_count=i.length,o=n.pluck(u,"points"),r=n.countBy(i,function(e){return n.find(o,function(t){return e>=t})}),n.each(u,function(e){return e.percent=Math.round((r[e.points]||0)/i.length*100)})}}}})}).call(this);