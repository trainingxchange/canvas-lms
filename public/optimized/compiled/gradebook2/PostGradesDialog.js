(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,s=function(t,s){function n(){this.constructor=t}for(var r in s)e.call(s,r)&&(t[r]=s[r]);return n.prototype=s.prototype,t.prototype=new n,t.__super__=s.prototype,t};define(["i18n!modules","jquery","underscore","Backbone","timezone","compiled/views/DialogBaseView","jst/gradebook2/post_grades_dialog","jst/gradebook2/post_grades_summary","jst/gradebook2/post_grades_needs_grading","jst/gradebook2/post_grades_ungraded_count","compiled/handlebars_helpers","compiled/jquery.rails_flash_notifications","jqueryui/effects/slide","jquery.instructure_date_and_time","jquery.toJSON"],function(e,n,r,i,o,a,d,u,g,l){var p,c;return p=function(i){function o(){return this.sendGradesToSISApp=t(this.sendGradesToSISApp,this),this.needsGrading=t(this.needsGrading,this),c=o.__super__.constructor.apply(this,arguments)}return s(o,i),o.prototype.initialize=function(t,e,s){var r=this;return o.__super__.initialize.apply(this,arguments),t.bind("change:assignments_to_post",function(){return n(".assignments_to_post_count").html(t.assignments_to_post().length)}),t.bind("change:assignments_with_errors_count",function(){return n(".assignment-error-count").html(t.get("assignments_with_errors_count")),0===r.model.get("assignments_with_errors_count")?(n("#assignment-error-text").hide(),r.saveAssignments(),r.page="postSummary",r.render()):(n("#assignment-error-text").show(),n("#assignment-error-text").addClass("text-error"),n("#assignment-error-text").removeClass("text-info"))}),this.model=t,this.sis_app_url=e,this.sis_app_token=s,this.page=this.model.missing_and_not_unique().length>0?"assignmentErrors":"postSummary"},o.prototype.events={"click #needs-grading":"needsGrading","click .ignore-assignment":"ignoreAssignment","click .clickableRow":"goToUrl"},o.prototype.dialogOptions={id:"post-grades-container",title:e.t("post_grades_dialog_title","Post Grades to SIS"),maxHeight:450,maxWidth:650,minHeight:450,minWidth:650,width:650,height:450,resizable:!1,buttons:[]},o.prototype.initDialog=function(){return o.__super__.initDialog.apply(this,arguments)},o.prototype.render=function(){var t=this;switch(o.__super__.render.apply(this,arguments),this.model.assignments_with_errors_count()>0&&(this.page="assignmentErrors"),this.page){case"assignmentErrors":this.dialog.dialog({buttons:[{text:e.t("#buttons.ignore_all","Ignore All"),"class":"ignore_all",click:function(e){return e.preventDefault,t.model.ignore_all(),t.page="postSummary",t.render()}}]}),this.assignmentErrorsPage();break;case"postSummary":this.dialog.dialog({buttons:[{text:e.t("#button.post","Post Grades"),"class":"post_grades btn-primary",click:function(e){return e.preventDefault,t.postGrades()}}]}),this.postSummaryPage();break;case"needsGrading":this.dialog.dialog({buttons:[{text:e.t("#button.go_back","Go Back"),"class":"go_back",click:function(e){return e.preventDefault,t.page="postSummary",t.render()}}]}),this.needsGradingPage()}return this.datePicker(),this},o.prototype.ignoreAssignment=function(t){var e;return t.preventDefault(),e=""+n(t.target).closest("form").data("assignment-id"),this.model.ignore_assignment(e),n("#assignment-error-"+e).hide()},o.prototype.needsGrading=function(t){return t.preventDefault(),this.page="needsGrading",this.render()},o.prototype.needsGradingPage=function(){return this.$el.html(g({needs_grading:this.model.ungraded_submissions()}))},o.prototype.assignmentErrorsPage=function(){var t;return this.$el.html(d({assignments_to_post:this.model.assignments_to_post(),assignments:this.model.assignment_list(),missing_not_unique:this.model.missing_and_not_unique(),needs_grading:this.model.ungraded_submissions(),needs_grading_count:this.model.ungraded_submissions().length})),t=this,n(".assignment-name",this.$el).change(function(){var e,s,r,i;return s=n(this),e=s.closest(".input-container").prev(),i=s.val(),t.showErrorCircle(e,""===i),r=parseInt(s.closest("form.passback-form").data("assignment-id")),t.model.update_assignment(r,{name:i})})},o.prototype.postSummaryPage=function(){return this.$el.html(u({assignments_to_post:this.model.assignments_to_post(),needs_grading:this.model.ungraded_submissions(),needs_grading_count:this.model.ungraded_submissions().length})),this.postUngraded()},o.prototype.goToUrl=function(t){return t.preventDefault(),window.location=n(t.currentTarget).data("url")},o.prototype.postUngraded=function(){return this.model.ungraded_submissions().length>0?n("#ungraded_count",this.$el).html(l({needs_grading_count:this.model.ungraded_submissions().length})):void 0},o.prototype.showErrorCircle=function(t,e){return null==e&&(e=!0),e?t.addClass("data-circle-error").removeClass("data-circle-clean"):t.addClass("data-circle-clean").removeClass("data-circle-error")},o.prototype.datePicker=function(){var t;return t=this,n(".date_field",this.$el).datetime_field().change(function(){var e,s,r,i,o;return s=n(this),i=s.data("date"),o=!0,null!=i&&(i=n.unfudgeDateForProfileTimezone(i).toISOString(),o=!1),e=s.closest(".input-container").prev(),t.showErrorCircle(e,o),r=parseInt(s.closest("form.passback-form").data("assignment-id")),null!=r?t.model.update_assignment(r,{due_at:i}):n.flashError("Unable to save due date, assignment_id unavailable")})},o.prototype.saveAssignments=function(){var t,e,s,n,r;for(n=this.model.modified_assignments(),r=[],e=0,s=n.length;s>e;e++)t=n[e],r.push(this.saveAssignmentToCanvas(t));return r},o.prototype.saveAssignmentToCanvas=function(t){var e,s;return s="/api/v1/courses/"+this.model.get("course_id")+"/assignments/"+t.id,e={assignment:{name:t.name,due_at:t.due_at}},n.ajax(s,{type:"PUT",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",error:function(){return n.flashError("An error occurred saving assignment ("+t.id+"). HTTP Error "+e.status+" : "+e.statusText)}})},o.prototype.sendGradesToSISApp=function(t,e){return n.ajax(e,{type:"POST",data:JSON.stringify(t),headers:{Authorization:this.sis_app_token},contentType:"application/json; charset=utf-8",error:function(t){return n.flashError("An error occurred posting your grades. HTTP Error "+t.status+" : "+t.statusText)},success:function(){return n.flashMessage("Assignments are being posted.")}})},o.prototype.postGrades=function(){var t,e;return t={},t.canvas_domain=document.location.origin,t.assignments=r.map(this.model.get("assignments_to_post"),function(t){return t.id}),this.model.get("section_id")?(t.section_id=this.model.get("integration_section_id"),e=this.sis_app_url+"/grades/section/"+this.model.get("integration_section_id"),this.sendGradesToSISApp(t,e),this.close()):this.model.get("integration_course_id")?(t.course_id=this.model.get("integration_course_id"),e=this.sis_app_url+"/grades/course/"+this.model.get("integration_course_id"),this.sendGradesToSISApp(t,e),this.close()):(n.flashError("Grades can't be posted because this course or section was not imported from your SIS."),this.close())},o}(a)})}).call(this);