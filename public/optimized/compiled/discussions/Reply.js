(function(){var t=function(t,i){return function(){return t.apply(i,arguments)}};define(["Backbone","underscore","i18n!discussions.reply","jquery","compiled/models/Entry","str/htmlEscape","jst/discussions/_reply_attachment","compiled/fn/preventDefault","tinymce.editor_box"],function(i,e,s,n,r,o,h,a){var c;return c=function(){function i(i,e){var s=this;this.view=i,this.options=null!=e?e:{},this.onPostReplyError=t(this.onPostReplyError,this),this.onPostReplySuccess=t(this.onPostReplySuccess,this),this.submit=t(this.submit,this),this.hideNotification=t(this.hideNotification,this),this.hide=t(this.hide,this),this.el=this.view.$(".discussion-reply-action:first"),this.discussionEntry=this.el.closest(".discussion_entry"),0===this.discussionEntry.length&&(this.discussionEntry=this.el.closest(".entry")),this.form=this.discussionEntry.find("form.discussion-reply-form:first").submit(a(this.submit)),this.textArea=this.getEditingElement(),this.form.find(".cancel_button").click(this.hide),this.form.on("click",".toggle-wrapper a",function(t){return t.preventDefault(),s.textArea.editorBox("toggle"),n(t.currentTarget).siblings("a").andSelf().toggle()}),this.form.delegate(".alert .close","click",a(this.hideNotification)),this.editing=!1}return i.prototype.toggle=function(){return this.editing?this.hide():this.edit()},i.prototype.edit=function(){return this.form.addClass("replying"),this.discussionEntry.addClass("replying"),this.textArea.editorBox({focus:!0,tinyOptions:{width:"100%"}}),this.editing=!0,this.trigger("edit",this)},i.prototype.hide=function(){return this.content=this.textArea._justGetCode(),this.textArea._removeEditor(),this.form.removeClass("replying"),this.discussionEntry.removeClass("replying"),this.textArea.val(this.content),this.editing=!1,this.trigger("hide",this),this.discussionEntry.find(".discussion-reply-action").focus()},i.prototype.hideNotification=function(){return this.view.model.set("notification","")},i.prototype.submit=function(){var t;return this.hide(),this.textArea._setContentCode(""),this.view.model.set("notification","<div class='alert alert-info'>"+s.t("saving_reply","Saving reply...")+"</div>"),t=new r(this.getModelAttributes()),t.save(null,{success:this.onPostReplySuccess,error:this.onPostReplyError,multipart:t.get("attachment"),proxyAttachment:!0}),this.hide(),this.removeAttachments()},i.prototype.getEditingElement=function(){return this.view.$(".reply-textarea:first")},i.prototype.getModelAttributes=function(){var t;return t=(new Date).getTime(),{summary:n("<div/>").html(this.content).text(),message:this.content,parent_id:this.options.topLevel?null:this.view.model.get("id"),user_id:ENV.current_user_id,created_at:t,updated_at:t,attachment:this.form.find("input[type=file]")[0],"new":!0}},i.prototype.onPostReplySuccess=function(t){return this.view.model.set("notification",""),this.trigger("save",t)},i.prototype.onPostReplyError=function(t){return this.view.model.set("notification","<div class='alert alert-info'>"+s.t("error_saving_reply","*An error occured*, please post your reply again later",{wrapper:"<strong>$1</strong>"})+"</div>"),this.textArea.val(t.get("message")),this.edit()},i.prototype.addAttachment=function(){return this.form.find("ul.discussion-reply-attachments").append(h()),this.form.find("a.discussion-reply-add-attachment").hide()},i.prototype.removeAttachment=function(t){return t.closest("ul.discussion-reply-attachments li").remove(),this.form.find("a.discussion-reply-add-attachment").show()},i.prototype.removeAttachments=function(){return this.form.find("ul.discussion-reply-attachments").empty(),this.form.find("a.discussion-reply-add-attachment").show()},i}(),e.extend(c.prototype,i.Events),c})}).call(this);