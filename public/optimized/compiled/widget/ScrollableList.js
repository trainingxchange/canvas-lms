(function(){define(["jquery","compiled/util/ScrollableListDataSource","compiled/util/shortcut","compiled/jquery/scrollIntoView","jquery.disableWhileLoading"],function(t,e,i){return function(){function s(i,s){var o,l,r,n=this;this.$scroller=i,null==s&&(s={}),this.$scroller.css("overflow","auto"),this.ds=new e(this,s),this.$scroller.scroll(function(t){return n.scroll(t)}),this.$list=this.$scroller.find("ul").eq(0),this.$list.length||(this.$list=t("<ul>").appendTo(this.$scroller)),this.$list.addClass("scrollable-list"),this.itemTemplate=null!=(o=s.itemTemplate)?o:function(t){return"<li>"+t+"</li>"},this.elementHeight=null!=(l=s.elementHeight)?l:this.inferElementHeight(),this.fetchBuffer=null!=(r=s.fetchBuffer)?r:20,this.firstLoad=!0,s.noAutoLoad||this.load(),this.clicked&&this.$list.delegate(".scrollable-list > li","click",this.clicked)}return i(s,"ds","addItem","updateItems","removeItem"),s.prototype.item=function(t){return this.ds.items[this.positionFor(t)]},s.prototype.$item=function(t){var e;return e=this.$itemAt(this.positionFor(t)),e.length?e:void 0},s.prototype.$itemAt=function(t){return this.$items().eq(t)},s.prototype.$items=function(){return this.$list.find("> li").not(".scrollable-list-item-deleting,.scrollable-list-item-moving")},s.prototype.addedItem=function(e,i){var s;return this.prepareItems(i-1),s=t(this.itemTemplate(e)),0===i?s.prependTo(this.$list):s.insertAfter(this.$itemAt(i-1)),this.setCount(this.ds.itemIds.length),"function"==typeof this.added?this.added(e,s):void 0},s.prototype.updateItem=function(t){return this.updateItems([t])},s.prototype.updatedItem=function(t,e,i){var s,o,l;return this.prepareItems(Math.max(i-1,e)),this.$itemAt(e).replaceWith(this.itemTemplate(t)),o=this.$items(),s=o.eq(e),e!==i&&(l=s.clone(),s.addClass("scrollable-list-item-moving").animate({opacity:"toggle",height:"toggle"},200,function(){return s.remove()}),0===i?l.prependTo(this.$list):l.insertAfter(o.eq(i-1)),l.animate({opacity:"toggle",height:"toggle"},0).animate({opacity:"toggle",height:"toggle"},200,function(){return l.scrollIntoView()})),"function"==typeof this.updated?this.updated(t,null!=l?l:s):void 0},s.prototype.removedItem=function(t,e){var i,s=this;return i=this.$itemAt(e),i.addClass("scrollable-list-item-deleting").fadeOut("fast",function(){return i.remove(),s.setCount(s.ds.itemIds.length),s.fetchVisible()}),"function"==typeof this.removed?this.removed(t,i):void 0},s.prototype.replaceItems=function(e,i,s){var o,l,r;return this.setCount(s),this.prepareItems(e-1),o=this.$items().slice(e,e+i.length),r=[],o.length<i.length&&(r=i.slice(o.length),i=i.slice(0,o.length)),t(function(){var t,e,s;for(s=[],t=0,e=i.length;e>t;t++)l=i[t],s.push(this.itemTemplate(l));return s}.call(this).join("")).insertBefore(o.eq(0)),o.remove(),r.length?this.$list.append(function(){var t,e,i;for(i=[],t=0,e=r.length;e>t;t++)l=r[t],i.push(this.itemTemplate(l));return i}.call(this).join("")):void 0},s.prototype.fetchVisible=function(){var t,e;return this.ds.itemIds?(e=Math.floor(this.$scroller.scrollTop()/this.elementHeight),t=Math.floor((this.$scroller.scrollTop()+this.$scroller.height()-1)/this.elementHeight)+this.fetchBuffer,t>=this.numItems&&(t=Math.max(this.numItems,1)-1),e=Math.max(0,e-this.fetchBuffer),this.prepareItems(t),this.ds.fetchRange(e,t)):[]},s.prototype.prepareItems=function(t){var e,i;return i=t-this.$items().length,i>0?this.$list.append(function(){var t,s;for(s=[],e=t=0;i>=0?i>=t:t>=i;e=i>=0?++t:--t)s.push("<li class='scrollable-list-item-loading' />");return s}().join("")):void 0},s.prototype.scroll=function(){var t=this;return this.scrollCb&&clearTimeout(this.scrollCb),this.scrollCb=setTimeout(function(){return delete t.scrollCb,t.fetchVisible()},50)},s.prototype.inferElementHeight=function(){var e,i;return e=t(this.itemTemplate({})).appendTo(this.$list),i=e.height(),e.remove(),i},s.prototype.positionFor=function(t){return this.ds.itemMap[t]},s.prototype.loadItem=function(e){var i,s,o=this;return null!=e&&null!=(s=this.positionFor(e))&&(this.prepareItems(s),this.$item(e).scrollIntoView({toTop:this.firstLoad})),i=this.fetchVisible(),i.length||(i=[{}]),t.when.apply(t,i).done(function(){var t,i,l;return null!=s&&(l=[o.ds.items[s],o.$item(e)],i=l[0],t=l[1]),"function"==typeof o.loaded?o.loaded(e,i,t):void 0})},s.prototype.load=function(t){var e,i,s,o=this;return null==t&&(t={}),s=t.sortKey&&t.sortKey!==this.ds.sortKey,i=t.params&&JSON.stringify(t.params)!==JSON.stringify(this.ds.params),s||i||!this.ds.initialized||t.force?(this.fetchThrough=0,this.$list.empty(),this.$list.css("min-height","0px"),e=this.ds.load(t,function(e){return o.setCount(e),o.loadItem(t.loadId),"function"==typeof t.cb&&t.cb(),o.firstLoad=!1}),this.$scroller.disableWhileLoading(e)):(this.loadItem(t.loadId),this.firstLoad=!1)},s.prototype.setCount=function(t){var e;return this.numItems=t,this.$list.css("min-height",this.elementHeight*this.numItems+"px"),e=this.$items(),e.length>this.numItems?e.slice(this.numItems).remove():void 0},s}()})}).call(this);