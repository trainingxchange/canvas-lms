(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","underscore","compiled/widget/TokenSelectorList","compiled/collections/RecipientCollection","jquery.instructure_misc_helpers","compiled/jquery/scrollIntoView"],function(e,s,i,n){return function(){function l(s,i,n){var l=this;this.input=s,this.url=i,this.options=null!=n?n:{},this.select=t(this.select,this),this.close=t(this.close,this),this.click=t(this.click,this),this.mouseDown=t(this.mouseDown,this),this.mouseMove=t(this.mouseMove,this),this.autoSelectFirst=t(this.autoSelectFirst,this),this.stack=[],this.cache={},this.$container=e("<div />").addClass("autocomplete_menu"),this.$menu=e("<div />"),this.$container.append(e("<div />").append(this.$menu)),this.$container.css("top",0).css("left",0),this.mode="input",e("body").append(this.$container),this.reposition=function(){var t;return t=l.input.bottomOffset(),l.$container.css("top",t.top),l.$container.css("left",t.left)},e(window).resize(this.reposition),this.close()}return l.prototype.autoSelectFirst=function(t){return null==t&&(t=this.list),t===this.list&&null==this.selection?this.select(t.first(),!0):void 0},l.prototype.browse=function(t){return this.uiLocked?void 0:(this.clear(),this.close(),this.open(),this.list=this.listForQuery(this.preparePost(t)),this.list.appendTo(this.$menu),this.autoSelectFirst(),!0)},l.prototype.mouseMove=function(t){var s;if(!this.uiLocked)return s=e(t.target).closest("li"),s.hasClass("selectable")||(s=null),this.select(s)},l.prototype.mouseDown=function(){var t=this;return setTimeout(function(){return t.input.focus()},0)},l.prototype.click=function(t){return this.uiLocked?void 0:(this.mouseMove(t),this.selection&&(e(t.target).closest("a.expand").length?this.selectionExpanded()?this.collapse():this.expandSelection():this.selectionToggleable()&&e(t.target).closest("a.toggle").length?this.toggleSelection():this.selectionExpanded()?this.collapse():this.selectionExpandable()?this.expandSelection():(this.toggleSelection(!0),this.clear(),this.close())),this.input.focus())},l.prototype.captureKeyDown=function(t){var e,i,n;if(e=null!=(i=null!=(n=t.originalEvent)?n.keyIdentifier:void 0)?i:t.which,this.uiLocked)return!0;if(this.$menu.find(".no-results").length>0&&s.include([13,"Enter"],e))return t.preventDefault();switch(e){case"Backspace":case"U+0008":case 8:if(""===this.input.val())return this.listExpanded()?this.collapse():this.$menu.is(":visible")?this.close():this.input.removeLastToken(),!0;break;case"Tab":case"U+0009":case 9:if(!this.selection||!this.selectionToggleable()&&this.selectionExpandable()||this.toggleSelection(!0),this.clear(),this.close(),this.selection)return!0;break;case"Enter":case 13:return this.selectionExpanded()?(this.collapse(),!0):this.selectionExpandable()&&!this.selectionToggleable()?(this.expandSelection(),!0):(this.selection&&(this.toggleSelection(!0),this.clear()),this.close(),!0);case"Shift":case 16:return!1;case"Esc":case"U+001B":case 27:return this.$menu.is(":visible")?(this.close(),!0):!1;case"U+0020":case 32:if(this.selectionToggleable()&&"menu"===this.mode)return this.toggleSelection(),!0;break;case"Left":case 37:if(this.listExpanded()&&0===this.input.caret())return this.selectionExpanded()||""===this.input.val()?this.collapse():this.select(this.list.first()),!0;break;case"Up":case 38:return this.selectPrev(),!0;case"Right":case 39:if(this.input.caret()===this.input.val().length&&this.expandSelection())return!0;break;case"Down":case 40:return this.selectNext(),!0;case"U+002B":case 187:case 107:if(this.selectionToggleable()&&"menu"===this.mode)return this.toggleSelection(!0),!0;break;case"U+002D":case 189:case 109:if(this.selectionToggleable()&&"menu"===this.mode)return this.toggleSelection(!1),!0}return this.mode="input",this.updateSearch(),!1},l.prototype.open=function(){return this.$container.show(),this.reposition()},l.prototype.close=function(){var t,e,s,i,n,l,o,c;for(this.uiLocked=!1,this.$container.hide(),null!=(l=this.list)&&l.remove(),o=this.stack,e=i=0,n=o.length;n>i;e=++i)c=o[e],t=c[0],s=c[1],s.remove();return this.list=null,this.stack=[],this.$menu.css("left",0),this.select(null),this.input.selectorClosed()},l.prototype.clear=function(){return clearTimeout(this.timeout),this.input.val(""),this.select(null)},l.prototype.blur=function(){var t=this;return setTimeout(function(){return t.input.hasFocus()||t.$container.find(":focus").length>0?void 0:t.close()},0)},l.prototype.listExpanded=function(){return this.stack.length?!0:!1},l.prototype.parent=function(){return this.listExpanded()?this.stack[this.stack.length-1][0]:null},l.prototype.selectionExpanded=function(){var t,e;return null!=(t=null!=(e=this.selection)?e.hasClass("expanded"):void 0)?t:!1},l.prototype.selectionExpandable=function(){var t,e;return null!=(t=null!=(e=this.selection)?e.hasClass("expandable"):void 0)?t:!1},l.prototype.selectionToggleable=function(t){var e;return null==t&&(t=this.selection),(null!=(e=null!=t?t.hasClass("toggleable"):void 0)?e:!1)&&!this.selectionExpanded()},l.prototype.expandSelection=function(){var t,e=this;return!this.selectionExpandable()||this.selectionExpanded()?!1:(this.stack.push([this.selection,this.list]),this.clear(),this.$menu.css("width",100*(this.stack.length+1)+"%"),this.uiLocked=!0,t=this.listForQuery(this.preparePost()),t.insertAfter(this.list),this.$menu.animate({left:"-="+this.$menu.parent().css("width")},"fast",function(){return e.list.hide(function(){return e.list=t,e.autoSelectFirst(),e.uiLocked=!1})}))},l.prototype.collapse=function(){var t,e,s,i=this;return this.listExpanded()?(s=this.stack.pop(),t=s[0],e=s[1],this.uiLocked=!0,e.restore(),this.$menu.animate({left:"+="+this.$menu.parent().css("width")},"fast",function(){return i.list.remove(),i.list=e,i.input.val(i.list.query.search),i.select(t),i.uiLocked=!1})):!1},l.prototype.toggleSelection=function(t,e,s){var i,n;return null==e&&(e=this.selection),null==s&&(s=!1),null!=t||this.selectionToggleable(e)?(i=e.data("id"),null==t&&(t=!e.hasClass("on")),t?(this.selectionToggleable(e)&&!s&&e.addClass("on"),this.input.addToken({value:i,text:null!=(n=e.data("text"))?n:e.text(),noClear:!0,data:e.data("user_data")})):(s||e.removeClass("on"),this.input.removeToken({value:i})),s?void 0:this.updateSelectAll(e)):!1},l.prototype.updateSelectAll=function(t,e){var s,i,n,l=this;return null==e&&(e=0),n=t.data("user_data").selectAll,i=e?this.stack[this.stack.length-e][1]:this.list,i.canSelectAll()?(i.updateSelectAll(n,function(t,e){return l.toggleSelection(t,e,!0)}),e<this.stack.length&&(e++,s=this.stack[this.stack.length-e][0],this.selectionToggleable(s))?(i.selectAllActive()?s.addClass("on"):s.removeClass("on"),this.updateSelectAll(s,e)):void 0):void 0},l.prototype.select=function(t,e){var s;return null==e&&(e=!1),(null!=t?t[0]:void 0)!==(null!=(s=this.selection)?s[0]:void 0)?(this.selection=(null!=t?t.length:void 0)?(t.focus(),t.scrollIntoView({ignore:{border:!0}}),t):null,e?void 0:this.mode=t?"menu":"input"):void 0},l.prototype.selectNext=function(t){var e,s;return null==t&&(t=!1),this.select(this.selection?this.selection.next().length?this.selection.next():this.selection.parent("ul").next().length?this.selection.parent("ul").next().find("li").first():null:null!=(e=this.list)?e.first():void 0,t),(null!=(s=this.selection)?s.hasClass("message"):void 0)?this.selectNext(t):void 0},l.prototype.selectPrev=function(){var t,e,s;return this.select(this.selection?(null!=(t=this.selection)?t.prev().length:void 0)?this.selection.prev():this.selection.parent("ul").prev().length?this.selection.parent("ul").prev().find("li").last():null:null!=(e=this.list)?e.last():void 0),(null!=(s=this.selection)?s.hasClass("message"):void 0)?this.selectPrev():void 0},l.prototype.updateSearch=function(){var t=this;return clearTimeout(this.timeout),this.select(null),this.timeout=setTimeout(function(){var e;if(t.lastFetch&&!t.lastFetch.isResolved())return void(t.nextRequest=!0);if(e=t.listForQuery(t.preparePost()),e===t.list);else{if(""!==e.query.search||t.listExpanded())return t.list?(e.insertAfter(t.list),t.list.remove()):(t.open(),e.appendTo(t.$menu)),t.list=e,t.autoSelectFirst();if(t.$menu.is(":visible"))return t.close()}},200)},l.prototype.preparePost=function(t){var s,i,n;return s=e.extend({},null!=(i=this.options.baseData)?i:{},null!=t?t:{},{search:this.input.val().replace(/^\s+|\s+$/g,"")}),null==(n=s.exclude)&&(s.exclude=[]),s.exclude=s.exclude.concat(this.input.baseExclude),this.listExpanded()?s.context=this.parent().data("id"):s.exclude=s.exclude.concat(this.input.tokenValues()),s},l.prototype.lastFetch=null,l.prototype.collectionForQuery=function(t){var e,s,i;return null!=(i=this.lastFetch)&&i.abort(),e=JSON.stringify(t),null==this.cache[e]&&(s=new n,s.url=this.url,this.lastFetch=s.fetch({data:t}),this.cache[e]=s),this.cache[e]},l.prototype.listForQuery=function(t){var e,n,l,o=this;return n=this.collectionForQuery(t),l=new i({selector:this,parent:this.parent(),ancestors:function(){var t,s,i,n;for(i=this.stack,n=[],t=0,s=i.length;s>t;t++)e=i[t],n.push(e[0].data("id"));return n}.call(this),collection:n,query:t}),l.render(),n.atLeastOnePageFetched||n.on("fetch",s.once(function(){return o.autoSelectFirst(l),o.nextRequest&&o.updateSearch(),delete o.nextRequest})),l},l.prototype.teardown=function(){return this.$container.remove()},l}()})}).call(this);