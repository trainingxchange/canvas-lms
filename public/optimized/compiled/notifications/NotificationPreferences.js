(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define(["i18n!notification_preferences","jquery","underscore","compiled/userSettings","compiled/notifications/NotificationGroupMappings","jst/profiles/notification_preferences","jst/profiles/notifications/_policy_cell","jquery.disableWhileLoading","jquery.ajaxJSON","compiled/jquery.rails_flash_notifications","jqueryui/tooltip"],function(e,i,n,o,s,r,a){var c;return c=function(){function o(o){var r,a,c,l;for(this.options=o,this.initGrid=t(this.initGrid,this),this.setupEventBindings=t(this.setupEventBindings,this),this.saveNewCellValue=t(this.saveNewCellValue,this),this.policyCellHtml=t(this.policyCellHtml,this),this.buildTable=t(this.buildTable,this),this.findButtonDataForCode=t(this.findButtonDataForCode,this),this.communicationEventGroups=t(this.communicationEventGroups,this),this.hideButtonsExceptCell=t(this.hideButtonsExceptCell,this),this.buildPolicyCellsHtml=t(this.buildPolicyCellsHtml,this),this.cellButtonsHide=t(this.cellButtonsHide,this),this.buttonData=[{code:"immediately",icon:"icon-check",text:e.t("frequencies.immediately","ASAP"),title:e.t("frequencies.title.right_away","Notify me right away")},{code:"daily",icon:"icon-clock",text:e.t("frequencies.daily","Daily"),title:e.t("frequencies.title.daily","Send daily summary")},{code:"weekly",icon:"icon-calendar-month",text:e.t("frequencies.weekly","Weekly"),title:e.t("frequencies.title.weekly","Send weekly summary")},{code:"never",icon:"icon-x",text:e.t("frequencies.never","Never"),title:e.t("frequencies.title.never","Do not send me anything")}],this.limitedButtonData=[n.first(this.buttonData),n.last(this.buttonData)],this.updateUrl=this.options.update_url,this.channels=this.options.channels||[],this.categories=this.options.categories||[],this.policies=this.options.policies||[],l=this.channels,a=0,c=l.length;c>a;a++)r=l[a],r.name=function(){switch(r.type){case"email":return e.t("communication.email.display","Email Address");case"sms":return e.t("communication.sms.display","Cell Number");case"push":return e.t("communication.push.display","Push Notification");case"twitter":return e.t("communication.twitter.display","Twitter");case"facebook":return e.t("communication.facebook.display","Facebook")}}();this.mappings=new s,this.$notificationSaveStatus=i("#notifications_save_status"),this.initGrid()}return o.prototype.cellButtonsShow=function(t,e){var i,n,o,s;return null==e&&(e=!0),t.addClass("show-buttons"),s=t.find(".event-option-selection"),i=t.find(".event-option-buttons"),s.hide(),i.show(),e&&(o=t.find(".frequency:checked"),n=t.find("label[for="+o.attr("id")+"]"))?n.focus():void 0},o.prototype.cellButtonsHide=function(t,e){var i,n;return null==e&&(e=!0),t.removeClass("show-buttons"),n=t.find(".event-option-selection"),i=t.find(".event-option-buttons"),i.hide(),n.show(),e?n.find("a:first").focus():void 0},o.prototype.buildPolicyCellsHtml=function(t){var e,i,o,s;return i=function(){var i,r,a,c;for(a=this.channels,c=[],i=0,r=a.length;r>i;i++)e=a[i],s=n.find(this.policies,function(i){return i.communication_channel_id===e.id&&i.category===t.category}),o="never",s&&(o=s.frequency),c.push(this.policyCellHtml(t,e,o));return c}.call(this),i.join("")},o.prototype.hideButtonsExceptCell=function(t){var e,n,o,s,r,a;for(r=i("#notification-preferences td.comm-event-option.show-buttons"),a=[],o=0,s=r.length;s>o;o++)n=r[o],e=i(n),a.push(e!==t?0===e.find(":focus").length?this.cellButtonsHide(e,!1):void 0:void 0);return a},o.prototype.communicationEventGroups=function(){var t,e,i,o,s,r,a,c,l,u;s=[],u=this.mappings.groups;for(o in u){for(a=u[o],i=[],c=0,l=a.length;l>c;c++)e=a[c],t=n.find(this.categories,function(t){return t.category===e}),t&&(r={title:t.display_name,description:t.category_description,policyCells:this.buildPolicyCellsHtml(t)},t.option&&(r.checkName=t.option.name,r.checkedState=t.option.value,r.checkLabel=t.option.label,r.checkID=t.option.id),i.push(r));i.length>0&&s.push({name:this.mappings.getGroupDisplayName(o),items:i})}return s},o.prototype.findButtonDataForCode=function(t){return n.find(this.buttonData,function(e){return e.code===t})},o.prototype.buildTable=function(){return i("#notification-preferences").append(r({touch:INST.browser.touch,channels:this.channels,eventGroups:this.communicationEventGroups()})),i("#notification-preferences .category-name.show-popover").tooltip({position:{my:"left center",at:"right+20 center",collision:"none none"},tooltipClass:"popover left middle horizontal"}),i("tbody th[scope=row]").css("min-width",i("h3.group-name").width()),this.setupEventBindings(),null},o.prototype.policyCellHtml=function(t,e,i){var o,s;return null==i&&(i="never"),n.each(this.buttonData,function(i){return i.active=!1,i.coordinate="cat_"+t.id+"_ch_"+e.id,i.id=""+i.coordinate+"_"+i.code}),s=this.findButtonDataForCode(i),s.active=!0,o="push"===e.type?this.limitedButtonData:this.buttonData,a({touch:INST.browser.touch,category:t.category,channelId:e.id,selected:s,allButtons:o})},o.prototype.saveNewCellValue=function(t,n){var o,s,r,a;return o=this.findButtonDataForCode(n),t.attr("data-selection",n),t.find("a.change-selection i").attr("class",o.icon),t.find("a.change-selection span.img-text").text(o.text),s=t.attr("data-category"),r=t.attr("data-channelId"),a={category:s,channel_id:r,frequency:n},this.$notificationSaveStatus.disableWhileLoading(i.ajaxJSON(this.updateUrl,"PUT",a,null,function(){return i.flashError(e.t("communication.errors.saving_preferences_failed","Oops! Something broke.  Please try again"))}),this.spinOpts)},o.prototype.setupEventBindings=function(){var t,n=this;return t=i("#notification-preferences"),t.find(".event-option-buttons").buttonset(),INST.browser.touch||(t.find(".notification-prefs-table").on({mouseenter:function(t){return n.cellButtonsShow(i(t.currentTarget),!1)},mouseleave:function(t){return n.cellButtonsHide(i(t.currentTarget),!1)}},".comm-event-option"),t.find(".notification-prefs-table a.change-selection").on("click",function(t){var e;return t.preventDefault(),e=i(t.currentTarget).closest("td"),n.hideButtonsExceptCell(e),n.cellButtonsShow(e,!0)})),t.find(".frequency").on("change",function(t){var e,o,s;return o=i(t.currentTarget),e=o.closest("td"),s=o.attr("data-value"),n.saveNewCellValue(e,s)}),t.find(".mobile-select").on("change",function(t){var e,o,s;return o=i(t.currentTarget),e=i(t.currentTarget).closest("td"),s=o.find("option:selected").val(),n.saveNewCellValue(e,s)}),t.find(".user-pref-check").on("change",function(t){var o,s,r;return o=i(t.currentTarget),s="checked"===o.attr("checked"),r={user:{}},r.user[o.attr("name")]=s,n.$notificationSaveStatus.disableWhileLoading(i.ajaxJSON(n.updateUrl,"PUT",r,null,function(){return i.flashError(e.t("communication.errors.saving_preferences_failed","Oops! Something broke.  Please try again"))}),n.spinOpts)}),null},o.prototype.spinOpts={length:4,radius:5,width:3},o.prototype.initGrid=function(){return this.buildTable(),null},o}()})}).call(this);