(function(){var e=[].slice;define(["ic-ajax","compiled/util/round","compiled/userSettings","../../shared/xhr/fetch_all_pages","../../shared/xhr/parse_link_header","i18n!sr_gradebook","ember","underscore","timezone","compiled/AssignmentDetailsDialog","compiled/AssignmentMuter","compiled/grade_calculator","compiled/gradebook2/OutcomeGradebookGrid","../../shared/components/ic_submission_download_dialog_component"],function(t,n,s,i,o,r,u,a,d,l,c,g,m){var h,p,_,f,b,S;return _=u.get,f=u.set,b=u.setProperties,S=function(){var t,n,s;return t=1<=arguments.length?e.call(arguments,0):[],n=1,s={initialize:function(e,t,n){return n.students={}},addedItem:function(e,t,s,i){var o;return o=i.students[t.user_id]||t.user,null==o.hiddenName&&(o.hiddenName=r.t("student_hidden_name","Student %{position}",{position:n}),n+=1),o.sections||(o.sections=[]),o.sections.push(t.course_section_id),o.role||(o.role=t.role),i.students[o.id]?e:(i.students[o.id]=o,e.pushObject(o),e)},removedItem:function(e,t,s,i){var o;return o=e.findBy("id",t.user_id),o.sections.removeObject(t.course_section_id),0===o.sections.length&&(delete i.students[o.id],e.removeObject(o),n-=1),e}},t.push(s),u.arrayComputed.apply(null,t)},p=_(window,"ENV.GRADEBOOK_OPTIONS.context_url"),h=u.ObjectController.extend({errors:function(){var e,t,n;return u.$("#flash_message_holder li").size()>0?(e=u.$("#flash_message_holder li a").text().trim(),t=u.$("#flash_message_holder li").text().replace(e,"").trim(),n=u.$("<span role='alert'>"+t+"</span>"),u.$(n).appendTo(u.$("#flash_screenreader_holder"))):void 0}.on("init"),contextUrl:p,downloadCsvUrl:""+p+"/gradebook.csv",downloadOutcomeCsvUrl:""+p+"/outcome_rollups.csv",gradingHistoryUrl:""+p+"/gradebook/history",speedGraderUrl:function(){return""+p+"/gradebook/speed_grader?assignment_id="+this.get("selectedAssignment.id")}.property("selectedAssignment"),studentUrl:function(){return""+p+"/grades/"+this.get("selectedStudent.id")}.property("selectedStudent"),showTotalAsPoints:function(){return ENV.GRADEBOOK_OPTIONS.show_total_grade_as_points}.property(),isDraftState:function(){return ENV.GRADEBOOK_OPTIONS.draft_state_enabled},publishToSisEnabled:function(){return ENV.GRADEBOOK_OPTIONS.publish_to_sis_enabled}.property(),publishToSisURL:function(){return ENV.GRADEBOOK_OPTIONS.publish_to_sis_url}.property(),teacherNotes:function(){return ENV.GRADEBOOK_OPTIONS.teacher_notes}.property().volatile(),changeGradebookVersionUrl:function(){return""+_(window,"ENV.GRADEBOOK_OPTIONS.change_gradebook_version_url")}.property(),hideOutcomes:function(){return!_(window,"ENV.GRADEBOOK_OPTIONS.outcome_gradebook_enabled")}.property(),showDownloadSubmissionsButton:function(){return this.get("selectedAssignment.has_submitted_submissions")&&a.intersection(this.get("selectedAssignment.submission_types"),["online_upload","online_text_entry","online_url"])!==[]}.property("selectedAssignment"),hideStudentNames:!1,showConcludedEnrollments:function(){return s.contextGet("show_concluded_enrollments")||!1}.property().volatile(),updateshowConcludedEnrollmentsSetting:function(){var e;return e=this.get("showConcludedEnrollments"),null!=e?s.contextSet("show_concluded_enrollments",e):void 0}.observes("showConcludedEnrollments"),selectedStudent:null,selectedSection:null,selectedAssignment:null,weightingScheme:null,ariaAnnounced:null,actions:{columnUpdated:function(e,t){return this.updateColumnData(e,t)},gradeUpdated:function(e){return this.updateSubmissionsFromExternal(e)},selectItem:function(e,t){return this.announce(e,t)}},announce:function(e,t){var n=this;return u.run.next(function(){var s;return s="student"===e&&n.get("hideStudentNames")?_(t,"hiddenName"):"outcome"===e?_(t,"title"):_(t,"name"),n.set("ariaAnnounced",s)})},hideStudentNamesChanged:function(){return this.set("ariaAnnounced",null)}.observes("hideStudentNames"),setupSubmissionCallback:function(){return u.$.subscribe("submissions_updated",a.bind(this.updateSubmissionsFromExternal,this))}.on("init"),setupAssignmentGroupsChange:function(){return u.$.subscribe("assignment_group_weights_changed",a.bind(this.checkWeightingScheme,this)),this.set("weightingScheme",ENV.GRADEBOOK_OPTIONS.group_weighting_scheme)}.on("init"),willDestroy:function(){return u.$.unsubscribe("submissions_updated"),u.$.unsubscribe("assignment_group_weights_changed"),this._super()},checkWeightingScheme:function(e){var t,n;return n=e.assignmentGroups,t=this.get("assignment_groups"),t.clear(),t.pushObjects(n),this.set("weightingScheme",ENV.GRADEBOOK_OPTIONS.group_weighting_scheme)},updateSubmissionsFromExternal:function(e){var t,n,s,i=this;return n=this.get("students"),s=this.get("submissions"),t=this.get("selectedSubmission"),e.forEach(function(e){var o,r,u;return u=s.findBy("user_id",e.user_id),o=u.submissions.findBy("assignment_id",e.assignment_id),u.submissions.removeObject(o),u.submissions.addObject(e),r=n.findBy("id",e.user_id),i.updateSubmission(e,r),i.calculateStudentGrade(r),t&&t.assignment_id===e.assignment_id&&t.user_id===e.user_id?f(i,"selectedSubmission",e):void 0})},calculate:function(e){return g.calculate(e,this.assignmentGroupsHash(),this.get("weightingScheme"))},calculateStudentGrade:function(e){var t,s,i,o,r,u,a,d,l,c,g,m,h,p;if(e.isLoaded){for(t=this.get("includeUngradedAssignments")?"final":"current",a=function(){var t;t=[];for(i in e)d=e[i],i.match(/^assignment_(?!group)/)&&t.push(d);return t}(),r=this.calculate(a),h=r.group_sums,l=0,g=h.length;g>l;l++)for(s=h[l],f(e,"assignment_group_"+s.group.id,s[t]),p=s[t].submissions,c=0,m=p.length;m>c;c++)u=p[c],f(u.submission,"drop",u.drop);return r=r[t],o=n(r.score/r.possible*100,1),isNaN(o)&&(o=0),b(e,{total_grade:r,total_percent:o})}},calculateAllGrades:function(){var e=this;return this.get("students").forEach(function(t){return e.calculateStudentGrade(t)})}.observes("includeUngradedAssignments","groupsAreWeighted","assignment_groups.@each.group_weight"),sectionSelectDefaultLabel:r.t("all_sections","All Sections"),studentSelectDefaultLabel:r.t("no_student","No Student Selected"),assignmentSelectDefaultLabel:r.t("no_assignment","No Assignment Selected"),outcomeSelectDefaultLabel:r.t("no_outcome","No Outcome Selected"),students:S("enrollments"),studentsHash:function(){var e;return e={},this.get("students").forEach(function(t){return"StudentViewEnrollment"!==t.role?e[t.id]=t:void 0}),e},fetchStudentSubmissions:function(){var e=this;return u.run.once(function(){var t,n;return t=e.get("students").filter(function(e){return _(e,"isLoaded")||_(e,"isLoading")?!1:(f(e,"isLoading",!0),e)}),t.length?(n=t.mapBy("id"),i(ENV.GRADEBOOK_OPTIONS.submissions_url,{records:e.get("submissions"),data:{student_ids:n}})):void 0})}.observes("students.@each").on("init"),showNotesColumn:function(){var e;return e=this.get("teacherNotes"),e?!e.hidden:!1}.property().volatile(),shouldCreateNotes:function(){return!this.get("teacherNotes")&&this.get("showNotesColumn")}.property("teacherNotes","showNotesColumn","custom_columns.@each"),notesURL:function(){var e,t;return this.get("shouldCreateNotes")?ENV.GRADEBOOK_OPTIONS.custom_columns_url:(e=null!=(t=this.get("teacherNotes"))?t.id:void 0,ENV.GRADEBOOK_OPTIONS.custom_column_url.replace(/:id/,e))}.property("shouldCreateNotes","custom_columns.@each"),notesParams:function(){return this.get("shouldCreateNotes")?{"column[title]":r.t("notes","Notes"),"column[position]":1,"column[teacher_notes]":!0}:{"column[hidden]":!this.get("showNotesColumn")}}.property("shouldCreateNotes","showNotesColumn"),notesVerb:function(){return this.get("shouldCreateNotes")?"POST":"PUT"}.property("shouldCreateNotes"),updateOrCreateNotesColumn:function(){return t.request({dataType:"json",type:this.get("notesVerb"),url:this.get("notesURL"),data:this.get("notesParams")}).then(this.boundNotesSuccess)}.observes("showNotesColumn"),bindNotesSuccess:function(){return this.boundNotesSuccess=a.bind(this.onNotesUpdateSuccess,this)}.on("init"),onNotesUpdateSuccess:function(e){var n,s,i;return s=this.get("custom_columns"),i=e.hidden?"removeObject":"unshiftObject",n=s.findBy("id",e.id)||e,s[i](n),e.teacher_notes&&this.set("teacherNotes",e),e.hidden?void 0:t.request({url:ENV.GRADEBOOK_OPTIONS.reorder_custom_columns_url,type:"POST",data:{order:s.mapBy("id")}})},displayPointTotals:function(){return this.get("groupsAreWeighted")?!1:this.get("showTotalAsPoints")}.property("groupsAreWeighted","showTotalAsPoints"),groupsAreWeighted:function(){return"percent"===this.get("weightingScheme")}.property("weightingScheme"),updateShowTotalAs:function(){return this.set("showTotalAsPoints",this.get("displayPointTotals")),t.request({dataType:"json",type:"PUT",url:ENV.GRADEBOOK_OPTIONS.setting_update_url,data:{show_total_grade_as_points:this.get("displayPointTotals")}})}.observes("showTotalAsPoints","groupsAreWeighted"),studentColumnData:{},updateColumnData:function(e,t){var n,s,i;return i=this.get("studentColumnData"),s=i[e.user_id]||u.A(),n=s.findBy("column_id",t),n?n.set("content",e.content):s.push(u.Object.create({column_id:t,content:e.content})),i[e.user_id]=s},fetchColumnData:function(e,n){var s=this;return n||(n=ENV.GRADEBOOK_OPTIONS.custom_column_data_url.replace(/:id/,e.id)),t.raw(n,{dataType:"json"}).then(function(t){var n,i,r,u,a;for(a=t.response,r=0,u=a.length;u>r;r++)n=a[r],s.updateColumnData(n,e.id);return i=o(t.jqXHR),i.next?s.fetchColumnData(e,i.next):b(e,{isLoading:!1,isLoaded:!0})})},dataForStudent:function(){var e;return e=this.get("selectedStudent"),null!=e?this.get("studentColumnData")[e.id]:void 0}.property("selectedStudent","custom_columns.@each.isLoaded"),loadCustomColumnData:function(){var e=this;if(this.get("enrollments.isLoaded"))return this.get("custom_columns").filter(function(e){return _(e,"isLoaded")||_(e,"isLoading")?!1:(f(e,"isLoading",!0),e)}).forEach(function(t){return e.fetchColumnData(t)})}.observes("enrollments.isLoaded","custom_columns.@each"),studentsInSelectedSection:function(){var e,t;return t=this.get("students"),e=this.get("selectedSection"),e?t.filter(function(t){return t.sections.contains(e.id)}):t}.property("students.@each","selectedSection"),submissionsLoaded:function(){var e;return e=this.get("submissions"),e.forEach(function(e){var t;return t=this.get("students").findBy("id",e.user_id),null!=t?(e.submissions.forEach(function(e){return this.updateSubmission(e,t)},this),b(t,{isLoading:!1,isLoaded:!0}),this.calculateStudentGrade(t)):void 0},this)}.observes("submissions.@each"),updateSubmission:function(e,t){return e.submitted_at=d.parse(e.submitted_at),f(t,"assignment_"+e.assignment_id,e)},assignments:u.ArrayProxy.createWithMixins(u.SortableMixin,{content:[],sortProperties:["ag_position","position"]}),processAssignment:function(e,t){var n,s;return n=t.findBy("id",e.assignment_group_id),f(e,"sortable_name",e.name.toLowerCase()),f(e,"ag_position",n.position),f(e,"noPointsPossibleWarning",n.invalid),e.due_at?(s=d.parse(e.due_at),f(e,"due_at",s),f(e,"sortable_date",+s/1e3)):f(e,"sortable_date",Number.MAX_VALUE)},checkForNoPointsWarning:function(e){var t;return t=a.inject(e.assignments,function(e,t){return e+(t.points_possible||0)},0),0===t},checkForInvalidGroups:function(){var e=this;return this.get("assignment_groups").forEach(function(t){return f(t,"invalid",e.checkForNoPointsWarning(t))})}.observes("assignment_groups.@each"),invalidAssignmentGroups:function(){return this.get("assignment_groups").filterProperty("invalid",!0)}.property("assignment_groups.@each.invalid"),showInvalidGroupWarning:function(){return this.get("invalidAssignmentGroups").length>0&&"percent"===this.get("weightingScheme")}.property("invalidAssignmentGroups","weightingScheme"),invalidGroupNames:function(){var e;return e=this.get("invalidAssignmentGroups").map(function(e){return e.name})}.property("invalidAssignmentGroups").readOnly(),invalidGroupsWarningPhrases:function(){return r.t("invalid_group_warning",{one:"Note: Score does not include assignments from the group %{list_of_group_names} because it has no points possible.",other:"Note: Score does not include assignments from the groups %{list_of_group_names} because they have no points possible."},{count:this.get("invalidGroupNames").length,list_of_group_names:this.get("invalidGroupNames").join(" or ")})}.property("invalidGroupNames"),populateAssignments:function(){var e,t,n,s=this;return e=this.get("assignment_groups"),t=a.flatten(e.mapBy("assignments")),n=this.get("assignments"),t.forEach(function(t){var i;if(!n.findBy("id",t.id))return s.processAssignment(t,e),i=s.isDraftState()&&t.published===!1||t.submission_types.contains("not_graded"),i?e.findBy("id",t.assignment_group_id).assignments.removeObject(t):n.addObject(t)})}.observes("assignment_groups","assignment_groups.@each"),includeUngradedAssignments:function(){return s.contextGet("include_ungraded_assignments")||!1}.property().volatile(),showAttendance:function(){return s.contextGet("show_attendance")}.property().volatile(),updateUngradedAssignmentUserSetting:function(){var e;return e=this.get("includeUngradedAssignments"),null!=e?s.contextSet("include_ungraded_assignments",e):void 0}.observes("includeUngradedAssignments"),assignmentGroupsHash:function(){var e;return e={},this.get("assignment_groups").forEach(function(t){return e[t.id]=t}),e},assignmentSortOptions:[{label:r.t("assignment_order_assignment_groups","By Assignment Group and Position"),value:"assignment_group"},{label:r.t("assignment_order_alpha","Alphabetically"),value:"alpha"},{label:r.t("assignment_order_due_date","By Due Date"),value:"due_date"}],assignmentSort:function(e,t){var n,i;return i=s.contextGet("sort_grade_columns_by"),n=this.get("assignmentSortOptions").findBy("value",null!=i?i.sortType:void 0),t?(s.contextSet("sort_grade_columns_by",{sortType:t.value}),t):null!=n?n:this.get("assignmentSortOptions").findBy("value","assignment_group")}.property(),sortAssignments:function(){var e,t;return(e=this.get("assignmentSort"))?(t=function(){switch(e.value){case"assignment_group":case"custom":return["ag_position","position"];case"alpha":return["sortable_name"];case"due_date":return["sortable_date","sortable_name"];default:return["ag_position","position"]}}(),this.get("assignments").set("sortProperties",t)):void 0}.observes("assignmentSort").on("init"),selectedSubmission:function(e,t){var n,s,i;return arguments.length>1?(this.set("selectedStudent",this.get("students").findBy("id",t.user_id)),this.set("selectedAssignment",this.get("assignments").findBy("id",t.assignment_id)),t):null==this.get("selectedStudent")||null==this.get("selectedAssignment")?null:(s=this.get("selectedStudent"),n=this.get("selectedAssignment"),i=_(s,"assignment_"+n.id),i||{user_id:s.id,assignment_id:n.id})}.property("selectedStudent","selectedAssignment"),selectedOutcomeResult:function(){var e,t,n;return null==this.get("selectedStudent")||null==this.get("selectedOutcome")?null:(n=this.get("selectedStudent"),e=this.get("selectedOutcome"),t=this.get("outcome_rollups").find(function(t){return t.user_id===n.id&&t.outcome_id===e.id}),t||{user_id:n.id,outcome_id:e.id})}.property("selectedStudent","selectedOutcome"),outcomeResultIsDefined:function(){return null!=this.get("selectedOutcomeResult").score}.property("selectedOutcomeResult"),showAssignmentPointsWarning:function(){return this.get("selectedAssignment.noPointsPossibleWarning")&&this.get("groupsAreWeighted")}.property("selectedAssignment","groupsAreWeighted"),selectedStudentSections:function(){var e,t,n;return n=this.get("selectedStudent"),t=this.get("sections"),t.isLoaded&&null!=n?(e=n.sections.map(function(e){return t.findBy("id",e).name}),e.join(", ")):null}.property("selectedStudent","sections.isLoaded"),assignmentDetails:function(){var e;return null==this.get("selectedAssignment")?null:e=l.prototype.compute.call(l.prototype,{students:this.studentsHash(),assignment:this.get("selectedAssignment")}).locals}.property("selectedAssignment","students.@each.total_grade"),outcomeDetails:function(){var e,t,n;return null==this.get("selectedOutcome")?null:(t=this.get("outcome_rollups").filterBy("outcome_id",this.get("selectedOutcome").id),n=a.filter(a.pluck(t,"score"),a.isNumber),e={average:m.Math.mean(n),max:m.Math.max(n),min:m.Math.min(n),cnt:m.Math.cnt(n)})}.property("selectedOutcome","outcome_rollups"),assignmentSubmissionTypes:function(){var e,t,n;return n=this.get("selectedAssignment.submission_types"),t=this.get("submissionTypes"),void 0===n||0===n.length?t.none:1===n.length?t[n[0]]:(e=[],n.forEach(function(n){return e.push(t[n])}),e.join(", "))}.property("selectedAssignment"),submissionTypes:{discussion_topic:r.t("discussion_topic","Discussion topic"),online_quiz:r.t("online_quiz","Online quiz"),on_paper:r.t("on_paper","On paper"),none:r.t("none","None"),external_tool:r.t("external_tool","External tool"),online_text_entry:r.t("online_text_entry","Online text entry"),online_url:r.t("online_url","Online URL"),online_upload:r.t("online_upload","Online upload"),media_recording:r.t("media_recordin","Media recording")},assignmentIndex:function(){var e;return e=this.get("selectedAssignment"),e?this.get("assignments").indexOf(e):-1}.property("selectedAssignment","assignmentSort"),studentIndex:function(){var e;return e=this.get("selectedStudent"),e?this.get("studentsInSelectedSection").indexOf(e):-1}.property("selectedStudent","selectedSection"),outcomeIndex:function(){var e;return e=this.get("selectedOutcome"),e?this.get("outcomes").indexOf(e):-1}.property("selectedOutcome"),displayName:function(){return this.get("hideStudentNames")?"hiddenName":"name"}.property("hideStudentNames"),fetchCorrectEnrollments:function(){var e,t;return t=this.get("showConcludedEnrollments")?ENV.GRADEBOOK_OPTIONS.students_url_with_concluded_enrollments:ENV.GRADEBOOK_OPTIONS.students_url,e=this.get("enrollments"),e.clear(),i(t,{records:e})}.observes("showConcludedEnrollments")})})}).call(this);