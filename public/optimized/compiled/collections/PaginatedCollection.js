(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function s(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return s.prototype=r.prototype,t.prototype=new s,t.__super__=r.prototype,t},s=[].slice,n=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};define(["Backbone","underscore"],function(e,l){var i,u,o;return u=function(t){return null==t&&(t=""),t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()},i=function(e){function i(){return this._setStateAfterFetch=t(this._setStateAfterFetch,this),o=i.__super__.constructor.apply(this,arguments)}return r(i,e),i.prototype.nameRegex=/rel="([a-z]+)/,i.prototype.linkRegex=/^<([^>]+)/,i.prototype.pageRegex=/\Wpage=(\d+)/,i.prototype.perPageRegex=/\Wper_page=(\d+)/,i.prototype.initialize=function(){return i.__super__.initialize.apply(this,arguments),this.urls={}},i.prototype.fetch=function(t){var e,r,n,o,a=this;return null==t&&(t={}),t=l.clone(t),this.loadedAll=!1,r="fetching"+u(t.page)+"Page",this[r]=!0,null!=t.page?((null!=(o=this.urls)?o[t.page]:void 0)&&(t.url=this.urls[t.page]),null==t.remove&&(t.remove=!1),t.data=""):null==t.reset&&(t.reset=!0),this.trigger("beforeFetch",this,t),null!=t.page&&this.trigger("beforeFetch:"+t.page,this,t),n=null,t.dataFilter=function(e){return a[r]=!1,a._setStateAfterFetch(n,t),e},e=t.dfd||$.Deferred(),n=i.__super__.fetch.call(this,t).done(function(r,n,l){var i;return a.trigger("fetch",a,r,t),null!=t.page&&a.trigger("fetch:"+t.page,a,r,t),(null!=(i=a.urls)?i.next:void 0)||(a.trigger.apply(a,["fetched:last"].concat(s.call(arguments))),a.loadedAll=!0),a.loadAll&&null!=a.urls.next?setTimeout(function(){return a.fetch({page:"next",dfd:e})}):e.resolve(r,n,l)}),e.abort=n.abort,e.success=e.done,e.error=e.fail,e},i.prototype.canFetch=function(t){return null!=this.urls&&null!=this.urls[t]},i.prototype._setStateAfterFetch=function(t,e){var r,s,l,i,u,o,a,h,p,c,g,f,d,_,m,v;return null==(c=this._urlCache)&&(this._urlCache=[]),g=e.url,h=n.call(this._urlCache,g)<0,h||this._urlCache.push(e.url),r=!this.atLeastOnePageFetched,u=r||("next"===(f=e.page)||"bottom"===f)&&h,o=r||("prev"===(d=e.page)||"top"===d)&&h,l=this.urls,this.urls=this._parsePageLinks(t),u&&null!=this.urls.next?this.urls.bottom=this.urls.next:this.urls.next?this.urls.bottom=l.bottom:delete this.urls.bottom,o&&null!=this.urls.prev?this.urls.top=this.urls.prev:this.urls.prev?this.urls.top=l.top:delete this.urls.top,a=null!=(_=this.urls.first)?_:this.urls.next,null!=a&&(i=parseInt(a.match(this.perPageRegex)[1],10),(null!=(m=(p=null!=(v=this.options)?v:this.options={}).params)?m:p.params={}).per_page=i),this.urls.last&&(s=this.urls.last.match(this.pageRegex))&&(this.totalPages=parseInt(s[1],10)),this.atLeastOnePageFetched=!0},i.prototype._parsePageLinks=function(t){var e,r,s=this;return e=null!=(r=t.getResponseHeader("link"))?r.split(","):void 0,null==e&&(e=[]),l.reduce(e,function(t,e){var r,n;return r=e.match(s.nameRegex)[1],n=e.match(s.linkRegex)[1],t[r]=n,t},{})},i}(e.Collection)})}).call(this);