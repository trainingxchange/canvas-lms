(function(){var t={}.hasOwnProperty,o=function(o,e){function r(){this.constructor=o}for(var u in e)t.call(e,u)&&(o[u]=e[u]);return r.prototype=e.prototype,o.prototype=new r,o.__super__=e.prototype,o},e=function(t,o){return function(){return t.apply(o,arguments)}};define(["jquery","underscore","Backbone","compiled/models/grade_summary/Section","compiled/models/grade_summary/Group","compiled/models/grade_summary/Outcome","compiled/collections/PaginatedCollection","compiled/collections/WrappedCollection","compiled/util/natcompare"],function(t,r,u,n,s,i,c,p,l){var a,d,_,h,m,y,g,f,v;return a=u.Collection,d=function(t){function e(){return y=e.__super__.constructor.apply(this,arguments)}return o(e,t),e.optionProperty("course_id"),e.prototype.model=s,e.prototype.url=function(){return"/api/v1/courses/"+this.course_id+"/outcome_groups"},e}(c),_=function(t){function e(){return g=e.__super__.constructor.apply(this,arguments)}return o(e,t),e.optionProperty("course_id"),e.prototype.url=function(){return"/api/v1/courses/"+this.course_id+"/outcome_group_links?outcome_style=full"},e}(c),m=function(t){function e(){return f=e.__super__.constructor.apply(this,arguments)}return o(e,t),e.optionProperty("course_id"),e.optionProperty("user_id"),e.prototype.key="rollups",e.prototype.url=function(){return"/api/v1/courses/"+this.course_id+"/outcome_rollups?user_ids[]="+this.user_id},e}(p),h=function(u){function s(){return this.processCollections=e(this.processCollections,this),v=s.__super__.constructor.apply(this,arguments)}return o(s,u),s.optionProperty("course_id"),s.optionProperty("user_id"),s.prototype.comparator=l.byGet("path"),s.prototype.initialize=function(){return s.__super__.initialize.apply(this,arguments),this.rawCollections={groups:new d([],{course_id:this.course_id}),links:new _([],{course_id:this.course_id}),results:new m([],{course_id:this.course_id,user_id:this.user_id})},this.outcomeCache=new a},s.prototype.fetch=function(){var o,e,u=this;return o=t.Deferred(),e=r.values(this.rawCollections).map(function(t){return t.loadAll=!0,t.fetch()}),t.when.apply(t,e).done(function(){return u.processCollections(o)}),o},s.prototype.rollups=function(){var t,o;return o=this.rawCollections.results.at(0).get("scores"),t=o.map(function(t){return[t.links.outcome,t]}),r.object(t)},s.prototype.populateGroupOutcomes=function(){var t,o=this;return t=this.rollups(),this.outcomeCache.reset(),this.rawCollections.links.each(function(e){var r,u,n;return r=new i(e.get("outcome")),u=o.rawCollections.groups.get(e.get("outcome_group").id),n=t[r.id],r.set("score",null!=n?n.score:void 0),r.set("count",(null!=n?n.count:void 0)||0),r.group=u,u.get("outcomes").add(r),o.outcomeCache.add(r)})},s.prototype.populateSectionGroups=function(){var t,o=this;return t=new a,this.rawCollections.groups.each(function(e){var r,u,s;if(e.get("outcomes").length)return s=e.get("parent_outcome_group"),u=s?s.id:e.id,(r=t.get(u))||(r=t.add(new n({id:u,path:o.getPath(u)}))),r.get("groups").add(e)}),this.reset(t.models)},s.prototype.processCollections=function(t){return this.populateGroupOutcomes(),this.populateSectionGroups(),t.resolve(this.models)},s.prototype.getPath=function(t){var o,e,r;return o=this.rawCollections.groups.get(t),(e=o.get("parent_outcome_group"))?(r=this.getPath(e.id),(r?r+": ":"")+o.get("title")):""},s}(a)})}).call(this);